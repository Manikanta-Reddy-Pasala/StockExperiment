services:
  # PostgreSQL database
  database:
    image: postgres:15
    container_name: trading_system_db
    environment:
      POSTGRES_DB: trading_system
      POSTGRES_USER: trader
      POSTGRES_PASSWORD: trader_password
      TZ: Asia/Kolkata
    ports:
      - "127.0.0.1:5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d
    restart: unless-stopped
    networks:
      - trading_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U trader -d trading_system"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Trading system application
  trading_system:
    build: .
    container_name: trading_system_app
    depends_on:
      database:
        condition: service_healthy
      dragonfly:
        condition: service_healthy
    environment:
      - TZ=Asia/Kolkata
      - DATABASE_URL=postgresql+psycopg://trader:trader_password@database:5432/trading_system
      - DRAGONFLY_URL=redis://dragonfly:6379/0
      - FLASK_ENV=production
      - PYTHONPATH=/app
      - FYERS_CLIENT_ID=${FYERS_CLIENT_ID:-your_client_id}
      - FYERS_ACCESS_TOKEN=${FYERS_ACCESS_TOKEN:-your_access_token}
      - FYERS_PIN=${FYERS_PIN:-9884}
      - FYERS_CLIENT_ID_LOGIN=${FYERS_CLIENT_ID_LOGIN:-}
      # Data Provider Mode: 'broker' (only broker), 'yfinance' (only yfinance), 'auto' (broker with yfinance fallback)
      # Use 'auto' for paper trading - yfinance is used ONLY for price validation, NOT bulk data
      - DATA_PROVIDER_MODE=${DATA_PROVIDER_MODE:-auto}
      # Enable yfinance for historical data (disabled by default to avoid rate limits)
      - YFINANCE_HISTORICAL_ENABLED=${YFINANCE_HISTORICAL_ENABLED:-false}
      # WebAuthn/Passkey Configuration (update for production domain)
      - WEBAUTHN_RP_ID=${WEBAUTHN_RP_ID:-stock.oneshell.in}
      - WEBAUTHN_RP_NAME=${WEBAUTHN_RP_NAME:-Trading System}
      - WEBAUTHN_RP_ORIGIN=${WEBAUTHN_RP_ORIGIN:-https://stock.oneshell.in}
      # Stock Screening Configuration - Stage 1: Market Data Screening
      - SCREENING_MIN_PRICE_THRESHOLD=${SCREENING_MIN_PRICE_THRESHOLD:-50.0}
      - SCREENING_MIN_DAILY_VOLUME=${SCREENING_MIN_DAILY_VOLUME:-50000}
      - SCREENING_MAX_DAILY_CHANGE_PERCENT=${SCREENING_MAX_DAILY_CHANGE_PERCENT:-25.0}
      - SCREENING_BATCH_SIZE=${SCREENING_BATCH_SIZE:-50}
      - SCREENING_QUOTES_RATE_LIMIT_DELAY=${SCREENING_QUOTES_RATE_LIMIT_DELAY:-0.3}
      - SCREENING_MAX_ATR_PERCENTAGE=${SCREENING_MAX_ATR_PERCENTAGE:-5.0}
      - SCREENING_MIN_AVG_VOLUME_20D=${SCREENING_MIN_AVG_VOLUME_20D:-100000}
      - SCREENING_MAX_BID_ASK_SPREAD=${SCREENING_MAX_BID_ASK_SPREAD:-2.0}
      - SCREENING_MIN_HISTORICAL_VOLATILITY=${SCREENING_MIN_HISTORICAL_VOLATILITY:-10.0}
      - SCREENING_MAX_HISTORICAL_VOLATILITY=${SCREENING_MAX_HISTORICAL_VOLATILITY:-60.0}
      - SCREENING_MAX_BETA=${SCREENING_MAX_BETA:-1.2}
      # Stock Screening Configuration - Stage 2: Business Logic Screening
      - SCREENING_MAX_SECTOR_ALLOCATION=${SCREENING_MAX_SECTOR_ALLOCATION:-30.0}
      - SCREENING_MIN_MARKET_CAP_CRORES=${SCREENING_MIN_MARKET_CAP_CRORES:-500}
      - SCREENING_MAX_FINAL_STOCKS=${SCREENING_MAX_FINAL_STOCKS:-50}
      - SCREENING_MAX_POSITION_SIZE=${SCREENING_MAX_POSITION_SIZE:-5.0}
      - SCREENING_MAX_PE_RATIO=${SCREENING_MAX_PE_RATIO:-50.0}
      - SCREENING_MIN_ROE=${SCREENING_MIN_ROE:-5.0}
      - SCREENING_MAX_DEBT_EQUITY=${SCREENING_MAX_DEBT_EQUITY:-2.0}
      - SCREENING_MIN_DIVIDEND_YIELD=${SCREENING_MIN_DIVIDEND_YIELD:-0.0}
      # Volatility calculation configuration
      - VOLATILITY_MAX_STOCKS=${VOLATILITY_MAX_STOCKS:-500}
      - VOLATILITY_BATCH_SIZE=${VOLATILITY_BATCH_SIZE:-20}
      - VOLATILITY_RATE_LIMIT_DELAY=${VOLATILITY_RATE_LIMIT_DELAY:-0.3}
      - VOLATILITY_MAX_WORKERS=${VOLATILITY_MAX_WORKERS:-3}
      - VOLATILITY_HISTORICAL_DAYS=${VOLATILITY_HISTORICAL_DAYS:-365}
      - VOLATILITY_ATR_PERIOD=${VOLATILITY_ATR_PERIOD:-14}
      - VOLATILITY_BETA_PERIOD=${VOLATILITY_BETA_PERIOD:-252}
      - VOLATILITY_HISTORICAL_VOLATILITY_PERIOD=${VOLATILITY_HISTORICAL_VOLATILITY_PERIOD:-252}
      - VOLATILITY_VOLUME_AVERAGE_PERIOD=${VOLATILITY_VOLUME_AVERAGE_PERIOD:-20}
      - VOLATILITY_FULL_REFRESH=${VOLATILITY_FULL_REFRESH:-false}
    ports:
      - "127.0.0.1:5001:5001"
    volumes:
      - ./logs:/app/src/data/logs
    restart: unless-stopped
    networks:
      - trading_network
    command: python run.py --multi-user

  # Dragonfly for caching and session management
  dragonfly:
    image: docker.dragonflydb.io/dragonflydb/dragonfly
    container_name: trading_system_dragonfly
    environment:
      - TZ=Asia/Kolkata
    ports:
      - "127.0.0.1:6379:6379"
    restart: unless-stopped
    networks:
      - trading_network
    healthcheck:
      test: ["CMD", "redis-cli", "-h", "localhost", "-p", "6379", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Technical Indicators Scheduler for technical analysis and daily stock picks
  technical_scheduler:
    build: .
    container_name: trading_system_technical_scheduler
    depends_on:
      database:
        condition: service_healthy
      dragonfly:
        condition: service_healthy
    environment:
      - TZ=Asia/Kolkata
      - DATABASE_URL=postgresql+psycopg://trader:trader_password@database:5432/trading_system
      - DRAGONFLY_URL=redis://dragonfly:6379/0
      - PYTHONPATH=/app
      - FYERS_CLIENT_ID=${FYERS_CLIENT_ID:-your_client_id}
      - FYERS_ACCESS_TOKEN=${FYERS_ACCESS_TOKEN:-your_access_token}
      - FYERS_PIN=${FYERS_PIN:-9884}
      - FYERS_CLIENT_ID_LOGIN=${FYERS_CLIENT_ID_LOGIN:-}
      # Stock Screening Configuration - Stage 1: Market Data Screening
      - SCREENING_MIN_PRICE_THRESHOLD=${SCREENING_MIN_PRICE_THRESHOLD:-50.0}
      - SCREENING_MIN_DAILY_VOLUME=${SCREENING_MIN_DAILY_VOLUME:-50000}
      - SCREENING_MAX_DAILY_CHANGE_PERCENT=${SCREENING_MAX_DAILY_CHANGE_PERCENT:-25.0}
      - SCREENING_BATCH_SIZE=${SCREENING_BATCH_SIZE:-50}
      - SCREENING_QUOTES_RATE_LIMIT_DELAY=${SCREENING_QUOTES_RATE_LIMIT_DELAY:-0.3}
      - SCREENING_MAX_ATR_PERCENTAGE=${SCREENING_MAX_ATR_PERCENTAGE:-5.0}
      - SCREENING_MIN_AVG_VOLUME_20D=${SCREENING_MIN_AVG_VOLUME_20D:-100000}
      - SCREENING_MAX_BID_ASK_SPREAD=${SCREENING_MAX_BID_ASK_SPREAD:-2.0}
      - SCREENING_MIN_HISTORICAL_VOLATILITY=${SCREENING_MIN_HISTORICAL_VOLATILITY:-10.0}
      - SCREENING_MAX_HISTORICAL_VOLATILITY=${SCREENING_MAX_HISTORICAL_VOLATILITY:-60.0}
      - SCREENING_MAX_BETA=${SCREENING_MAX_BETA:-1.2}
      # Stock Screening Configuration - Stage 2: Business Logic Screening
      - SCREENING_MAX_SECTOR_ALLOCATION=${SCREENING_MAX_SECTOR_ALLOCATION:-30.0}
      - SCREENING_MIN_MARKET_CAP_CRORES=${SCREENING_MIN_MARKET_CAP_CRORES:-500}
      - SCREENING_MAX_FINAL_STOCKS=${SCREENING_MAX_FINAL_STOCKS:-50}
      - SCREENING_MAX_POSITION_SIZE=${SCREENING_MAX_POSITION_SIZE:-5.0}
      - SCREENING_MAX_PE_RATIO=${SCREENING_MAX_PE_RATIO:-50.0}
      - SCREENING_MIN_ROE=${SCREENING_MIN_ROE:-5.0}
      - SCREENING_MAX_DEBT_EQUITY=${SCREENING_MAX_DEBT_EQUITY:-2.0}
      - SCREENING_MIN_DIVIDEND_YIELD=${SCREENING_MIN_DIVIDEND_YIELD:-0.0}
      # Volatility calculation configuration
      - VOLATILITY_MAX_STOCKS=${VOLATILITY_MAX_STOCKS:-500}
      - VOLATILITY_BATCH_SIZE=${VOLATILITY_BATCH_SIZE:-20}
      - VOLATILITY_RATE_LIMIT_DELAY=${VOLATILITY_RATE_LIMIT_DELAY:-0.3}
      - VOLATILITY_MAX_WORKERS=${VOLATILITY_MAX_WORKERS:-3}
      - VOLATILITY_HISTORICAL_DAYS=${VOLATILITY_HISTORICAL_DAYS:-365}
      - VOLATILITY_ATR_PERIOD=${VOLATILITY_ATR_PERIOD:-14}
      - VOLATILITY_BETA_PERIOD=${VOLATILITY_BETA_PERIOD:-252}
      - VOLATILITY_HISTORICAL_VOLATILITY_PERIOD=${VOLATILITY_HISTORICAL_VOLATILITY_PERIOD:-252}
      - VOLATILITY_VOLUME_AVERAGE_PERIOD=${VOLATILITY_VOLUME_AVERAGE_PERIOD:-20}
      - VOLATILITY_FULL_REFRESH=${VOLATILITY_FULL_REFRESH:-false}
    volumes:
      - ./logs:/app/logs
    restart: unless-stopped
    networks:
      - trading_network
    command: python scheduler.py
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import os; os.kill(1, 0)' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Data Pipeline Scheduler for data updates and calculations
  data_scheduler:
    build: .
    container_name: trading_system_data_scheduler
    depends_on:
      database:
        condition: service_healthy
      dragonfly:
        condition: service_healthy
    environment:
      - TZ=Asia/Kolkata
      - DATABASE_URL=postgresql+psycopg://trader:trader_password@database:5432/trading_system
      - DRAGONFLY_URL=redis://dragonfly:6379/0
      - PYTHONPATH=/app
      - FYERS_CLIENT_ID=${FYERS_CLIENT_ID:-your_client_id}
      - FYERS_ACCESS_TOKEN=${FYERS_ACCESS_TOKEN:-your_access_token}
      - FYERS_PIN=${FYERS_PIN:-9884}
      - FYERS_CLIENT_ID_LOGIN=${FYERS_CLIENT_ID_LOGIN:-}
      # Stock Screening Configuration - Stage 1: Market Data Screening
      - SCREENING_MIN_PRICE_THRESHOLD=${SCREENING_MIN_PRICE_THRESHOLD:-50.0}
      - SCREENING_MIN_DAILY_VOLUME=${SCREENING_MIN_DAILY_VOLUME:-50000}
      - SCREENING_MAX_DAILY_CHANGE_PERCENT=${SCREENING_MAX_DAILY_CHANGE_PERCENT:-25.0}
      - SCREENING_BATCH_SIZE=${SCREENING_BATCH_SIZE:-50}
      - SCREENING_QUOTES_RATE_LIMIT_DELAY=${SCREENING_QUOTES_RATE_LIMIT_DELAY:-0.3}
      - SCREENING_MAX_ATR_PERCENTAGE=${SCREENING_MAX_ATR_PERCENTAGE:-5.0}
      - SCREENING_MIN_AVG_VOLUME_20D=${SCREENING_MIN_AVG_VOLUME_20D:-100000}
      - SCREENING_MAX_BID_ASK_SPREAD=${SCREENING_MAX_BID_ASK_SPREAD:-2.0}
      - SCREENING_MIN_HISTORICAL_VOLATILITY=${SCREENING_MIN_HISTORICAL_VOLATILITY:-10.0}
      - SCREENING_MAX_HISTORICAL_VOLATILITY=${SCREENING_MAX_HISTORICAL_VOLATILITY:-60.0}
      - SCREENING_MAX_BETA=${SCREENING_MAX_BETA:-1.2}
      # Stock Screening Configuration - Stage 2: Business Logic Screening
      - SCREENING_MAX_SECTOR_ALLOCATION=${SCREENING_MAX_SECTOR_ALLOCATION:-30.0}
      - SCREENING_MIN_MARKET_CAP_CRORES=${SCREENING_MIN_MARKET_CAP_CRORES:-500}
      - SCREENING_MAX_FINAL_STOCKS=${SCREENING_MAX_FINAL_STOCKS:-50}
      - SCREENING_MAX_POSITION_SIZE=${SCREENING_MAX_POSITION_SIZE:-5.0}
      - SCREENING_MAX_PE_RATIO=${SCREENING_MAX_PE_RATIO:-50.0}
      - SCREENING_MIN_ROE=${SCREENING_MIN_ROE:-5.0}
      - SCREENING_MAX_DEBT_EQUITY=${SCREENING_MAX_DEBT_EQUITY:-2.0}
      - SCREENING_MIN_DIVIDEND_YIELD=${SCREENING_MIN_DIVIDEND_YIELD:-0.0}
      # Volatility calculation configuration
      - VOLATILITY_MAX_STOCKS=${VOLATILITY_MAX_STOCKS:-500}
      - VOLATILITY_BATCH_SIZE=${VOLATILITY_BATCH_SIZE:-20}
      - VOLATILITY_RATE_LIMIT_DELAY=${VOLATILITY_RATE_LIMIT_DELAY:-0.3}
      - VOLATILITY_MAX_WORKERS=${VOLATILITY_MAX_WORKERS:-3}
      - VOLATILITY_HISTORICAL_DAYS=${VOLATILITY_HISTORICAL_DAYS:-365}
      - VOLATILITY_ATR_PERIOD=${VOLATILITY_ATR_PERIOD:-14}
      - VOLATILITY_BETA_PERIOD=${VOLATILITY_BETA_PERIOD:-252}
      - VOLATILITY_HISTORICAL_VOLATILITY_PERIOD=${VOLATILITY_HISTORICAL_VOLATILITY_PERIOD:-252}
      - VOLATILITY_VOLUME_AVERAGE_PERIOD=${VOLATILITY_VOLUME_AVERAGE_PERIOD:-20}
      - VOLATILITY_FULL_REFRESH=${VOLATILITY_FULL_REFRESH:-false}
    volumes:
      - ./logs:/app/logs
      - ./exports:/app/exports
    restart: unless-stopped
    networks:
      - trading_network
    command: python data_scheduler.py
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import os; os.kill(1, 0)' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  postgres_data:

networks:
  trading_network:
    driver: bridge