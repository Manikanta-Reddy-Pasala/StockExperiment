{% extends "base.html" %}

{% block title %}Simulator Broker{% endblock %}

{% block content %}
<div class="row g-4">
    <div class="col-12">
        <div class="card hover-lift animate-fade-in-up">
            <div class="card-header bg-gradient-primary text-white">
                <h5 class="card-title mb-0 text-white">
                    <i class="bi bi-cpu me-2"></i>Simulator Broker Configuration
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Simulator Broker Card -->
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100 broker-card">
                            <div class="card-header bg-light">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="card-title mb-0">
                                        <i class="bi bi-cpu text-primary me-2"></i>Simulator
                                    </h6>
                                    <span class="badge bg-success" id="simulator-status">Connected</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <small class="text-muted">Mode</small>
                                        <div class="fw-bold" id="simulator-mode">Simulation</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">API Version</small>
                                        <div class="fw-bold">v1.0</div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <small class="text-muted">Virtual Balance</small>
                                        <div class="fw-bold text-truncate" id="simulator-balance">
                                            <i class="bi bi-currency-rupee text-success"></i> ₹1,00,000
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Last Updated</small>
                                        <div class="fw-bold" id="simulator-last-updated">-</div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <small class="text-muted">Connection Status</small>
                                    <div class="d-flex align-items-center">
                                        <div class="spinner-border spinner-border-sm text-success me-2" role="status" id="simulator-spinner" style="display: none;">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <span class="badge bg-success" id="simulator-connection-status">Connected</span>
                                    </div>
                                </div>

                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-primary btn-sm" id="test-simulator-connection">
                                        <i class="bi bi-wifi"></i> Test Connection
                                    </button>
                                    <button class="btn btn-outline-info btn-sm" id="reset-simulator">
                                        <i class="bi bi-arrow-clockwise"></i> Reset Simulator
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Simulator Statistics -->
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100 broker-stats-card">
                            <div class="card-header bg-light">
                                <h6 class="card-title mb-0">
                                    <i class="bi bi-graph-up me-2"></i>Simulator Statistics
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-6 mb-3">
                                        <div class="border-end">
                                            <h4 class="text-primary mb-1 broker-stats-number" id="total-orders">0</h4>
                                            <small class="text-muted">Total Orders</small>
                                        </div>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <h4 class="text-success mb-1 broker-stats-number" id="successful-orders">0</h4>
                                        <small class="text-muted">Successful</small>
                                    </div>
                                    <div class="col-6">
                                        <div class="border-end">
                                            <h4 class="text-warning mb-1 broker-stats-number" id="pending-orders">0</h4>
                                            <small class="text-muted">Pending</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <h4 class="text-danger mb-1 broker-stats-number" id="failed-orders">0</h4>
                                        <small class="text-muted">Failed</small>
                                    </div>
                                </div>
                                
                                <hr>
                                
                                <div class="mb-2">
                                    <small class="text-muted">Last Order</small>
                                    <div class="fw-bold" id="last-order-time">-</div>
                                </div>
                                
                                <div class="mb-2">
                                    <small class="text-muted">API Response Time</small>
                                    <div class="fw-bold" id="api-response-time">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Simulator Configuration Section -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card broker-config-section">
                            <div class="card-header bg-light">
                                <h6 class="card-title mb-0">
                                    <i class="bi bi-gear me-2"></i>Simulator Configuration
                                </h6>
                            </div>
                            <div class="card-body">
                                <!-- Simulator Info Alert -->
                                <div class="alert alert-success" role="alert">
                                    <i class="bi bi-check-circle me-2"></i>
                                    <strong>Simulator Mode Active!</strong> 
                                    You are using the simulator mode. All trades will be simulated with virtual money. 
                                    No real money will be involved.
                                </div>
                                
                                <!-- Simulator Settings -->
                                <div class="mb-4">
                                    <form id="simulator-config-form">
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label for="simulator-initial-balance" class="form-label">
                                                    <i class="bi bi-currency-rupee me-1"></i>Initial Balance
                                                </label>
                                                <input type="number" class="form-control" id="simulator-initial-balance" 
                                                       value="100000" min="10000" max="1000000" step="1000">
                                                <div class="form-text">Starting virtual balance for simulation</div>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label for="simulator-market-delay" class="form-label">
                                                    <i class="bi bi-clock me-1"></i>Market Data Delay (ms)
                                                </label>
                                                <input type="number" class="form-control" id="simulator-market-delay" 
                                                       value="100" min="0" max="5000" step="50">
                                                <div class="form-text">Simulated network delay for realistic testing</div>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label for="simulator-success-rate" class="form-label">
                                                    <i class="bi bi-percent me-1"></i>Order Success Rate
                                                </label>
                                                <input type="number" class="form-control" id="simulator-success-rate" 
                                                       value="95" min="0" max="100" step="1">
                                                <div class="form-text">Percentage of orders that succeed</div>
                                            </div>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <button type="button" class="btn btn-primary" id="save-simulator-config">
                                                <i class="bi bi-save me-2"></i> Save Configuration
                                            </button>
                                            <button type="button" class="btn btn-warning" id="reset-simulator-data">
                                                <i class="bi bi-arrow-clockwise me-2"></i> Reset All Data
                                            </button>
                                        </div>
                                    </form>
                                </div>

                                <!-- Simulator Features -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Simulator Features:</h6>
                                        <ul class="list-unstyled">
                                            <li><i class="bi bi-check-circle text-success me-2"></i>Virtual Trading Environment</li>
                                            <li><i class="bi bi-check-circle text-success me-2"></i>Real-time Market Data Simulation</li>
                                            <li><i class="bi bi-check-circle text-success me-2"></i>Order Management Testing</li>
                                            <li><i class="bi bi-check-circle text-success me-2"></i>Portfolio Tracking</li>
                                            <li><i class="bi bi-check-circle text-success me-2"></i>Risk-free Strategy Testing</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Supported Features:</h6>
                                        <ul class="list-unstyled">
                                            <li><i class="bi bi-building me-2"></i>NSE & BSE Market Data</li>
                                            <li><i class="bi bi-building me-2"></i>Equity & F&O Trading</li>
                                            <li><i class="bi bi-building me-2"></i>Real-time Quotes</li>
                                            <li><i class="bi bi-building me-2"></i>Historical Data</li>
                                            <li><i class="bi bi-building me-2"></i>Order Book & Trade Book</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Notification function to replace alert popups
    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Add to page
        document.body.appendChild(notification);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }
    
    // Fetch Simulator broker information
    async function fetchSimulatorInfo() {
        try {
            const response = await fetch('/api/brokers/simulator', {
                credentials: 'same-origin'
            });
            
            // Check if response is a redirect (authentication required)
            if (response.redirected || response.status === 302) {
                console.log('Authentication required - user needs to login');
                return;
            }
            
            // Check if response is not ok
            if (!response.ok) {
                console.log('Response not ok:', response.status);
                try {
                    const errorData = await response.json();
                    console.error('API Error:', errorData);
                } catch (e) {
                    console.error('Network Error:', response.statusText);
                }
                return;
            }
            
            const data = await response.json();
            
            if (data.success) {
                // Update Simulator information
                document.getElementById('simulator-mode').textContent = 'Simulation';
                document.getElementById('simulator-balance').innerHTML = 
                    '<i class="bi bi-currency-rupee text-success"></i> ₹1,00,000';
                document.getElementById('simulator-last-updated').textContent = new Date().toLocaleString();
                
                // Simulator is always connected
                document.getElementById('simulator-connection-status').textContent = 'Connected';
                document.getElementById('simulator-connection-status').className = 'badge bg-success';
                document.getElementById('simulator-status').textContent = 'Connected';
                document.getElementById('simulator-status').className = 'badge bg-success';
                
                // Update statistics
                document.getElementById('total-orders').textContent = data.stats?.total_orders || 0;
                document.getElementById('successful-orders').textContent = data.stats?.successful_orders || 0;
                document.getElementById('pending-orders').textContent = data.stats?.pending_orders || 0;
                document.getElementById('failed-orders').textContent = data.stats?.failed_orders || 0;
                document.getElementById('last-order-time').textContent = data.stats?.last_order_time || '-';
                document.getElementById('api-response-time').textContent = data.stats?.api_response_time || '-';
                
            } else {
                console.error('API returned success=false:', data);
            }
        } catch (error) {
            console.error('Error fetching Simulator broker info:', error);
            // Show error state
            document.getElementById('simulator-status').textContent = 'Error';
            document.getElementById('simulator-status').className = 'badge bg-danger';
        }
    }
    
    // Test Simulator connection
    document.getElementById('test-simulator-connection').addEventListener('click', async function() {
        const spinner = document.getElementById('simulator-spinner');
        const status = document.getElementById('simulator-connection-status');
        
        spinner.style.display = 'inline-block';
        status.textContent = 'Testing...';
        status.className = 'badge bg-warning';
        
        try {
            // Simulate API call delay
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            status.textContent = 'Connected';
            status.className = 'badge bg-success';
            document.getElementById('simulator-status').textContent = 'Connected';
            document.getElementById('simulator-status').className = 'badge bg-success';
            
            showNotification('Simulator connection test successful!', 'success');
            
        } catch (error) {
            status.textContent = 'Connection Failed';
            status.className = 'badge bg-danger';
        } finally {
            spinner.style.display = 'none';
        }
    });
    
    // Reset Simulator
    document.getElementById('reset-simulator').addEventListener('click', async function() {
        if (confirm('Are you sure you want to reset the simulator? This will clear all virtual trading data.')) {
            try {
                // Simulate reset operation
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                showNotification('Simulator has been reset successfully!', 'success');
                fetchSimulatorInfo(); // Refresh the data
                
            } catch (error) {
                showNotification('Failed to reset simulator: ' + error.message, 'error');
            }
        }
    });
    
    // Save Simulator configuration
    document.getElementById('save-simulator-config').addEventListener('click', async function() {
        const initialBalance = document.getElementById('simulator-initial-balance').value;
        const marketDelay = document.getElementById('simulator-market-delay').value;
        const successRate = document.getElementById('simulator-success-rate').value;
        
        try {
            // Simulate saving configuration
            await new Promise(resolve => setTimeout(resolve, 500));
            
            showNotification('Simulator configuration saved successfully!', 'success');
            
        } catch (error) {
            showNotification('Failed to save configuration: ' + error.message, 'error');
        }
    });
    
    // Reset Simulator data
    document.getElementById('reset-simulator-data').addEventListener('click', async function() {
        if (confirm('Are you sure you want to reset all simulator data? This action cannot be undone.')) {
            try {
                // Simulate reset operation
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                showNotification('All simulator data has been reset!', 'success');
                fetchSimulatorInfo(); // Refresh the data
                
            } catch (error) {
                showNotification('Failed to reset simulator data: ' + error.message, 'error');
            }
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        fetchSimulatorInfo();
        
        // Refresh data every 30 seconds
        setInterval(function() {
            // Only refresh if the page is visible to avoid unnecessary API calls
            if (!document.hidden) {
                fetchSimulatorInfo();
            }
        }, 30000);
    });
</script>
{% endblock %}
