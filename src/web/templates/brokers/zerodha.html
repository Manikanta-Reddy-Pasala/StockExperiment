{% extends "base.html" %}

{% block title %}Zerodha Broker{% endblock %}

{% block content %}
<div class="row g-4">
    <div class="col-12">
        <div class="card hover-lift animate-fade-in-up">
            <div class="card-header bg-gradient-primary text-white">
                <h5 class="card-title mb-0 text-white">
                    <i class="bi bi-building me-2"></i>Zerodha Broker Configuration
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Zerodha Broker Card -->
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100 broker-card">
                            <div class="card-header bg-light">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="card-title mb-0">
                                        <i class="bi bi-building text-primary me-2"></i>Zerodha
                                    </h6>
                                    <span class="badge bg-secondary" id="zerodha-status">Not Connected</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <small class="text-muted">API Key</small>
                                        <div class="fw-bold" id="zerodha-api-key">Loading...</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">API Version</small>
                                        <div class="fw-bold">v3</div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <small class="text-muted">Access Token</small>
                                        <div class="fw-bold text-truncate" id="zerodha-token-status">
                                            <i class="bi bi-x-circle text-danger"></i> Not configured
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Last Updated</small>
                                        <div class="fw-bold" id="zerodha-last-updated">-</div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <small class="text-muted">Connection Status</small>
                                    <div class="d-flex align-items-center">
                                        <div class="spinner-border spinner-border-sm text-success me-2" role="status" id="zerodha-spinner" style="display: none;">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <span class="badge bg-secondary" id="zerodha-connection-status">Not Connected</span>
                                    </div>
                                </div>

                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-primary btn-sm" id="test-zerodha-connection">
                                        <i class="bi bi-wifi"></i> Test Connection
                                    </button>
                                    <button class="btn btn-outline-info btn-sm" id="zerodha-login">
                                        <i class="bi bi-box-arrow-in-right"></i> Login to Zerodha
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Broker Statistics -->
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100 broker-stats-card">
                            <div class="card-header bg-light">
                                <h6 class="card-title mb-0">
                                    <i class="bi bi-graph-up me-2"></i>Zerodha Statistics
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-6 mb-3">
                                        <div class="border-end">
                                            <h4 class="text-primary mb-1 broker-stats-number" id="total-orders">0</h4>
                                            <small class="text-muted">Total Orders</small>
                                        </div>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <h4 class="text-success mb-1 broker-stats-number" id="successful-orders">0</h4>
                                        <small class="text-muted">Successful</small>
                                    </div>
                                    <div class="col-6">
                                        <div class="border-end">
                                            <h4 class="text-warning mb-1 broker-stats-number" id="pending-orders">0</h4>
                                            <small class="text-muted">Pending</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <h4 class="text-danger mb-1 broker-stats-number" id="failed-orders">0</h4>
                                        <small class="text-muted">Failed</small>
                                    </div>
                                </div>
                                
                                <hr>
                                
                                <div class="mb-2">
                                    <small class="text-muted">Last Order</small>
                                    <div class="fw-bold" id="last-order-time">-</div>
                                </div>
                                
                                <div class="mb-2">
                                    <small class="text-muted">API Response Time</small>
                                    <div class="fw-bold" id="api-response-time">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Zerodha Configuration Section -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card broker-config-section">
                            <div class="card-header bg-light">
                                <h6 class="card-title mb-0">
                                    <i class="bi bi-gear me-2"></i>Zerodha Configuration
                                </h6>
                            </div>
                            <div class="card-body">
                                <!-- Coming Soon Alert -->
                                <div class="alert alert-info" role="alert">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <strong>Zerodha Integration Coming Soon!</strong> 
                                    We're working on integrating Zerodha Kite Connect API. 
                                    For now, please use FYERS or Simulator mode.
                                </div>
                                
                                <!-- Zerodha Configuration Form (Disabled) -->
                                <div class="mb-4">
                                    <form id="zerodha-config-form">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="zerodha-api-key" class="form-label">
                                                    <i class="bi bi-key me-1"></i>API Key
                                                </label>
                                                <input type="text" class="form-control" id="zerodha-api-key" 
                                                       placeholder="Enter your Zerodha API Key" disabled>
                                                <div class="form-text">Your Zerodha API Key from Kite Connect</div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="zerodha-api-secret" class="form-label">
                                                    <i class="bi bi-shield-lock me-1"></i>API Secret
                                                </label>
                                                <input type="password" class="form-control" id="zerodha-api-secret" 
                                                       placeholder="Enter your Zerodha API Secret" disabled>
                                                <div class="form-text">Your Zerodha API Secret from Kite Connect</div>
                                            </div>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <button type="button" class="btn btn-primary" id="save-zerodha-config" disabled>
                                                <i class="bi bi-save me-2"></i> Save Configuration
                                            </button>
                                            <small class="text-muted">Configuration will be available soon</small>
                                        </div>
                                    </form>
                                </div>

                                <!-- Zerodha Features Preview -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Planned Features:</h6>
                                        <ul class="list-unstyled">
                                            <li><i class="bi bi-check-circle text-success me-2"></i>Kite Connect API Integration</li>
                                            <li><i class="bi bi-check-circle text-success me-2"></i>Real-time Market Data</li>
                                            <li><i class="bi bi-check-circle text-success me-2"></i>Order Management</li>
                                            <li><i class="bi bi-check-circle text-success me-2"></i>Portfolio Tracking</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Supported Exchanges:</h6>
                                        <ul class="list-unstyled">
                                            <li><i class="bi bi-building me-2"></i>NSE (National Stock Exchange)</li>
                                            <li><i class="bi bi-building me-2"></i>BSE (Bombay Stock Exchange)</li>
                                            <li><i class="bi bi-building me-2"></i>NFO (NSE F&O)</li>
                                            <li><i class="bi bi-building me-2"></i>CDS (Currency Derivatives)</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Notification function to replace alert popups
    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Add to page
        document.body.appendChild(notification);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }
    
    // Fetch Zerodha broker information
    async function fetchZerodhaInfo() {
        try {
            const response = await fetch('/api/brokers/zerodha', {
                credentials: 'same-origin'
            });
            
            // Check if response is a redirect (authentication required)
            if (response.redirected || response.status === 302) {
                console.log('Authentication required - user needs to login');
                return;
            }
            
            // Check if response is not ok
            if (!response.ok) {
                console.log('Response not ok:', response.status);
                try {
                    const errorData = await response.json();
                    console.error('API Error:', errorData);
                } catch (e) {
                    console.error('Network Error:', response.statusText);
                }
                return;
            }
            
            const data = await response.json();
            
            if (data.success) {
                // Update Zerodha information from database
                document.getElementById('zerodha-api-key').textContent = data.api_key || 'Not configured';
                document.getElementById('zerodha-token-status').innerHTML = 
                    data.access_token ? '<i class="bi bi-check-circle text-success"></i> Active' : 
                    '<i class="bi bi-x-circle text-danger"></i> Not configured';
                document.getElementById('zerodha-last-updated').textContent = data.last_updated || '-';
                
                // Update connection status from database
                const connectionStatus = data.connection_status || 'unknown';
                const isConnected = data.is_connected || false;
                
                document.getElementById('zerodha-connection-status').textContent = connectionStatus.charAt(0).toUpperCase() + connectionStatus.slice(1);
                document.getElementById('zerodha-connection-status').className = 
                    isConnected ? 'badge bg-success' : 'badge bg-secondary';
                document.getElementById('zerodha-status').textContent = connectionStatus.charAt(0).toUpperCase() + connectionStatus.slice(1);
                document.getElementById('zerodha-status').className = 
                    isConnected ? 'badge bg-success' : 'badge bg-secondary';
                
                // Update last connection test time
                if (data.last_connection_test && data.last_connection_test !== '-') {
                    document.getElementById('zerodha-last-updated').textContent = data.last_connection_test;
                }
                
                // Update statistics
                document.getElementById('total-orders').textContent = data.stats?.total_orders || 0;
                document.getElementById('successful-orders').textContent = data.stats?.successful_orders || 0;
                document.getElementById('pending-orders').textContent = data.stats?.pending_orders || 0;
                document.getElementById('failed-orders').textContent = data.stats?.failed_orders || 0;
                document.getElementById('last-order-time').textContent = data.stats?.last_order_time || '-';
                document.getElementById('api-response-time').textContent = data.stats?.api_response_time || '-';
                
                // Update form fields from database
                document.getElementById('zerodha-api-key').value = data.api_key || '';
                document.getElementById('zerodha-api-secret').value = data.api_secret ? '••••••••••••••••' : '';
                
                // Show error message if there's one
                if (data.error_message) {
                    console.warn('Zerodha connection error:', data.error_message);
                }
            } else {
                console.error('API returned success=false:', data);
            }
        } catch (error) {
            console.error('Error fetching Zerodha broker info:', error);
            // Show error state
            document.getElementById('zerodha-status').textContent = 'Error';
            document.getElementById('zerodha-status').className = 'badge bg-danger';
        }
    }
    
    // Test Zerodha connection
    document.getElementById('test-zerodha-connection').addEventListener('click', async function() {
        const spinner = document.getElementById('zerodha-spinner');
        const status = document.getElementById('zerodha-connection-status');
        
        spinner.style.display = 'inline-block';
        status.textContent = 'Testing...';
        status.className = 'badge bg-warning';
        
        try {
            // For now, just simulate the test since Zerodha integration is not ready
            await new Promise(resolve => setTimeout(resolve, 2000)); // Simulate API call
            
            status.textContent = 'Not Implemented';
            status.className = 'badge bg-secondary';
            document.getElementById('zerodha-status').textContent = 'Not Implemented';
            document.getElementById('zerodha-status').className = 'badge bg-secondary';
            
            showNotification('Zerodha integration is not yet implemented. Please use FYERS or Simulator.', 'info');
            
        } catch (error) {
            status.textContent = 'Connection Failed';
            status.className = 'badge bg-danger';
        } finally {
            spinner.style.display = 'none';
        }
    });
    
    // Zerodha login
    document.getElementById('zerodha-login').addEventListener('click', async function() {
        showNotification('Zerodha login will be available soon. Please use FYERS or Simulator for now.', 'info');
    });
    
    // Save Zerodha configuration (disabled for now)
    document.getElementById('save-zerodha-config').addEventListener('click', async function() {
        showNotification('Zerodha configuration is not yet available. Please use FYERS or Simulator.', 'info');
    });

    document.addEventListener('DOMContentLoaded', function() {
        fetchZerodhaInfo();
        
        // Refresh data every 30 seconds
        setInterval(function() {
            // Only refresh if the page is visible to avoid unnecessary API calls
            if (!document.hidden) {
                fetchZerodhaInfo();
            }
        }, 30000);
    });
</script>
{% endblock %}
