{% extends "base.html" %}

{% block title %}Machine Learning{% endblock %}

{% block content %}


<!-- ML Dashboard Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card hover-lift animate-fade-in-up">
            <div class="card-header bg-gradient-primary text-white">
                <h5 class="card-title mb-0 text-white">
                    <i class="bi bi-robot me-2"></i>Machine Learning Dashboard
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-4">
                    <div class="col-lg-4 col-md-6">
                        <div class="text-center">
                            <h3 class="text-primary mb-2" id="trained-models-count">
                                <span class="spinner-border spinner-border-sm me-2"></span>Loading...
                            </h3>
                            <p class="text-muted mb-0">Trained Stocks</p>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-6">
                        <div class="text-center">
                            <h3 class="text-success mb-2" id="training-success-rate">
                                <span class="spinner-border spinner-border-sm me-2"></span>Loading...
                            </h3>
                            <p class="text-muted mb-0">Success Rate</p>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-6">
                        <div class="text-center">
                            <h3 class="text-info mb-2" id="last-updated">
                                <span class="spinner-border spinner-border-sm me-2"></span>Loading...
                            </h3>
                            <p class="text-muted mb-0">Last Updated</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Left Column: Train Stock Form and Trained Stocks -->
    <div class="col-lg-6">
        <!-- Train Stock Form -->
        <div class="card hover-lift animate-fade-in-up" style="animation-delay: 0.2s;">
            <div class="card-header bg-gradient-success text-white">
                <h5 class="card-title mb-0 text-white">
                    <i class="bi bi-gear-fill me-2"></i>Train Stock
                </h5>
            </div>
            <div class="card-body">
                <form id="training-form">
                    <div class="mb-3">
                        <label for="stock-symbol" class="form-label">Stock Symbol</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" id="stock-symbol" placeholder="e.g., NSE:RELIANCE-EQ" required>
                            <button class="btn btn-outline-secondary" type="button" id="search-symbol-btn">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                        <div class="form-text">Enter the full exchange:symbol format</div>
                    </div>


                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="start-date" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="start-date" required>
                                <div class="form-text">Training data start date</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="end-date" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="end-date" required>
                                <div class="form-text">Training data end date</div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="alert alert-info">
                            <i class="bi bi-cpu-fill me-2"></i>
                            <strong>Enhanced Ensemble Model:</strong> Random Forest + XGBoost + LSTM
                            <br>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="use-technical-indicators" checked>
                            <label class="form-check-label" for="use-technical-indicators">
                                Include Enhanced Technical Indicators
                                <small class="text-muted">(20+ normalized features: RSI, MACD, Moving Averages, Volume Patterns, Price Ratios)</small>
                            </label>
                        </div>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-play-circle me-2"></i>Start Training
                        </button>
                    </div>
                </form>

                <!-- Training Progress -->
                <div id="training-progress" class="mt-4" style="display: none;">
                    <h6>Training Progress</h6>
                    <div class="progress mb-2">
                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                             id="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="d-flex justify-content-between">
                        <small class="text-muted" id="progress-status">Starting training...</small>
                        <small class="text-muted" id="progress-percent">0%</small>
                    </div>
                </div>

                <!-- Training Results & Backtesting -->
                <div id="training-results" class="mt-4" style="display: none;">
                    <div class="alert alert-success">
                        <h6 class="alert-heading">
                            <i class="bi bi-check-circle me-2"></i>Training Completed Successfully
                        </h6>
                        <p class="mb-2">
                            <strong>Symbol:</strong> <span id="trained-symbol">-</span><br>
                            <strong>Models:</strong> <span id="trained-models">-</span><br>
                            <strong>Training Period:</strong> <span id="training-period">-</span>
                        </p>

                        <!-- Automatic Backtesting Results -->
                        <div id="auto-backtest-results" style="display: none;">
                            <hr class="my-3">
                            <h6 class="mb-3">
                                <i class="bi bi-graph-up me-2"></i>Automatic Backtesting Results
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h5 class="mb-1" id="auto-trust-score">-</h5>
                                        <small class="text-muted">Trust Score</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h5 class="mb-1" id="auto-signal-accuracy">-</h5>
                                        <small class="text-muted">Signal Accuracy</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h5 class="mb-1" id="auto-best-model">-</h5>
                                        <small class="text-muted">Best Model</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h5 class="mb-1" id="auto-test-period">-</h5>
                                        <small class="text-muted">Test Period</small>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <strong>Recommendation:</strong> <span id="auto-recommendation">-</span>
                            </div>
                        </div>

                        <div class="mt-3">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="hideTrainingResults()">
                                <i class="bi bi-x"></i> Dismiss
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trained Stocks Section -->
        <div class="card hover-lift animate-fade-in-up mt-4" style="animation-delay: 0.3s;">
            <div class="card-header bg-gradient-warning text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0 text-white">
                        <i class="bi bi-cpu-fill me-2"></i>Trained Stocks
                    </h5>
                    <button class="btn btn-light btn-sm" onclick="refreshTrainedModels()">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-hover mb-0" id="trained-models-table">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th class="border-0">Symbol</th>
                                <th class="border-0">Type</th>
                                <th class="border-0">Accuracy</th>
                                <th class="border-0">Trained</th>
                                <th class="border-0">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Models will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column: Stock Prediction -->
    <div class="col-lg-6">
        <div class="card hover-lift animate-fade-in-up" style="animation-delay: 0.4s;">
            <div class="card-header bg-gradient-info text-white">
                <h5 class="card-title mb-0 text-white">
                    <i class="bi bi-graph-up-arrow me-2"></i>Stock Prediction
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-12">
                        <div class="mb-3">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="predict-symbol" placeholder="e.g., NSE:RELIANCE-EQ">
                                <button class="btn btn-info" type="button" id="predict-btn">
                                    <i class="bi bi-magic"></i> Predict
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Prediction Results -->
                <div id="prediction-results" style="display: none;">
                    <hr>
                    <h6>Prediction Results</h6>
                    <div class="row g-3">
                        <div class="col-lg-6 col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h4 class="text-primary mb-1" id="predicted-price">₹0.00</h4>
                                    <small class="text-muted">Predicted Price</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h4 class="mb-1" id="price-change">0.00%</h4>
                                    <small class="text-muted">Expected Change</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h4 class="text-success mb-1" id="current-price">₹0.00</h4>
                                    <small class="text-muted">Current Price</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h4 class="text-info mb-1" id="confidence-score">0%</h4>
                                    <small class="text-muted">Confidence</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h4 class="mb-1" id="signal-strength">HOLD</h4>
                                    <small class="text-muted">Signal</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Individual Model Predictions -->
                    <div class="row g-3 mt-2" id="individual-predictions" style="display: none;">
                        <div class="col-12">
                            <h6 class="text-muted mb-3">Individual Model Predictions</h6>
                        </div>
                        <div class="col-lg-4 col-md-4">
                            <div class="card bg-light border-success">
                                <div class="card-body text-center py-2">
                                    <h6 class="text-success mb-1" id="rf-prediction">₹0.00</h6>
                                    <small class="text-muted">Random Forest</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-4">
                            <div class="card bg-light border-warning">
                                <div class="card-body text-center py-2">
                                    <h6 class="text-warning mb-1" id="xgb-prediction">₹0.00</h6>
                                    <small class="text-muted">XGBoost</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-4">
                            <div class="card bg-light border-info">
                                <div class="card-body text-center py-2">
                                    <h6 class="text-info mb-1" id="lstm-prediction">₹0.00</h6>
                                    <small class="text-muted">LSTM</small>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Backtesting Section -->
                <div class="mt-4">
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">Model Trust Analysis</h6>
                        <button class="btn btn-outline-warning btn-sm" id="backtest-btn">
                            <i class="bi bi-shield-check"></i> Test Model
                        </button>
                    </div>
                    
                    <!-- Backtesting Results -->
                    <div id="backtest-results" style="display: none;">
                        <div class="alert alert-info">
                            <h6 class="alert-heading">
                                <i class="bi bi-graph-up me-2"></i>Model Performance Analysis
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="text-center">
                                        <h4 class="mb-1" id="trust-score">0</h4>
                                        <small class="text-muted">Trust Score</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="text-center">
                                        <h4 class="mb-1" id="signal-accuracy">0%</h4>
                                        <small class="text-muted">Signal Accuracy</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="text-center">
                                        <h4 class="mb-1" id="price-accuracy">0%</h4>
                                        <small class="text-muted">Price Accuracy</small>
                                    </div>
                                </div>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Model Performance:</h6>
                                    <ul class="list-unstyled">
                                        <li><strong>Best Model:</strong> <span id="best-model">-</span></li>
                                        <li><strong>Test Period:</strong> <span id="test-period">-</span></li>
                                        <li><strong>Total Predictions:</strong> <span id="total-predictions">-</span></li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6>Recommendation:</h6>
                                    <p id="recommendation" class="mb-0">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ML-Powered Stock Screening Section -->
<div class="row g-4 mt-2">
    <div class="col-12">
        <div class="card hover-lift animate-fade-in-up">
            <div class="card-header bg-gradient-success text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0 text-white">
                        <i class="bi bi-robot me-2"></i>ML-Suggested Stocks
                        <small class="opacity-75">by Risk Profile</small>
                    </h5>
                    <div class="d-flex gap-2 align-items-center">
                        <select class="form-select form-select-sm" id="risk-strategy-select" style="min-width: 170px;">
                            <option value="default">Balanced Portfolio</option>
                            <option value="high_risk">Aggressive Growth</option>
                        </select>
                        <button class="btn btn-light btn-sm" onclick="discoverStocks()" title="Discover tradeable stocks">
                            <i class="bi bi-search"></i>
                        </button>
                        <button class="btn btn-light btn-sm" onclick="refreshMLRecommendations()" title="Get AI recommendations">
                            <i class="bi bi-magic"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Portfolio Strategy Info -->
            <div class="card-body border-bottom">
                <div class="row text-center" id="strategy-info">
                    <div class="col-md-3">
                        <div class="mb-2">
                            <h6 class="text-muted mb-1">Strategy</h6>
                            <span class="badge bg-primary" id="strategy-name">Balanced Portfolio</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-2">
                            <h6 class="text-muted mb-1">Large Cap</h6>
                            <span class="fw-bold text-primary" id="large-cap-allocation">60%</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-2">
                            <h6 class="text-muted mb-1">Mid Cap</h6>
                            <span class="fw-bold text-warning" id="mid-cap-allocation">30%</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-2">
                            <h6 class="text-muted mb-1">Small Cap</h6>
                            <span class="fw-bold text-danger" id="small-cap-allocation">10%</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-body p-0">
                <!-- ML Analysis Status Banner -->
                <div class="alert alert-info border-0 rounded-0 mb-0" style="background: linear-gradient(135deg, #17a2b8, #138496);">
                    <div class="d-flex align-items-center text-white">
                        <i class="bi bi-cpu-fill me-2" style="font-size: 1.2em;"></i>
                        <div>
                            <strong>ML Analysis Applied</strong>
                            <small class="d-block opacity-75">All stocks below are analyzed using 70 advanced ML features and filtered by your selected risk profile</small>
                        </div>
                        <div class="ms-auto">
                            <span class="badge bg-light text-dark" id="ml-analysis-count">0 stocks analyzed</span>
                        </div>
                    </div>
                </div>

                <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                    <table class="table table-hover mb-0" id="ml-recommendations-table">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th class="border-0">Symbol</th>
                                <th class="border-0">Company</th>
                                <th class="border-0">Market Cap</th>
                                <th class="border-0">Current Price</th>
                                <th class="border-0">Target Price</th>
                                <th class="border-0">Stop Loss</th>
                                <th class="border-0">ML Score</th>
                                <th class="border-0">Expected Return</th>
                                <th class="border-0">Recommendation</th>
                                <th class="border-0">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- ML recommendations will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Portfolio Summary Section -->
<div class="row g-4 mt-2" id="portfolio-summary-section" style="display: none;">
    <div class="col-12">
        <div class="card hover-lift animate-fade-in-up">
            <div class="card-header bg-gradient-info text-white">
                <h5 class="card-title mb-0 text-white">
                    <i class="bi bi-pie-chart me-2"></i>Portfolio Summary
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-4">
                    <div class="col-lg-3 col-md-6">
                        <div class="text-center">
                            <h4 class="text-primary mb-1" id="total-stocks">0</h4>
                            <small class="text-muted">Total Stocks</small>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="text-center">
                            <h4 class="text-success mb-1" id="expected-portfolio-return">0.0%</h4>
                            <small class="text-muted">Expected Return</small>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="text-center">
                            <h4 class="text-warning mb-1" id="portfolio-risk">0.0</h4>
                            <small class="text-muted">Risk Score</small>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="text-center">
                            <h4 class="text-info mb-1" id="diversification-score">0.0</h4>
                            <small class="text-muted">Diversification</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Active Trainings Section (Only shown when there are active trainings) -->
<div class="row g-4 mt-2" id="active-trainings-section" style="display: none;">
    <div class="col-12">
        <div class="card hover-lift animate-fade-in-up">
            <div class="card-header bg-gradient-info text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0 text-white">
                        <i class="bi bi-hourglass-split me-2"></i>Active Trainings
                    </h5>
                    <button class="btn btn-light btn-sm" onclick="refreshActiveTrainings()">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-hover mb-0" id="active-trainings-table">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th class="border-0">Symbol</th>
                                <th class="border-0">Model</th>
                                <th class="border-0">Status</th>
                                <th class="border-0">Progress</th>
                                <th class="border-0">Started</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Active trainings will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
// ML Dashboard JavaScript
document.addEventListener('DOMContentLoaded', function() {
    loadMLDashboardData();
    loadTrainedModels();
    loadActiveTrainings();

    // Training form submission
    document.getElementById('training-form').addEventListener('submit', handleTrainingSubmit);

    // Prediction button
    document.getElementById('predict-btn').addEventListener('click', handlePrediction);

    // Backtest button
    document.getElementById('backtest-btn').addEventListener('click', handleBacktest);

    // Symbol search
    document.getElementById('search-symbol-btn').addEventListener('click', searchSymbol);

    // ML recommendations functionality
    document.getElementById('risk-strategy-select').addEventListener('change', loadMLRecommendations);

    // Load ML recommendations on page load
    loadMLRecommendations();
});

// Load ML Dashboard Overview Data
async function loadMLDashboardData() {
    try {
        const response = await fetch('/api/v1/ml/overview');
        
        if (!response.ok) {
            if (response.status === 401) {
                window.location.href = '/login';
                return;
            }
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();

        if (result.success) {
            document.getElementById('trained-models-count').textContent = result.data.trained_stocks || 0;
            document.getElementById('training-success-rate').textContent = (result.data.success_rate || 0) + '%';
            document.getElementById('last-updated').textContent = result.data.last_updated || 'Never';
        }
    } catch (error) {
        console.error('Error loading ML dashboard data:', error);
    }
}

// Load Trained Stocks
async function loadTrainedModels() {
    try {
        const response = await fetch('/api/v1/ml/models');
        const result = await response.json();

        if (result.success && result.data) {
            updateTrainedModelsTable(result.data);
        }
    } catch (error) {
        console.error('Error loading trained models:', error);
        showTrainedModelsError();
    }
}

// Update Trained Stocks Table
function updateTrainedModelsTable(models) {
    const tbody = document.querySelector('#trained-models-table tbody');
    tbody.innerHTML = '';

    if (models.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No trained models yet</td></tr>';
        return;
    }

    models.forEach(model => {
        const row = tbody.insertRow();

        // Symbol
        row.insertCell(0).innerHTML = `<strong>${model.symbol}</strong>`;

        // Type
        const typeCell = row.insertCell(1);
        const typeBadge = getModelTypeBadge(model.type);
        typeCell.innerHTML = `<span class="badge ${typeBadge}">${model.type}</span>`;

        // Accuracy
        const accuracyCell = row.insertCell(2);
        const accuracy = parseFloat(model.accuracy || 0);
        const accuracyColor = accuracy >= 80 ? 'text-success' : accuracy >= 60 ? 'text-warning' : 'text-danger';
        accuracyCell.innerHTML = `<span class="${accuracyColor}">${accuracy.toFixed(1)}%</span>`;

        // Trained date
        row.insertCell(3).innerHTML = `<small class="text-muted">${formatDate(model.trained_date)}</small>`;

        // Actions
        const actionsCell = row.insertCell(4);
        actionsCell.innerHTML = `
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" onclick="predictStock('${model.symbol}')" title="Predict">
                    <i class="bi bi-magic"></i>
                </button>
                <button class="btn btn-outline-info" onclick="viewModelDetails('${model.id}')" title="Details">
                    <i class="bi bi-info-circle"></i>
                </button>
                <button class="btn btn-outline-danger" onclick="deleteModel('${model.id}')" title="Delete">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `;
    });
}

// Load Active Trainings
async function loadActiveTrainings() {
    try {
        const response = await fetch('/api/v1/ml/active-trainings');
        const result = await response.json();

        if (result.success) {
            updateActiveTrainingsTable(result.data);
        } else {
            showActiveTrainingsError();
        }
    } catch (error) {
        console.error('Error loading active trainings:', error);
        showActiveTrainingsError();
    }
}

// Update Active Trainings Table
function updateActiveTrainingsTable(trainings) {
    const tbody = document.querySelector('#active-trainings-table tbody');
    const activeTrainingsSection = document.getElementById('active-trainings-section');

    tbody.innerHTML = '';

    if (trainings.length === 0) {
        // Hide the entire Active Trainings section when no trainings
        activeTrainingsSection.style.display = 'none';
        return;
    }

    // Show the Active Trainings section when there are trainings
    activeTrainingsSection.style.display = 'block';

    trainings.forEach(training => {
        const row = tbody.insertRow();

        // Symbol
        row.insertCell(0).innerHTML = `<strong>${training.symbol}</strong>`;

        // Model type
        const typeCell = row.insertCell(1);
        const typeBadge = getModelTypeBadge(training.model_type);
        typeCell.innerHTML = `<span class="badge ${typeBadge}">${training.model_type}</span>`;

        // Status
        const statusCell = row.insertCell(2);
        const statusBadge = training.status === 'running' ? 'bg-success' : 'bg-warning';
        statusCell.innerHTML = `<span class="badge ${statusBadge}">${training.status}</span>`;

        // Progress
        const progressCell = row.insertCell(3);
        const progress = training.progress || 0;
        progressCell.innerHTML = `
            <div class="progress" style="width: 80px; height: 20px;">
                <div class="progress-bar" role="progressbar"
                     style="width: ${progress}%"
                     aria-valuenow="${progress}"
                     aria-valuemin="0"
                     aria-valuemax="100">
                    ${Math.round(progress)}%
                </div>
            </div>
        `;

        // Started
        row.insertCell(4).innerHTML = `<small class="text-muted">${training.started_at || training.created_at}</small>`;
    });
}

function showActiveTrainingsError() {
    const activeTrainingsSection = document.getElementById('active-trainings-section');
    const tbody = document.querySelector('#active-trainings-table tbody');

    tbody.innerHTML = `
        <tr>
            <td colspan="5" class="text-center text-danger py-4">
                <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
                <br>
                Error loading active trainings
            </td>
        </tr>
    `;

    // Show section even for errors so user can see the error
    activeTrainingsSection.style.display = 'block';
}

// Handle Training Form Submission
async function handleTrainingSubmit(event) {
    event.preventDefault();

    const formData = {
        symbol: document.getElementById('stock-symbol').value,
        model_type: 'ensemble', // Always use ensemble model
        use_technical_indicators: document.getElementById('use-technical-indicators').checked,
        start_date: document.getElementById('start-date').value,
        end_date: document.getElementById('end-date').value
    };

    try {
        showTrainingProgress();

        const response = await fetch('/api/v1/ml/train', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });

        const result = await response.json();

        if (result.success) {
            // Start polling for training progress
            if (result.training_id) {
                pollTrainingProgress(result.training_id);
            } else {
                console.error('Training started but no training_id provided');
                hideTrainingProgress();
                alert('Training started but unable to track progress');
            }
        } else {
            hideTrainingProgress();
            alert('Training failed: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Training error:', error);
        hideTrainingProgress();
        alert('Training failed: Network error');
    }
}

// Handle Stock Prediction
async function handlePrediction() {
    const symbol = document.getElementById('predict-symbol').value;
    const horizon = 1; // Default to 1 day prediction
    const predictBtn = document.getElementById('predict-btn');

    if (!symbol) {
        alert('Please enter a stock symbol');
        return;
    }

    // Show loading spinner
    showPredictionLoading();

    try {
        const response = await fetch('/api/v1/ml/predict', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                symbol: symbol,
                horizon: parseInt(horizon)
            })
        });

        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        
        if (!response.ok) {
            if (response.status === 401) {
                // User is not authenticated, redirect to login
                alert('Your session has expired. Please log in again.');
                window.location.href = '/login';
                return;
            }
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        console.log('Prediction API response:', result);

        if (result.success) {
            // The backend returns prediction data under 'prediction' property
            if (result.prediction) {
                displayPredictionResults(result.prediction);
            } else {
                console.error('No prediction data in response:', result);
                alert('Prediction failed: No prediction data received');
            }
        } else {
            alert('Prediction failed: ' + (result.error || 'Model not found for this symbol'));
        }
    } catch (error) {
        console.error('Prediction error:', error);
        alert('Prediction failed: Network error');
    } finally {
        // Hide loading spinner
        hidePredictionLoading();
    }
}

// Display Prediction Results
function displayPredictionResults(data) {
    console.log('Displaying prediction results with data:', data);
    
    try {
        // Show the prediction results section
        const resultsSection = document.getElementById('prediction-results');
        if (resultsSection) {
            resultsSection.style.display = 'block';
        }

        // Update prediction values using correct property names from API
        const predictedPriceElement = document.getElementById('predicted-price');
        if (predictedPriceElement && data.final_predicted_price) {
            predictedPriceElement.textContent = `₹${parseFloat(data.final_predicted_price).toFixed(2)}`;
        }

        const priceChange = parseFloat(data.predicted_change_percent);
        const priceChangeElement = document.getElementById('price-change');
        if (priceChangeElement) {
            priceChangeElement.textContent = `${priceChange >= 0 ? '+' : ''}${priceChange.toFixed(2)}%`;
            priceChangeElement.className = priceChange >= 0 ? 'text-success' : 'text-danger';
        }

        // Use current price if available, otherwise fall back to last close price
        let currentPrice, priceSource;
        if (data.current_price && data.current_price > 0) {
            currentPrice = parseFloat(data.current_price);
            priceSource = 'Real-time';
        } else {
            currentPrice = parseFloat(data.last_close_price);
            priceSource = 'Last Close';
        }
        
        const currentPriceElement = document.getElementById('current-price');
        if (currentPriceElement) {
            currentPriceElement.textContent = `₹${currentPrice.toFixed(2)}`;
        }
        
        
        // Update the price source label
        const currentPriceLabel = document.querySelector('#current-price').parentElement.querySelector('small');
        if (currentPriceLabel) {
            currentPriceLabel.textContent = `Current Price (${priceSource})`;
        }

        // Calculate confidence based on prediction accuracy (simplified)
        const confidence = Math.max(0, Math.min(100, 100 - Math.abs(priceChange)));
        const confidenceElement = document.getElementById('confidence-score');
        if (confidenceElement) {
            confidenceElement.textContent = `${Math.round(confidence)}%`;
        }

        const signalElement = document.getElementById('signal-strength');
        if (signalElement && data.signal) {
            signalElement.textContent = data.signal;
            signalElement.className = getSignalColor(data.signal);
        }

        // Display individual model predictions if available
        displayIndividualPredictions(data);
    } catch (error) {
        console.error('Error displaying prediction results:', error);
        alert('Error displaying prediction results: ' + error.message);
    }
}

// Utility Functions
function getModelTypeBadge(type) {
    const badges = {
        'ensemble': 'bg-primary',
        'random_forest': 'bg-success',
        'xgboost': 'bg-warning',
        'lstm': 'bg-info'
    };
    return badges[type] || 'bg-secondary';
}

function getSignalColor(signal) {
    const colors = {
        'BUY': 'text-success mb-1',
        'SELL': 'text-danger mb-1',
        'HOLD': 'text-warning mb-1'
    };
    return colors[signal] || 'text-secondary mb-1';
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString();
}

// Prediction Loading Spinner Functions
function showPredictionLoading() {
    const predictBtn = document.getElementById('predict-btn');
    const originalContent = predictBtn.innerHTML;
    
    // Store original content for restoration
    predictBtn.setAttribute('data-original-content', originalContent);
    
    // Show spinner and disable button
    predictBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Predicting...';
    predictBtn.disabled = true;
    
    // Hide prediction results if they exist
    const resultsSection = document.getElementById('prediction-results');
    if (resultsSection) {
        resultsSection.style.display = 'none';
    }
}

function hidePredictionLoading() {
    const predictBtn = document.getElementById('predict-btn');
    const originalContent = predictBtn.getAttribute('data-original-content');
    
    // Restore original content and enable button
    if (originalContent) {
        predictBtn.innerHTML = originalContent;
        predictBtn.removeAttribute('data-original-content');
    } else {
        predictBtn.innerHTML = '<i class="bi bi-magic"></i> Predict';
    }
    predictBtn.disabled = false;
}

function showTrainingProgress() {
    document.getElementById('training-progress').style.display = 'block';
}

function hideTrainingProgress() {
    document.getElementById('training-progress').style.display = 'none';
    document.getElementById('progress-bar').style.width = '0%';
    document.getElementById('progress-percent').textContent = '0%';
}

function pollTrainingProgress(trainingId) {
    // Validate trainingId
    if (!trainingId || trainingId === 'undefined') {
        console.error('Invalid training ID provided:', trainingId);
        hideTrainingProgress();
        alert('Unable to track training progress: Invalid training ID');
        return;
    }

    const progressBar = document.getElementById('progress-bar');
    const progressStatus = document.getElementById('progress-status');
    const progressPercent = document.getElementById('progress-percent');

    let pollInterval;
    let attempts = 0;
    const maxAttempts = 300; // 5 minutes at 1-second intervals

    async function checkProgress() {
        attempts++;

        try {
            const response = await fetch(`/api/v1/ml/training_progress/${trainingId}`);
            
            if (!response.ok) {
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const result = await response.json();

            if (result.success && result.data) {
                const data = result.data;
                const progress = Math.round(data.progress || 0);

                // Update progress bar
                progressBar.style.width = `${progress}%`;
                progressPercent.textContent = `${progress}%`;

                // Update status message
                if (data.status === 'running') {
                    progressStatus.textContent = `Training ${data.symbol}...`;
                    progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-info';
                } else if (data.status === 'completed') {
                    progressStatus.textContent = `Training completed successfully for ${data.symbol}!`;
                    progressBar.className = 'progress-bar bg-success';

                    // Stop polling
                    clearInterval(pollInterval);

                    // Show training results if available
                    if (data.training_results) {
                        displayTrainingResults(data.training_results);
                    }

                    // Hide progress after 3 seconds and refresh data
                    setTimeout(() => {
                        hideTrainingProgress();
                        loadMLDashboardData();
                        loadActiveTrainings();
                        loadTrainedModels();
                    }, 3000);

                    return;
                } else if (data.status === 'failed') {
                    progressStatus.textContent = `Training failed: ${data.error_message || 'Unknown error'}`;
                    progressBar.className = 'progress-bar bg-danger';

                    // Stop polling
                    clearInterval(pollInterval);

                    // Hide progress after 5 seconds
                    setTimeout(() => {
                        hideTrainingProgress();
                        loadMLDashboardData();
                        loadActiveTrainings();
                    }, 5000);

                    return;
                } else if (data.status === 'pending') {
                    progressStatus.textContent = `Training job queued for ${data.symbol}...`;
                    progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-warning';
                }

                // Continue polling if still in progress
                if (progress >= 100 || data.status === 'completed') {
                    clearInterval(pollInterval);
                }

            } else {
                console.error('Failed to get training progress:', result.error);
                if (attempts >= 3) {
                    progressStatus.textContent = 'Error checking training progress';
                    progressBar.className = 'progress-bar bg-warning';
                }
            }

        } catch (error) {
            console.error('Error polling training progress:', error);
            if (attempts >= 3) {
                progressStatus.textContent = 'Network error checking progress';
                progressBar.className = 'progress-bar bg-warning';
            }
        }

        // Stop polling after max attempts (5 minutes)
        if (attempts >= maxAttempts) {
            clearInterval(pollInterval);
            progressStatus.textContent = 'Training timeout - check Active Trainings for status';
            progressBar.className = 'progress-bar bg-secondary';

            setTimeout(() => {
                hideTrainingProgress();
                loadActiveTrainings();
            }, 3000);
        }
    }

    // Start polling immediately and then every second
    checkProgress();
    pollInterval = setInterval(checkProgress, 1000);
}

function refreshTrainedModels() {
    loadTrainedModels();
}

function refreshActiveTrainings() {
    loadActiveTrainings();
}

function predictStock(symbol) {
    document.getElementById('predict-symbol').value = symbol;
    document.getElementById('predict-btn').click();
}

function viewModelDetails(modelId) {
    // Implement model details view
    alert('Model details for ID: ' + modelId);
}

function deleteModel(modelId) {
    if (confirm('Are you sure you want to delete this model?')) {
        // Implement model deletion
        alert('Delete model ID: ' + modelId);
    }
}

// Handle Backtesting
async function handleBacktest() {
    const symbol = document.getElementById('predict-symbol').value;
    const backtestBtn = document.getElementById('backtest-btn');

    if (!symbol) {
        alert('Please enter a stock symbol first');
        return;
    }

    // Show loading state
    showBacktestLoading();

    try {
        const response = await fetch('/api/v1/ml/backtest', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                symbol: symbol,
                test_period_days: 30  // Test on last 30 days
            })
        });

        if (!response.ok) {
            if (response.status === 401) {
                alert('Your session has expired. Please log in again.');
                window.location.href = '/login';
                return;
            }
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();

        if (result.success) {
            displayBacktestResults(result);
        } else {
            alert('Backtesting failed: ' + result.error);
        }

    } catch (error) {
        console.error('Backtesting error:', error);
        alert('Backtesting failed: Network error');
    } finally {
        hideBacktestLoading();
    }
}

function displayBacktestResults(result) {
    console.log('Displaying backtest results:', result);
    
    const resultsSection = document.getElementById('backtest-results');
    if (resultsSection) {
        resultsSection.style.display = 'block';
    }

    const summary = result.summary;
    const metrics = result.metrics;

    // Update trust score with color coding
    const trustScoreElement = document.getElementById('trust-score');
    if (trustScoreElement) {
        trustScoreElement.textContent = summary.trust_score;
        trustScoreElement.className = `mb-1 text-${summary.trust_color}`;
    }

    // Update signal accuracy
    const signalAccuracyElement = document.getElementById('signal-accuracy');
    if (signalAccuracyElement) {
        signalAccuracyElement.textContent = `${summary.ensemble_accuracy}%`;
    }

    // Update price accuracy (using MAPE - lower is better)
    const priceAccuracyElement = document.getElementById('price-accuracy');
    if (priceAccuracyElement) {
        const priceAccuracy = Math.max(0, 100 - summary.ensemble_mape);
        priceAccuracyElement.textContent = `${priceAccuracy.toFixed(1)}%`;
    }

    // Update model performance details
    const bestModelElement = document.getElementById('best-model');
    if (bestModelElement) {
        bestModelElement.textContent = summary.best_model.replace('_model', '').toUpperCase();
    }

    const testPeriodElement = document.getElementById('test-period');
    if (testPeriodElement) {
        testPeriodElement.textContent = summary.test_period;
    }

    const totalPredictionsElement = document.getElementById('total-predictions');
    if (totalPredictionsElement) {
        totalPredictionsElement.textContent = metrics.total_predictions;
    }

    const recommendationElement = document.getElementById('recommendation');
    if (recommendationElement) {
        recommendationElement.textContent = summary.recommendation;
    }
}

function showBacktestLoading() {
    const backtestBtn = document.getElementById('backtest-btn');
    const originalContent = backtestBtn.innerHTML;
    
    // Store original content for restoration
    backtestBtn.setAttribute('data-original-content', originalContent);
    
    // Show spinner and disable button
    backtestBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Testing...';
    backtestBtn.disabled = true;
    
    // Hide previous results
    const resultsSection = document.getElementById('backtest-results');
    if (resultsSection) {
        resultsSection.style.display = 'none';
    }
}

function hideBacktestLoading() {
    const backtestBtn = document.getElementById('backtest-btn');
    const originalContent = backtestBtn.getAttribute('data-original-content');
    
    // Restore original content and enable button
    if (originalContent) {
        backtestBtn.innerHTML = originalContent;
    } else {
        backtestBtn.innerHTML = '<i class="bi bi-shield-check"></i> Test Model';
    }
    backtestBtn.disabled = false;
}

async function searchSymbol() {
    const symbolInput = document.getElementById('stock-symbol');
    const symbol = symbolInput.value.trim();

    if (!symbol) {
        alert('Please enter a stock symbol');
        return;
    }

    const searchBtn = document.getElementById('search-symbol-btn');
    const originalText = searchBtn.innerHTML;
    searchBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    searchBtn.disabled = true;

    try {
        const response = await fetch('/api/v1/ml/validate_symbol', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ symbol: symbol })
        });

        const result = await response.json();

        if (result.success) {
            if (result.valid) {
                // Symbol is valid
                symbolInput.classList.remove('is-invalid');
                symbolInput.classList.add('is-valid');

                // Show success message
                showSymbolValidationMessage(result.message, 'success');

                // If Fyers data is available, show options
                if (result.fyers_data && result.fyers_data.length > 0) {
                    showSymbolOptions(result.fyers_data, symbolInput);
                }
            } else {
                // Symbol is invalid
                symbolInput.classList.remove('is-valid');
                symbolInput.classList.add('is-invalid');
                showSymbolValidationMessage(result.message, 'danger');
            }
        } else {
            symbolInput.classList.remove('is-valid');
            symbolInput.classList.add('is-invalid');
            showSymbolValidationMessage('Symbol validation failed', 'danger');
        }
    } catch (error) {
        console.error('Symbol validation error:', error);
        symbolInput.classList.remove('is-valid');
        symbolInput.classList.add('is-invalid');
        showSymbolValidationMessage('Network error during validation', 'danger');
    } finally {
        searchBtn.innerHTML = originalText;
        searchBtn.disabled = false;
    }
}

function showSymbolValidationMessage(message, type) {
    // Remove any existing validation message
    const existingAlert = document.querySelector('#symbol-validation-alert');
    if (existingAlert) {
        existingAlert.remove();
    }

    // Create and show new message
    const alertDiv = document.createElement('div');
    alertDiv.id = 'symbol-validation-alert';
    alertDiv.className = `alert alert-${type} alert-dismissible fade show mt-2`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    // Insert after the input group
    const inputGroup = document.querySelector('#stock-symbol').closest('.mb-3');
    inputGroup.appendChild(alertDiv);

    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv && alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

function showSymbolOptions(fyersData, symbolInput) {
    // Create dropdown with symbol options
    let dropdownDiv = document.getElementById('symbol-dropdown');

    if (!dropdownDiv) {
        dropdownDiv = document.createElement('div');
        dropdownDiv.id = 'symbol-dropdown';
        dropdownDiv.className = 'dropdown-menu show position-absolute w-100 mt-1';
        dropdownDiv.style.maxHeight = '200px';
        dropdownDiv.style.overflowY = 'auto';
        dropdownDiv.style.zIndex = '1050';

        const inputGroup = symbolInput.closest('.input-group');
        inputGroup.style.position = 'relative';
        inputGroup.appendChild(dropdownDiv);
    }

    dropdownDiv.innerHTML = '';

    fyersData.forEach(item => {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'dropdown-item';
        optionDiv.style.cursor = 'pointer';
        optionDiv.innerHTML = `
            <div>
                <strong>${item.symbol || item.trading_symbol}</strong>
                <br>
                <small class="text-muted">${item.company_name || item.name || ''}</small>
            </div>
        `;

        optionDiv.addEventListener('click', function() {
            symbolInput.value = item.symbol || item.trading_symbol;
            symbolInput.classList.remove('is-invalid');
            symbolInput.classList.add('is-valid');
            dropdownDiv.remove();
        });

        dropdownDiv.appendChild(optionDiv);
    });

    // Hide dropdown when clicking outside
    document.addEventListener('click', function hideDropdown(e) {
        if (!dropdownDiv.contains(e.target) && !symbolInput.contains(e.target)) {
            dropdownDiv.remove();
            document.removeEventListener('click', hideDropdown);
        }
    });
}

function showTrainedModelsError() {
    const tbody = document.querySelector('#trained-models-table tbody');
    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-warning">Error loading models</td></tr>';
}

// Training Results Display Functions
function displayTrainingResults(results) {
    console.log('Displaying training results:', results);

    const resultsSection = document.getElementById('training-results');
    if (!resultsSection) return;

    // Update basic training info
    const trainedSymbolElement = document.getElementById('trained-symbol');
    if (trainedSymbolElement) {
        trainedSymbolElement.textContent = results.symbol || '-';
    }

    const trainedModelsElement = document.getElementById('trained-models');
    if (trainedModelsElement && results.models_saved) {
        trainedModelsElement.textContent = results.models_saved.join(', ');
    }

    const trainingPeriodElement = document.getElementById('training-period');
    if (trainingPeriodElement && results.training_period) {
        const period = results.training_period;
        trainingPeriodElement.textContent = `${period.start_date} to ${period.end_date}`;
    }

    // Display backtesting results if available
    if (results.backtesting && results.backtesting.success) {
        displayAutoBacktestResults(results.backtesting);
    }

    // Show the results section
    resultsSection.style.display = 'block';
}

function displayAutoBacktestResults(backtestData) {
    console.log('Displaying auto backtest results:', backtestData);

    const autoBacktestSection = document.getElementById('auto-backtest-results');
    if (!autoBacktestSection) return;

    const summary = backtestData.summary;
    if (!summary) return;

    // Update trust score with color coding
    const autoTrustScoreElement = document.getElementById('auto-trust-score');
    if (autoTrustScoreElement) {
        autoTrustScoreElement.textContent = summary.trust_score || '-';
        autoTrustScoreElement.className = `mb-1 text-${summary.trust_color || 'secondary'}`;
    }

    // Update signal accuracy
    const autoSignalAccuracyElement = document.getElementById('auto-signal-accuracy');
    if (autoSignalAccuracyElement) {
        autoSignalAccuracyElement.textContent = `${summary.ensemble_accuracy || 0}%`;
    }

    // Update best model
    const autoBestModelElement = document.getElementById('auto-best-model');
    if (autoBestModelElement) {
        const bestModel = summary.best_model ? summary.best_model.replace('_model', '').toUpperCase() : '-';
        autoBestModelElement.textContent = bestModel;
    }

    // Update test period
    const autoTestPeriodElement = document.getElementById('auto-test-period');
    if (autoTestPeriodElement) {
        autoTestPeriodElement.textContent = summary.test_period || '-';
    }

    // Update recommendation
    const autoRecommendationElement = document.getElementById('auto-recommendation');
    if (autoRecommendationElement) {
        autoRecommendationElement.textContent = summary.recommendation || '-';
    }

    // Show the auto backtest results
    autoBacktestSection.style.display = 'block';
}

function hideTrainingResults() {
    const resultsSection = document.getElementById('training-results');
    if (resultsSection) {
        resultsSection.style.display = 'none';
    }

    // Also hide the auto backtest section
    const autoBacktestSection = document.getElementById('auto-backtest-results');
    if (autoBacktestSection) {
        autoBacktestSection.style.display = 'none';
    }
}

function displayIndividualPredictions(data) {
    const individualSection = document.getElementById('individual-predictions');
    if (!individualSection) return;

    let hasIndividualPredictions = false;

    // Update Random Forest prediction
    if (data.rf_predicted_price) {
        const rfElement = document.getElementById('rf-prediction');
        if (rfElement) {
            rfElement.textContent = `₹${parseFloat(data.rf_predicted_price).toFixed(2)}`;
            hasIndividualPredictions = true;
        }
    }

    // Update XGBoost prediction
    if (data.xgb_predicted_price) {
        const xgbElement = document.getElementById('xgb-prediction');
        if (xgbElement) {
            xgbElement.textContent = `₹${parseFloat(data.xgb_predicted_price).toFixed(2)}`;
            hasIndividualPredictions = true;
        }
    }

    // Update LSTM prediction
    if (data.lstm_predicted_price) {
        const lstmElement = document.getElementById('lstm-prediction');
        if (lstmElement) {
            lstmElement.textContent = `₹${parseFloat(data.lstm_predicted_price).toFixed(2)}`;
            hasIndividualPredictions = true;
        }
    }

    // Show/hide the individual predictions section
    if (hasIndividualPredictions) {
        individualSection.style.display = 'block';
    } else {
        individualSection.style.display = 'none';
    }
}

// ML Recommendations Functions
async function loadMLRecommendations() {
    try {
        const riskProfile = document.getElementById('risk-strategy-select').value;
        showMLRecommendationsLoading();
        updateStrategyInfo(riskProfile);

        const response = await fetch('/api/v1/screening/screen', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                risk_profile: riskProfile,
                auto_train: false
            })
        });

        if (!response.ok) {
            if (response.status === 401) {
                window.location.href = '/login';
                return;
            }
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();

        if (result.success) {
            displayMLRecommendations(result.portfolio);
            displayPortfolioSummary(result.portfolio);
        } else {
            showMLRecommendationsError(result.error || 'Failed to load ML recommendations');
        }
    } catch (error) {
        console.error('Error loading ML recommendations:', error);
        showMLRecommendationsError('Network error loading ML recommendations');
    }
}

function displayMLRecommendations(portfolio) {
    const tbody = document.querySelector('#ml-recommendations-table tbody');
    tbody.innerHTML = '';

    // Combine all stocks from different categories
    const allStocks = [
        ...portfolio.stocks.large_cap.map(s => ({ ...s, category: 'Large Cap' })),
        ...portfolio.stocks.mid_cap.map(s => ({ ...s, category: 'Mid Cap' })),
        ...portfolio.stocks.small_cap.map(s => ({ ...s, category: 'Small Cap' }))
    ];

    if (allStocks.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="10" class="text-center text-muted py-4">
                    <i class="bi bi-info-circle me-2"></i>
                    No ML recommendations found for the selected risk profile. Try refreshing or switch to discovery mode.
                </td>
            </tr>
        `;
        return;
    }

    // Sort by overall score (highest first)
    allStocks.sort((a, b) => b.overall_score - a.overall_score);

    // Update ML analysis count
    document.getElementById('ml-analysis-count').textContent = `${allStocks.length} stocks analyzed`;

    allStocks.forEach(stock => {
        const row = tbody.insertRow();

        // Symbol with ML Suggested Tag
        const symbolCell = row.insertCell(0);
        symbolCell.innerHTML = `
            <div>
                <strong>${stock.symbol}</strong>
                <br>
                <span class="badge bg-success bg-gradient" style="font-size: 0.7em;">
                    <i class="bi bi-robot me-1"></i>ML Suggested
                </span>
            </div>
        `;

        // Company Name
        row.insertCell(1).textContent = stock.name || 'N/A';

        // Market Cap Category
        const categoryCell = row.insertCell(2);
        const categoryColor = stock.category === 'Large Cap' ? 'primary' :
                             stock.category === 'Mid Cap' ? 'warning' : 'danger';
        categoryCell.innerHTML = `<span class="badge bg-${categoryColor}">${stock.category}</span>`;

        // Current Price
        row.insertCell(3).innerHTML = `₹${stock.current_price.toFixed(2)}`;

        // Target Price
        row.insertCell(4).innerHTML = `₹${stock.target_price.toFixed(2)}`;

        // Stop Loss
        row.insertCell(5).innerHTML = `₹${stock.stop_loss.toFixed(2)}`;

        // ML Score (Overall Score)
        const scoreCell = row.insertCell(6);
        const score = stock.overall_score * 100;
        scoreCell.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="progress flex-grow-1 me-2" style="height: 8px;">
                    <div class="progress-bar bg-${score >= 70 ? 'success' : score >= 50 ? 'warning' : 'danger'}"
                         style="width: ${score}%"></div>
                </div>
                <small class="text-muted">${score.toFixed(0)}</small>
            </div>
        `;

        // Expected Return
        const returnCell = row.insertCell(7);
        const expectedReturn = stock.expected_return * 100;
        returnCell.textContent = `${expectedReturn.toFixed(1)}%`;
        returnCell.className = expectedReturn > 0 ? 'text-success fw-bold' : 'text-danger fw-bold';

        // Recommendation with Risk Profile Tag
        const recCell = row.insertCell(8);
        const recColor = stock.recommendation === 'BUY' ? 'success' :
                        stock.recommendation === 'SELL' ? 'danger' : 'warning';

        const riskProfile = document.getElementById('risk-strategy-select').value;
        const riskTag = riskProfile === 'high_risk' ?
            '<small class="d-block text-danger"><i class="bi bi-exclamation-triangle"></i> High Risk</small>' :
            '<small class="d-block text-primary"><i class="bi bi-shield-check"></i> Balanced</small>';

        recCell.innerHTML = `
            <div>
                <span class="badge bg-${recColor}">${stock.recommendation}</span>
                ${riskTag}
            </div>
        `;

        // Actions
        const actionsCell = row.insertCell(9);
        actionsCell.innerHTML = `
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" onclick="predictStock('${stock.symbol}')" title="Predict">
                    <i class="bi bi-magic"></i>
                </button>
                <button class="btn btn-outline-info" onclick="analyzeStock('${stock.symbol}')" title="Analyze">
                    <i class="bi bi-graph-up"></i>
                </button>
                <button class="btn btn-outline-success" onclick="viewStockDetails('${stock.symbol}')" title="Details">
                    <i class="bi bi-info-circle"></i>
                </button>
            </div>
        `;
    });
}

function displayPortfolioSummary(portfolio) {
    const summarySection = document.getElementById('portfolio-summary-section');
    summarySection.style.display = 'block';

    document.getElementById('total-stocks').textContent = portfolio.portfolio_metrics.total_stocks;
    document.getElementById('expected-portfolio-return').textContent =
        `${portfolio.portfolio_metrics.expected_return.toFixed(1)}%`;
    document.getElementById('portfolio-risk').textContent =
        portfolio.portfolio_metrics.portfolio_risk.toFixed(2);
    document.getElementById('diversification-score').textContent =
        portfolio.portfolio_metrics.diversification_score.toFixed(2);
}

function updateStrategyInfo(riskProfile) {
    const strategyName = document.getElementById('strategy-name');
    const largeCap = document.getElementById('large-cap-allocation');
    const midCap = document.getElementById('mid-cap-allocation');
    const smallCap = document.getElementById('small-cap-allocation');

    if (riskProfile === 'high_risk') {
        strategyName.textContent = 'Aggressive Growth';
        strategyName.className = 'badge bg-danger';
        largeCap.textContent = '0%';
        midCap.textContent = '50%';
        smallCap.textContent = '50%';

        // Update ML banner for high risk
        updateMLBannerText('High-Risk ML Analysis: Focus on Mid & Small Cap growth stocks with higher volatility tolerance');
    } else {
        strategyName.textContent = 'Balanced Portfolio';
        strategyName.className = 'badge bg-primary';
        largeCap.textContent = '60%';
        midCap.textContent = '30%';
        smallCap.textContent = '10%';

        // Update ML banner for balanced risk
        updateMLBannerText('Balanced ML Analysis: Conservative approach with focus on Large Cap stability and moderate growth');
    }
}

function updateMLBannerText(description) {
    const bannerText = document.querySelector('.alert-info small');
    if (bannerText) {
        bannerText.textContent = description;
    }
}

function showMLRecommendationsLoading() {
    const tbody = document.querySelector('#ml-recommendations-table tbody');

    // Update ML banner for loading state
    document.getElementById('ml-analysis-count').innerHTML = `
        <span class="spinner-border spinner-border-sm me-2"></span>Analyzing...
    `;

    tbody.innerHTML = `
        <tr>
            <td colspan="10" class="text-center py-5">
                <div class="d-flex flex-column justify-content-center align-items-center">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h6 class="text-primary mb-2">
                        <i class="bi bi-cpu-fill me-2"></i>ML Analysis in Progress
                    </h6>
                    <p class="text-muted mb-0">
                        Analyzing stocks with 70 advanced features • Auto-training models • Risk filtering
                    </p>
                </div>
            </td>
        </tr>
    `;
}

function showMLRecommendationsError(message) {
    const tbody = document.querySelector('#ml-recommendations-table tbody');

    // Update ML banner for error state
    document.getElementById('ml-analysis-count').innerHTML = `
        <span class="badge bg-danger">Analysis Failed</span>
    `;

    tbody.innerHTML = `
        <tr>
            <td colspan="10" class="text-center py-5">
                <div class="text-danger">
                    <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
                    <h6 class="mt-3 mb-2">ML Analysis Failed</h6>
                    <p class="text-muted">${message}</p>
                    <button class="btn btn-outline-primary btn-sm mt-2" onclick="refreshMLRecommendations()">
                        <i class="bi bi-arrow-repeat me-2"></i>Retry Analysis
                    </button>
                </div>
            </td>
        </tr>
    `;
}

async function discoverStocks() {
    try {
        showMLRecommendationsLoading();

        const response = await fetch('/api/v1/screening/discover?refresh=true');

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();

        if (result.success) {
            alert(`Discovered ${result.summary.total_stocks} tradeable stocks!\n` +
                  `Large Cap: ${result.summary.large_cap_count}\n` +
                  `Mid Cap: ${result.summary.mid_cap_count}\n` +
                  `Small Cap: ${result.summary.small_cap_count}`);

            // Reload recommendations with fresh data
            loadMLRecommendations();
        } else {
            showMLRecommendationsError('Failed to discover stocks: ' + result.error);
        }
    } catch (error) {
        console.error('Error discovering stocks:', error);
        showMLRecommendationsError('Network error during stock discovery');
    }
}

function refreshMLRecommendations() {
    loadMLRecommendations();
}

async function analyzeStock(symbol) {
    try {
        const response = await fetch('/api/v1/screening/analyze-stock', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                symbol: symbol,
                auto_train: false
            })
        });

        const result = await response.json();

        if (result.success) {
            const analysis = result.analysis;
            alert(`ML Analysis for ${symbol}:\n\n` +
                  `Overall Score: ${(analysis.overall_score * 100).toFixed(1)}/100\n` +
                  `Technical Score: ${(analysis.technical_score * 100).toFixed(1)}/100\n` +
                  `Risk Score: ${(analysis.risk_score * 100).toFixed(1)}/100\n` +
                  `ML Prediction: ₹${analysis.ml_prediction.toFixed(2)}\n` +
                  `Confidence: ${(analysis.prediction_confidence * 100).toFixed(1)}%\n` +
                  `Recommendation: ${analysis.recommendation}\n\n` +
                  `Reasons: ${analysis.reasons.join(', ')}`);
        } else {
            alert('Analysis failed: ' + result.error);
        }
    } catch (error) {
        alert('Network error during analysis');
    }
}

function viewStockDetails(symbol) {
    // Navigate to stock details or show modal
    alert(`Detailed analysis for ${symbol} - Advanced features coming soon!`);
}
</script>
{% endblock %}