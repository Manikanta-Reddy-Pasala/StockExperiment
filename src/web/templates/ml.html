{% extends "base.html" %}

{% block title %}Machine Learning{% endblock %}

{% block content %}


<!-- ML Models Dashboard -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card hover-lift animate-fade-in-up">
            <div class="card-header bg-gradient-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0 text-white">
                    <i class="bi bi-robot me-2"></i>Machine Learning Models
                </h5>
                <button class="btn btn-light btn-sm" onclick="trainAllModels()" id="train-all-btn">
                    <i class="bi bi-play-circle me-2"></i>Train All Models
                </button>
            </div>
            <div class="card-body">
                <div class="row g-4" id="ml-models-container">
                    <!-- Model 1: Traditional ML -->
                    <div class="col-lg-4">
                        <div class="card border-success h-100">
                            <div class="card-header bg-gradient-success text-white">
                                <h6 class="mb-0">
                                    <i class="bi bi-cpu me-2"></i>Traditional ML
                                </h6>
                            </div>
                            <div class="card-body">
                                <p class="text-muted small mb-3">Random Forest + XGBoost</p>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="text-muted small">Stocks Trained</span>
                                        <strong id="traditional-stocks-count" class="text-success">
                                            <span class="spinner-border spinner-border-sm"></span>
                                        </strong>
                                    </div>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="text-muted small">Last Trained</span>
                                        <span id="traditional-last-trained" class="small">
                                            <span class="spinner-border spinner-border-sm"></span>
                                        </span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span class="text-muted small">Status</span>
                                        <span id="traditional-status" class="badge bg-secondary">
                                            Loading...
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Model 2: Raw LSTM -->
                    <div class="col-lg-4">
                        <div class="card border-info h-100">
                            <div class="card-header bg-gradient-info text-white">
                                <h6 class="mb-0">
                                    <i class="bi bi-diagram-3 me-2"></i>Raw LSTM
                                </h6>
                            </div>
                            <div class="card-body">
                                <p class="text-muted small mb-3">Deep Learning (OHLCV Sequences)</p>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="text-muted small">Stocks Trained</span>
                                        <strong id="raw_lstm-stocks-count" class="text-info">
                                            <span class="spinner-border spinner-border-sm"></span>
                                        </strong>
                                    </div>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="text-muted small">Last Trained</span>
                                        <span id="raw_lstm-last-trained" class="small">
                                            <span class="spinner-border spinner-border-sm"></span>
                                        </span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span class="text-muted small">Status</span>
                                        <span id="raw_lstm-status" class="badge bg-secondary">
                                            Loading...
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Model 3: Kronos -->
                    <div class="col-lg-4">
                        <div class="card border-warning h-100">
                            <div class="card-header bg-gradient-warning text-white">
                                <h6 class="mb-0">
                                    <i class="bi bi-graph-up-arrow me-2"></i>Kronos
                                </h6>
                            </div>
                            <div class="card-body">
                                <p class="text-muted small mb-3">K-line Tokenization</p>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="text-muted small">Stocks Trained</span>
                                        <strong id="kronos-stocks-count" class="text-warning">
                                            <span class="spinner-border spinner-border-sm"></span>
                                        </strong>
                                    </div>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="text-muted small">Last Trained</span>
                                        <span id="kronos-last-trained" class="small">
                                            <span class="spinner-border spinner-border-sm"></span>
                                        </span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span class="text-muted small">Status</span>
                                        <span id="kronos-status" class="badge bg-secondary">
                                            Loading...
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Left Column: Train Stock Form and Trained Stocks -->
    <div class="col-lg-6">
        <!-- Train Stock Form -->
        <div class="card hover-lift animate-fade-in-up" style="animation-delay: 0.2s;">
            <div class="card-header bg-gradient-success text-white">
                <h5 class="card-title mb-0 text-white">
                    <i class="bi bi-gear-fill me-2"></i>Train Stock
                </h5>
            </div>
            <div class="card-body">
                <form id="training-form">
                    <div class="mb-3">
                        <label for="stock-symbol" class="form-label">Stock Symbol</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" id="stock-symbol" placeholder="e.g., NSE:RELIANCE-EQ" required>
                            <button class="btn btn-outline-secondary" type="button" id="search-symbol-btn">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                        <div class="form-text">Enter the full exchange:symbol format</div>
                    </div>


                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="start-date" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="start-date" required>
                                <div class="form-text">Training data start date</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="end-date" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="end-date" required>
                                <div class="form-text">Training data end date</div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="alert alert-info">
                            <i class="bi bi-cpu-fill me-2"></i>
                            <strong>Trains All 3 Models:</strong>
                            <br>
                            <small>
                                • Traditional ML (Random Forest + XGBoost)<br>
                                • Raw LSTM (Deep Learning)<br>
                                • Kronos (K-line Tokenization)
                            </small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="use-technical-indicators" checked>
                            <label class="form-check-label" for="use-technical-indicators">
                                Include Enhanced Technical Indicators
                                <small class="text-muted">(20+ normalized features: RSI, MACD, Moving Averages, Volume Patterns, Price Ratios)</small>
                            </label>
                        </div>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-play-circle me-2"></i>Start Training
                        </button>
                    </div>
                </form>

                <!-- Training Progress -->
                <div id="training-progress" class="mt-4" style="display: none;">
                    <h6>Training Progress</h6>
                    <div class="progress mb-2">
                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                             id="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="d-flex justify-content-between">
                        <small class="text-muted" id="progress-status">Starting training...</small>
                        <small class="text-muted" id="progress-percent">0%</small>
                    </div>
                </div>

                <!-- Training Results & Backtesting -->
                <div id="training-results" class="mt-4" style="display: none;">
                    <div class="alert alert-success">
                        <h6 class="alert-heading">
                            <i class="bi bi-check-circle me-2"></i>Training Completed Successfully
                        </h6>
                        <p class="mb-2">
                            <strong>Symbol:</strong> <span id="trained-symbol">-</span><br>
                            <strong>Models:</strong> <span id="trained-models">-</span><br>
                            <strong>Training Period:</strong> <span id="training-period">-</span>
                        </p>

                        <!-- Automatic Backtesting Results -->
                        <div id="auto-backtest-results" style="display: none;">
                            <hr class="my-3">
                            <h6 class="mb-3">
                                <i class="bi bi-graph-up me-2"></i>Automatic Backtesting Results
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h5 class="mb-1" id="auto-trust-score">-</h5>
                                        <small class="text-muted">Trust Score</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h5 class="mb-1" id="auto-signal-accuracy">-</h5>
                                        <small class="text-muted">Signal Accuracy</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h5 class="mb-1" id="auto-best-model">-</h5>
                                        <small class="text-muted">Best Model</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h5 class="mb-1" id="auto-test-period">-</h5>
                                        <small class="text-muted">Test Period</small>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <strong>Recommendation:</strong> <span id="auto-recommendation">-</span>
                            </div>
                        </div>

                        <div class="mt-3">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="hideTrainingResults()">
                                <i class="bi bi-x"></i> Dismiss
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column: Stock Prediction -->
    <div class="col-lg-6">
        <div class="card hover-lift animate-fade-in-up" style="animation-delay: 0.4s;">
            <div class="card-header bg-gradient-info text-white">
                <h5 class="card-title mb-0 text-white">
                    <i class="bi bi-graph-up-arrow me-2"></i>Stock Prediction
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-12">
                        <div class="mb-3">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="predict-symbol" placeholder="e.g., NSE:RELIANCE-EQ">
                                <button class="btn btn-info" type="button" id="predict-btn">
                                    <i class="bi bi-magic"></i> Predict
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Prediction Results -->
                <div id="prediction-results" style="display: none;">
                    <hr>
                    <h6>Prediction Results</h6>
                    <div class="row g-3">
                        <div class="col-lg-6 col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h4 class="text-primary mb-1" id="predicted-price">₹0.00</h4>
                                    <small class="text-muted">Predicted Price</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h4 class="mb-1" id="price-change">0.00%</h4>
                                    <small class="text-muted">Expected Change</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h4 class="text-success mb-1" id="current-price">₹0.00</h4>
                                    <small class="text-muted">Current Price</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h4 class="text-info mb-1" id="confidence-score">0%</h4>
                                    <small class="text-muted">Confidence</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h4 class="mb-1" id="signal-strength">HOLD</h4>
                                    <small class="text-muted">Signal</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Individual Model Predictions -->
                    <div class="row g-3 mt-2" id="individual-predictions">
                        <div class="col-12">
                            <h6 class="text-muted mb-3">Predictions from All 3 Models</h6>
                        </div>
                        <div class="col-lg-4 col-md-4">
                            <div class="card bg-light border-success">
                                <div class="card-body text-center py-2">
                                    <h6 class="text-success mb-1" id="traditional-prediction">₹0.00</h6>
                                    <small class="text-muted">Traditional ML</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-4">
                            <div class="card bg-light border-info">
                                <div class="card-body text-center py-2">
                                    <h6 class="text-info mb-1" id="lstm-prediction">₹0.00</h6>
                                    <small class="text-muted">Raw LSTM</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-4">
                            <div class="card bg-light border-warning">
                                <div class="card-body text-center py-2">
                                    <h6 class="text-warning mb-1" id="kronos-prediction">₹0.00</h6>
                                    <small class="text-muted">Kronos</small>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Backtesting Section -->
                <div class="mt-4">
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">Model Trust Analysis</h6>
                        <button class="btn btn-outline-warning btn-sm" id="backtest-btn">
                            <i class="bi bi-shield-check"></i> Test Model
                        </button>
                    </div>
                    
                    <!-- Backtesting Results -->
                    <div id="backtest-results" style="display: none;">
                        <div class="alert alert-info">
                            <h6 class="alert-heading">
                                <i class="bi bi-graph-up me-2"></i>Model Performance Analysis
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="text-center">
                                        <h4 class="mb-1" id="trust-score">0</h4>
                                        <small class="text-muted">Trust Score</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="text-center">
                                        <h4 class="mb-1" id="signal-accuracy">0%</h4>
                                        <small class="text-muted">Signal Accuracy</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="text-center">
                                        <h4 class="mb-1" id="price-accuracy">0%</h4>
                                        <small class="text-muted">Price Accuracy</small>
                                    </div>
                                </div>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Model Performance:</h6>
                                    <ul class="list-unstyled">
                                        <li><strong>Best Model:</strong> <span id="best-model">-</span></li>
                                        <li><strong>Test Period:</strong> <span id="test-period">-</span></li>
                                        <li><strong>Total Predictions:</strong> <span id="total-predictions">-</span></li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6>Recommendation:</h6>
                                    <p id="recommendation" class="mb-0">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Active Trainings Section (Only shown when there are active trainings) -->
<div class="row g-4 mt-2" id="active-trainings-section" style="display: none;">
    <div class="col-12">
        <div class="card hover-lift animate-fade-in-up">
            <div class="card-header bg-gradient-info text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0 text-white">
                        <i class="bi bi-hourglass-split me-2"></i>Active Trainings
                    </h5>
                    <button class="btn btn-light btn-sm" onclick="refreshActiveTrainings()">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-hover mb-0" id="active-trainings-table">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th class="border-0">Symbol</th>
                                <th class="border-0">Model</th>
                                <th class="border-0">Status</th>
                                <th class="border-0">Progress</th>
                                <th class="border-0">Started</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Active trainings will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
// ML Dashboard JavaScript
document.addEventListener('DOMContentLoaded', function() {
    loadMLDashboardData();
    loadActiveTrainings();

    // Training form submission
    document.getElementById('training-form').addEventListener('submit', handleTrainingSubmit);

    // Prediction button
    document.getElementById('predict-btn').addEventListener('click', handlePrediction);

    // Backtest button
    document.getElementById('backtest-btn').addEventListener('click', handleBacktest);

    // Symbol search
    document.getElementById('search-symbol-btn').addEventListener('click', searchSymbol);
});

// Load ML Dashboard Overview Data
async function loadMLDashboardData() {
    try {
        const response = await fetch('/api/v1/ml/overview');

        if (!response.ok) {
            if (response.status === 401) {
                window.location.href = '/login';
                return;
            }
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();

        if (result.success && result.data.models) {
            // Update each model card with data
            result.data.models.forEach(model => {
                const modelType = model.type; // 'traditional', 'raw_lstm', 'kronos'

                // Update stocks count
                const stocksCountEl = document.getElementById(`${modelType}-stocks-count`);
                if (stocksCountEl) {
                    stocksCountEl.innerHTML = model.stocks_trained || 0;
                }

                // Update last trained date
                const lastTrainedEl = document.getElementById(`${modelType}-last-trained`);
                if (lastTrainedEl) {
                    lastTrainedEl.textContent = model.last_trained || 'Never';
                }

                // Update status
                const statusEl = document.getElementById(`${modelType}-status`);
                if (statusEl) {
                    if (model.status === 'trained') {
                        statusEl.className = 'badge bg-success';
                        statusEl.textContent = 'Trained';
                    } else {
                        statusEl.className = 'badge bg-warning';
                        statusEl.textContent = 'Not Trained';
                    }
                }
            });
        }
    } catch (error) {
        console.error('Error loading ML dashboard data:', error);
        // Show error state on all model cards
        ['traditional', 'raw_lstm', 'kronos'].forEach(type => {
            const stocksCountEl = document.getElementById(`${type}-stocks-count`);
            if (stocksCountEl) {
                stocksCountEl.innerHTML = '<span class="text-danger">Error</span>';
            }
            const lastTrainedEl = document.getElementById(`${type}-last-trained`);
            if (lastTrainedEl) {
                lastTrainedEl.textContent = 'Error';
            }
            const statusEl = document.getElementById(`${type}-status`);
            if (statusEl) {
                statusEl.className = 'badge bg-danger';
                statusEl.textContent = 'Error';
            }
        });
    }
}

// Train All Models
async function trainAllModels() {
    const trainBtn = document.getElementById('train-all-btn');
    const originalContent = trainBtn.innerHTML;

    if (!confirm('This will train all 3 ML models (Traditional ML, Raw LSTM, and Kronos). This may take several minutes. Continue?')) {
        return;
    }

    try {
        // Disable button and show loading state
        trainBtn.disabled = true;
        trainBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Training...';

        const response = await fetch('/api/v1/ml/train-all', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            if (response.status === 401) {
                alert('Your session has expired. Please log in again.');
                window.location.href = '/login';
                return;
            }
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();

        if (result.success) {
            // Show success message
            alert('Training started successfully for all 3 models!\n\nThis process will run in the background. The page will refresh in a moment to show updated status.');

            // Update model cards to show "training" status
            ['traditional', 'raw_lstm', 'kronos'].forEach(type => {
                const statusEl = document.getElementById(`${type}-status`);
                if (statusEl) {
                    statusEl.className = 'badge bg-info';
                    statusEl.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Training';
                }
            });

            // Refresh data after 5 seconds
            setTimeout(() => {
                loadMLDashboardData();
            }, 5000);
        } else {
            alert('Failed to start training: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error starting training:', error);
        alert('Failed to start training: Network error');
    } finally {
        // Re-enable button
        trainBtn.disabled = false;
        trainBtn.innerHTML = originalContent;
    }
}

// Load Active Trainings
async function loadActiveTrainings() {
    try {
        const response = await fetch('/api/v1/ml/active-trainings');
        const result = await response.json();

        if (result.success) {
            updateActiveTrainingsTable(result.data);
        } else {
            showActiveTrainingsError();
        }
    } catch (error) {
        console.error('Error loading active trainings:', error);
        showActiveTrainingsError();
    }
}

// Update Active Trainings Table
function updateActiveTrainingsTable(trainings) {
    const tbody = document.querySelector('#active-trainings-table tbody');
    const activeTrainingsSection = document.getElementById('active-trainings-section');

    tbody.innerHTML = '';

    if (trainings.length === 0) {
        // Hide the entire Active Trainings section when no trainings
        activeTrainingsSection.style.display = 'none';
        return;
    }

    // Show the Active Trainings section when there are trainings
    activeTrainingsSection.style.display = 'block';

    trainings.forEach(training => {
        const row = tbody.insertRow();

        // Symbol
        row.insertCell(0).innerHTML = `<strong>${training.symbol}</strong>`;

        // Model type
        const typeCell = row.insertCell(1);
        const typeBadge = getModelTypeBadge(training.model_type);
        typeCell.innerHTML = `<span class="badge ${typeBadge}">${training.model_type}</span>`;

        // Status
        const statusCell = row.insertCell(2);
        const statusBadge = training.status === 'running' ? 'bg-success' : 'bg-warning';
        statusCell.innerHTML = `<span class="badge ${statusBadge}">${training.status}</span>`;

        // Progress
        const progressCell = row.insertCell(3);
        const progress = training.progress || 0;
        progressCell.innerHTML = `
            <div class="progress" style="width: 80px; height: 20px;">
                <div class="progress-bar" role="progressbar"
                     style="width: ${progress}%"
                     aria-valuenow="${progress}"
                     aria-valuemin="0"
                     aria-valuemax="100">
                    ${Math.round(progress)}%
                </div>
            </div>
        `;

        // Started
        row.insertCell(4).innerHTML = `<small class="text-muted">${training.started_at || training.created_at}</small>`;
    });
}

function showActiveTrainingsError() {
    const activeTrainingsSection = document.getElementById('active-trainings-section');
    const tbody = document.querySelector('#active-trainings-table tbody');

    tbody.innerHTML = `
        <tr>
            <td colspan="5" class="text-center text-danger py-4">
                <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
                <br>
                Error loading active trainings
            </td>
        </tr>
    `;

    // Show section even for errors so user can see the error
    activeTrainingsSection.style.display = 'block';
}

// Handle Training Form Submission
async function handleTrainingSubmit(event) {
    event.preventDefault();

    const formData = {
        symbol: document.getElementById('stock-symbol').value,
        model_type: 'ensemble', // Always use ensemble model
        use_technical_indicators: document.getElementById('use-technical-indicators').checked,
        start_date: document.getElementById('start-date').value,
        end_date: document.getElementById('end-date').value
    };

    try {
        showTrainingProgress();

        const response = await fetch('/api/v1/ml/train', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });

        const result = await response.json();

        if (result.success) {
            // Start polling for training progress
            if (result.training_id) {
                pollTrainingProgress(result.training_id);
            } else {
                console.error('Training started but no training_id provided');
                hideTrainingProgress();
                alert('Training started but unable to track progress');
            }
        } else {
            hideTrainingProgress();
            alert('Training failed: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Training error:', error);
        hideTrainingProgress();
        alert('Training failed: Network error');
    }
}

// Handle Stock Prediction
async function handlePrediction() {
    const symbol = document.getElementById('predict-symbol').value;
    const horizon = 1; // Default to 1 day prediction
    const predictBtn = document.getElementById('predict-btn');

    if (!symbol) {
        alert('Please enter a stock symbol');
        return;
    }

    // Show loading spinner
    showPredictionLoading();

    try {
        const response = await fetch('/api/v1/ml/predict', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                symbol: symbol,
                horizon: parseInt(horizon)
            })
        });

        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        
        if (!response.ok) {
            if (response.status === 401) {
                // User is not authenticated, redirect to login
                alert('Your session has expired. Please log in again.');
                window.location.href = '/login';
                return;
            }
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        console.log('Prediction API response:', result);

        if (result.success) {
            // The backend returns prediction data under 'prediction' property
            if (result.prediction) {
                displayPredictionResults(result.prediction);
            } else {
                console.error('No prediction data in response:', result);
                alert('Prediction failed: No prediction data received');
            }
        } else {
            alert('Prediction failed: ' + (result.error || 'Model not found for this symbol'));
        }
    } catch (error) {
        console.error('Prediction error:', error);
        alert('Prediction failed: Network error');
    } finally {
        // Hide loading spinner
        hidePredictionLoading();
    }
}

// Display Prediction Results
function displayPredictionResults(data) {
    console.log('Displaying prediction results with data:', data);
    
    try {
        // Show the prediction results section
        const resultsSection = document.getElementById('prediction-results');
        if (resultsSection) {
            resultsSection.style.display = 'block';
        }

        // Update prediction values using correct property names from API
        const predictedPriceElement = document.getElementById('predicted-price');
        if (predictedPriceElement && data.final_predicted_price) {
            predictedPriceElement.textContent = `₹${parseFloat(data.final_predicted_price).toFixed(2)}`;
        }

        const priceChange = parseFloat(data.predicted_change_percent);
        const priceChangeElement = document.getElementById('price-change');
        if (priceChangeElement) {
            priceChangeElement.textContent = `${priceChange >= 0 ? '+' : ''}${priceChange.toFixed(2)}%`;
            priceChangeElement.className = priceChange >= 0 ? 'text-success' : 'text-danger';
        }

        // Use current price if available, otherwise fall back to last close price
        let currentPrice, priceSource;
        if (data.current_price && data.current_price > 0) {
            currentPrice = parseFloat(data.current_price);
            priceSource = 'Real-time';
        } else {
            currentPrice = parseFloat(data.last_close_price);
            priceSource = 'Last Close';
        }
        
        const currentPriceElement = document.getElementById('current-price');
        if (currentPriceElement) {
            currentPriceElement.textContent = `₹${currentPrice.toFixed(2)}`;
        }
        
        
        // Update the price source label
        const currentPriceLabel = document.querySelector('#current-price').parentElement.querySelector('small');
        if (currentPriceLabel) {
            currentPriceLabel.textContent = `Current Price (${priceSource})`;
        }

        // Calculate confidence based on prediction accuracy (simplified)
        const confidence = Math.max(0, Math.min(100, 100 - Math.abs(priceChange)));
        const confidenceElement = document.getElementById('confidence-score');
        if (confidenceElement) {
            confidenceElement.textContent = `${Math.round(confidence)}%`;
        }

        const signalElement = document.getElementById('signal-strength');
        if (signalElement && data.signal) {
            signalElement.textContent = data.signal;
            signalElement.className = getSignalColor(data.signal);
        }

        // Display individual model predictions if available
        displayIndividualPredictions(data);
    } catch (error) {
        console.error('Error displaying prediction results:', error);
        alert('Error displaying prediction results: ' + error.message);
    }
}

// Utility Functions
function getModelTypeBadge(type) {
    const badges = {
        'ensemble': 'bg-primary',
        'random_forest': 'bg-success',
        'xgboost': 'bg-warning',
        'lstm': 'bg-info'
    };
    return badges[type] || 'bg-secondary';
}

function getSignalColor(signal) {
    const colors = {
        'BUY': 'text-success mb-1',
        'SELL': 'text-danger mb-1',
        'HOLD': 'text-warning mb-1'
    };
    return colors[signal] || 'text-secondary mb-1';
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString();
}

// Prediction Loading Spinner Functions
function showPredictionLoading() {
    const predictBtn = document.getElementById('predict-btn');
    const originalContent = predictBtn.innerHTML;
    
    // Store original content for restoration
    predictBtn.setAttribute('data-original-content', originalContent);
    
    // Show spinner and disable button
    predictBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Predicting...';
    predictBtn.disabled = true;
    
    // Hide prediction results if they exist
    const resultsSection = document.getElementById('prediction-results');
    if (resultsSection) {
        resultsSection.style.display = 'none';
    }
}

function hidePredictionLoading() {
    const predictBtn = document.getElementById('predict-btn');
    const originalContent = predictBtn.getAttribute('data-original-content');
    
    // Restore original content and enable button
    if (originalContent) {
        predictBtn.innerHTML = originalContent;
        predictBtn.removeAttribute('data-original-content');
    } else {
        predictBtn.innerHTML = '<i class="bi bi-magic"></i> Predict';
    }
    predictBtn.disabled = false;
}

function showTrainingProgress() {
    document.getElementById('training-progress').style.display = 'block';
}

function hideTrainingProgress() {
    document.getElementById('training-progress').style.display = 'none';
    document.getElementById('progress-bar').style.width = '0%';
    document.getElementById('progress-percent').textContent = '0%';
}

function pollTrainingProgress(trainingId) {
    // Validate trainingId
    if (!trainingId || trainingId === 'undefined') {
        console.error('Invalid training ID provided:', trainingId);
        hideTrainingProgress();
        alert('Unable to track training progress: Invalid training ID');
        return;
    }

    const progressBar = document.getElementById('progress-bar');
    const progressStatus = document.getElementById('progress-status');
    const progressPercent = document.getElementById('progress-percent');

    let pollInterval;
    let attempts = 0;
    const maxAttempts = 300; // 5 minutes at 1-second intervals

    async function checkProgress() {
        attempts++;

        try {
            const response = await fetch(`/api/v1/ml/training_progress/${trainingId}`);
            
            if (!response.ok) {
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const result = await response.json();

            if (result.success && result.data) {
                const data = result.data;
                const progress = Math.round(data.progress || 0);

                // Update progress bar
                progressBar.style.width = `${progress}%`;
                progressPercent.textContent = `${progress}%`;

                // Update status message
                if (data.status === 'running') {
                    progressStatus.textContent = `Training ${data.symbol}...`;
                    progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-info';
                } else if (data.status === 'completed') {
                    progressStatus.textContent = `Training completed successfully for ${data.symbol}!`;
                    progressBar.className = 'progress-bar bg-success';

                    // Stop polling
                    clearInterval(pollInterval);

                    // Show training results if available
                    if (data.training_results) {
                        displayTrainingResults(data.training_results);
                    }

                    // Hide progress after 3 seconds and refresh data
                    setTimeout(() => {
                        hideTrainingProgress();
                        loadMLDashboardData();
                        loadActiveTrainings();
                        loadTrainedModels();
                    }, 3000);

                    return;
                } else if (data.status === 'failed') {
                    progressStatus.textContent = `Training failed: ${data.error_message || 'Unknown error'}`;
                    progressBar.className = 'progress-bar bg-danger';

                    // Stop polling
                    clearInterval(pollInterval);

                    // Hide progress after 5 seconds
                    setTimeout(() => {
                        hideTrainingProgress();
                        loadMLDashboardData();
                        loadActiveTrainings();
                    }, 5000);

                    return;
                } else if (data.status === 'pending') {
                    progressStatus.textContent = `Training job queued for ${data.symbol}...`;
                    progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-warning';
                }

                // Continue polling if still in progress
                if (progress >= 100 || data.status === 'completed') {
                    clearInterval(pollInterval);
                }

            } else {
                console.error('Failed to get training progress:', result.error);
                if (attempts >= 3) {
                    progressStatus.textContent = 'Error checking training progress';
                    progressBar.className = 'progress-bar bg-warning';
                }
            }

        } catch (error) {
            console.error('Error polling training progress:', error);
            if (attempts >= 3) {
                progressStatus.textContent = 'Network error checking progress';
                progressBar.className = 'progress-bar bg-warning';
            }
        }

        // Stop polling after max attempts (5 minutes)
        if (attempts >= maxAttempts) {
            clearInterval(pollInterval);
            progressStatus.textContent = 'Training timeout - check Active Trainings for status';
            progressBar.className = 'progress-bar bg-secondary';

            setTimeout(() => {
                hideTrainingProgress();
                loadActiveTrainings();
            }, 3000);
        }
    }

    // Start polling immediately and then every second
    checkProgress();
    pollInterval = setInterval(checkProgress, 1000);
}

function refreshTrainedModels() {
    loadTrainedModels();
}

function refreshActiveTrainings() {
    loadActiveTrainings();
}

function predictStock(symbol) {
    document.getElementById('predict-symbol').value = symbol;
    document.getElementById('predict-btn').click();
}

function viewModelDetails(modelId) {
    // Implement model details view
    alert('Model details for ID: ' + modelId);
}

function deleteModel(modelId) {
    if (confirm('Are you sure you want to delete this model?')) {
        // Implement model deletion
        alert('Delete model ID: ' + modelId);
    }
}

// Handle Backtesting
async function handleBacktest() {
    const symbol = document.getElementById('predict-symbol').value;
    const backtestBtn = document.getElementById('backtest-btn');

    if (!symbol) {
        alert('Please enter a stock symbol first');
        return;
    }

    // Show loading state
    showBacktestLoading();

    try {
        const response = await fetch('/api/v1/ml/backtest', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                symbol: symbol,
                test_period_days: 30  // Test on last 30 days
            })
        });

        if (!response.ok) {
            if (response.status === 401) {
                alert('Your session has expired. Please log in again.');
                window.location.href = '/login';
                return;
            }
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();

        if (result.success) {
            displayBacktestResults(result);
        } else {
            alert('Backtesting failed: ' + result.error);
        }

    } catch (error) {
        console.error('Backtesting error:', error);
        alert('Backtesting failed: Network error');
    } finally {
        hideBacktestLoading();
    }
}

function displayBacktestResults(result) {
    console.log('Displaying backtest results:', result);
    
    const resultsSection = document.getElementById('backtest-results');
    if (resultsSection) {
        resultsSection.style.display = 'block';
    }

    const summary = result.summary;
    const metrics = result.metrics;

    // Update trust score with color coding
    const trustScoreElement = document.getElementById('trust-score');
    if (trustScoreElement) {
        trustScoreElement.textContent = summary.trust_score;
        trustScoreElement.className = `mb-1 text-${summary.trust_color}`;
    }

    // Update signal accuracy
    const signalAccuracyElement = document.getElementById('signal-accuracy');
    if (signalAccuracyElement) {
        signalAccuracyElement.textContent = `${summary.ensemble_accuracy}%`;
    }

    // Update price accuracy (using MAPE - lower is better)
    const priceAccuracyElement = document.getElementById('price-accuracy');
    if (priceAccuracyElement) {
        const priceAccuracy = Math.max(0, 100 - summary.ensemble_mape);
        priceAccuracyElement.textContent = `${priceAccuracy.toFixed(1)}%`;
    }

    // Update model performance details
    const bestModelElement = document.getElementById('best-model');
    if (bestModelElement) {
        bestModelElement.textContent = summary.best_model.replace('_model', '').toUpperCase();
    }

    const testPeriodElement = document.getElementById('test-period');
    if (testPeriodElement) {
        testPeriodElement.textContent = summary.test_period;
    }

    const totalPredictionsElement = document.getElementById('total-predictions');
    if (totalPredictionsElement) {
        totalPredictionsElement.textContent = metrics.total_predictions;
    }

    const recommendationElement = document.getElementById('recommendation');
    if (recommendationElement) {
        recommendationElement.textContent = summary.recommendation;
    }
}

function showBacktestLoading() {
    const backtestBtn = document.getElementById('backtest-btn');
    const originalContent = backtestBtn.innerHTML;
    
    // Store original content for restoration
    backtestBtn.setAttribute('data-original-content', originalContent);
    
    // Show spinner and disable button
    backtestBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Testing...';
    backtestBtn.disabled = true;
    
    // Hide previous results
    const resultsSection = document.getElementById('backtest-results');
    if (resultsSection) {
        resultsSection.style.display = 'none';
    }
}

function hideBacktestLoading() {
    const backtestBtn = document.getElementById('backtest-btn');
    const originalContent = backtestBtn.getAttribute('data-original-content');
    
    // Restore original content and enable button
    if (originalContent) {
        backtestBtn.innerHTML = originalContent;
    } else {
        backtestBtn.innerHTML = '<i class="bi bi-shield-check"></i> Test Model';
    }
    backtestBtn.disabled = false;
}

async function searchSymbol() {
    const symbolInput = document.getElementById('stock-symbol');
    const symbol = symbolInput.value.trim();

    if (!symbol) {
        alert('Please enter a stock symbol');
        return;
    }

    const searchBtn = document.getElementById('search-symbol-btn');
    const originalText = searchBtn.innerHTML;
    searchBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    searchBtn.disabled = true;

    try {
        const response = await fetch('/api/v1/ml/validate_symbol', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ symbol: symbol })
        });

        const result = await response.json();

        if (result.success) {
            if (result.valid) {
                // Symbol is valid
                symbolInput.classList.remove('is-invalid');
                symbolInput.classList.add('is-valid');

                // Show success message
                showSymbolValidationMessage(result.message, 'success');

                // If Fyers data is available, show options
                if (result.fyers_data && result.fyers_data.length > 0) {
                    showSymbolOptions(result.fyers_data, symbolInput);
                }
            } else {
                // Symbol is invalid
                symbolInput.classList.remove('is-valid');
                symbolInput.classList.add('is-invalid');
                showSymbolValidationMessage(result.message, 'danger');
            }
        } else {
            symbolInput.classList.remove('is-valid');
            symbolInput.classList.add('is-invalid');
            showSymbolValidationMessage('Symbol validation failed', 'danger');
        }
    } catch (error) {
        console.error('Symbol validation error:', error);
        symbolInput.classList.remove('is-valid');
        symbolInput.classList.add('is-invalid');
        showSymbolValidationMessage('Network error during validation', 'danger');
    } finally {
        searchBtn.innerHTML = originalText;
        searchBtn.disabled = false;
    }
}

function showSymbolValidationMessage(message, type) {
    // Remove any existing validation message
    const existingAlert = document.querySelector('#symbol-validation-alert');
    if (existingAlert) {
        existingAlert.remove();
    }

    // Create and show new message
    const alertDiv = document.createElement('div');
    alertDiv.id = 'symbol-validation-alert';
    alertDiv.className = `alert alert-${type} alert-dismissible fade show mt-2`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    // Insert after the input group
    const inputGroup = document.querySelector('#stock-symbol').closest('.mb-3');
    inputGroup.appendChild(alertDiv);

    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv && alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

function showSymbolOptions(fyersData, symbolInput) {
    // Create dropdown with symbol options
    let dropdownDiv = document.getElementById('symbol-dropdown');

    if (!dropdownDiv) {
        dropdownDiv = document.createElement('div');
        dropdownDiv.id = 'symbol-dropdown';
        dropdownDiv.className = 'dropdown-menu show position-absolute w-100 mt-1';
        dropdownDiv.style.maxHeight = '200px';
        dropdownDiv.style.overflowY = 'auto';
        dropdownDiv.style.zIndex = '1050';

        const inputGroup = symbolInput.closest('.input-group');
        inputGroup.style.position = 'relative';
        inputGroup.appendChild(dropdownDiv);
    }

    dropdownDiv.innerHTML = '';

    fyersData.forEach(item => {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'dropdown-item';
        optionDiv.style.cursor = 'pointer';
        optionDiv.innerHTML = `
            <div>
                <strong>${item.symbol || item.trading_symbol}</strong>
                <br>
                <small class="text-muted">${item.company_name || item.name || ''}</small>
            </div>
        `;

        optionDiv.addEventListener('click', function() {
            symbolInput.value = item.symbol || item.trading_symbol;
            symbolInput.classList.remove('is-invalid');
            symbolInput.classList.add('is-valid');
            dropdownDiv.remove();
        });

        dropdownDiv.appendChild(optionDiv);
    });

    // Hide dropdown when clicking outside
    document.addEventListener('click', function hideDropdown(e) {
        if (!dropdownDiv.contains(e.target) && !symbolInput.contains(e.target)) {
            dropdownDiv.remove();
            document.removeEventListener('click', hideDropdown);
        }
    });
}

function showTrainedModelsError() {
    const tbody = document.querySelector('#trained-models-table tbody');
    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-warning">Error loading models</td></tr>';
}

// Training Results Display Functions
function displayTrainingResults(results) {
    console.log('Displaying training results:', results);

    const resultsSection = document.getElementById('training-results');
    if (!resultsSection) return;

    // Update basic training info
    const trainedSymbolElement = document.getElementById('trained-symbol');
    if (trainedSymbolElement) {
        trainedSymbolElement.textContent = results.symbol || '-';
    }

    const trainedModelsElement = document.getElementById('trained-models');
    if (trainedModelsElement && results.models_saved) {
        trainedModelsElement.textContent = results.models_saved.join(', ');
    }

    const trainingPeriodElement = document.getElementById('training-period');
    if (trainingPeriodElement && results.training_period) {
        const period = results.training_period;
        trainingPeriodElement.textContent = `${period.start_date} to ${period.end_date}`;
    }

    // Display backtesting results if available
    if (results.backtesting && results.backtesting.success) {
        displayAutoBacktestResults(results.backtesting);
    }

    // Show the results section
    resultsSection.style.display = 'block';
}

function displayAutoBacktestResults(backtestData) {
    console.log('Displaying auto backtest results:', backtestData);

    const autoBacktestSection = document.getElementById('auto-backtest-results');
    if (!autoBacktestSection) return;

    const summary = backtestData.summary;
    if (!summary) return;

    // Update trust score with color coding
    const autoTrustScoreElement = document.getElementById('auto-trust-score');
    if (autoTrustScoreElement) {
        autoTrustScoreElement.textContent = summary.trust_score || '-';
        autoTrustScoreElement.className = `mb-1 text-${summary.trust_color || 'secondary'}`;
    }

    // Update signal accuracy
    const autoSignalAccuracyElement = document.getElementById('auto-signal-accuracy');
    if (autoSignalAccuracyElement) {
        autoSignalAccuracyElement.textContent = `${summary.ensemble_accuracy || 0}%`;
    }

    // Update best model
    const autoBestModelElement = document.getElementById('auto-best-model');
    if (autoBestModelElement) {
        const bestModel = summary.best_model ? summary.best_model.replace('_model', '').toUpperCase() : '-';
        autoBestModelElement.textContent = bestModel;
    }

    // Update test period
    const autoTestPeriodElement = document.getElementById('auto-test-period');
    if (autoTestPeriodElement) {
        autoTestPeriodElement.textContent = summary.test_period || '-';
    }

    // Update recommendation
    const autoRecommendationElement = document.getElementById('auto-recommendation');
    if (autoRecommendationElement) {
        autoRecommendationElement.textContent = summary.recommendation || '-';
    }

    // Show the auto backtest results
    autoBacktestSection.style.display = 'block';
}

function hideTrainingResults() {
    const resultsSection = document.getElementById('training-results');
    if (resultsSection) {
        resultsSection.style.display = 'none';
    }

    // Also hide the auto backtest section
    const autoBacktestSection = document.getElementById('auto-backtest-results');
    if (autoBacktestSection) {
        autoBacktestSection.style.display = 'none';
    }
}

function displayIndividualPredictions(data) {
    // Update Traditional ML prediction (RF + XGBoost)
    const traditionalElement = document.getElementById('traditional-prediction');
    if (traditionalElement) {
        if (data.rf_predicted_price && data.xgb_predicted_price) {
            // Average of RF and XGBoost
            const traditionalPrice = (parseFloat(data.rf_predicted_price) + parseFloat(data.xgb_predicted_price)) / 2;
            traditionalElement.textContent = `₹${traditionalPrice.toFixed(2)}`;
        } else if (data.final_predicted_price) {
            // Fallback to final prediction
            traditionalElement.textContent = `₹${parseFloat(data.final_predicted_price).toFixed(2)}`;
        } else {
            traditionalElement.textContent = 'N/A';
        }
    }

    // Update Raw LSTM prediction
    const lstmElement = document.getElementById('lstm-prediction');
    if (lstmElement) {
        if (data.lstm_predicted_price) {
            lstmElement.textContent = `₹${parseFloat(data.lstm_predicted_price).toFixed(2)}`;
        } else {
            lstmElement.textContent = 'N/A';
        }
    }

    // Update Kronos prediction
    const kronosElement = document.getElementById('kronos-prediction');
    if (kronosElement) {
        if (data.kronos_predicted_price) {
            kronosElement.textContent = `₹${parseFloat(data.kronos_predicted_price).toFixed(2)}`;
        } else {
            kronosElement.textContent = 'N/A';
        }
    }
}
</script>
{% endblock %}