{% extends "base.html" %}

{% block title %}Suggested Stocks - Dual Model View{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="card hover-lift animate-fade-in-up mb-4">
    <div class="card-header bg-gradient-info text-white">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h5 class="card-title mb-0 text-white">
                    <i class="bi bi-graph-up-arrow me-2"></i>Stock Suggestions - Dual Model Comparison
                </h5>
                <small class="opacity-75">Compare Traditional ML vs Research-Based Raw LSTM predictions</small>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-light btn-sm" id="refresh-btn">
                    <i class="bi bi-arrow-repeat"></i> Refresh
                </button>
            </div>
        </div>
    </div>
    <div class="card-body bg-light">
        <div class="row text-center">
            <div class="col-md-3">
                <div class="card border-primary h-100">
                    <div class="card-body">
                        <h6 class="text-primary mb-2">üèõÔ∏è Traditional Model</h6>
                        <small class="text-muted">Feature-Engineered<br>RF + XGB + LSTM</small>
                        <h4 class="mt-2 mb-0" id="trad-count">-</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-success h-100">
                    <div class="card-body">
                        <h6 class="text-success mb-2">ü§ñ Raw LSTM Model</h6>
                        <small class="text-muted">Research-Based<br>Raw OHLCV Only</small>
                        <h4 class="mt-2 mb-0" id="lstm-count">-</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-info h-100">
                    <div class="card-body">
                        <h6 class="text-info mb-2">üõ°Ô∏è Default Risk</h6>
                        <small class="text-muted">Conservative<br>5-7% Targets</small>
                        <h4 class="mt-2 mb-0" id="default-count">-</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-warning h-100">
                    <div class="card-body">
                        <h6 class="text-warning mb-2">‚ö° High Risk</h6>
                        <small class="text-muted">Aggressive<br>8-10% Targets</small>
                        <h4 class="mt-2 mb-0" id="high-count">-</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Dual Model Comparison -->
<div class="row">
    <!-- Traditional Model -->
    <div class="col-lg-6 mb-4">
        <div class="card hover-lift animate-fade-in-up h-100">
            <div class="card-header bg-gradient-primary text-white">
                <h5 class="card-title mb-0 text-white">
                    <i class="bi bi-layers me-2"></i>Traditional Model
                    <small class="d-block mt-1 opacity-75">Feature-Engineered Ensemble (70+ indicators)</small>
                </h5>
            </div>
            <div class="card-body">
                <!-- Tabs for Risk Levels -->
                <ul class="nav nav-tabs mb-3" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#trad-default">
                            <i class="bi bi-shield-check text-success"></i> Default Risk
                            <span class="badge bg-secondary ms-2" id="trad-default-badge">0</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#trad-high">
                            <i class="bi bi-lightning-charge text-warning"></i> High Risk
                            <span class="badge bg-secondary ms-2" id="trad-high-badge">0</span>
                        </a>
                    </li>
                </ul>

                <div class="tab-content">
                    <!-- Traditional - Default Risk -->
                    <div class="tab-pane fade show active" id="trad-default">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm" id="traditional-default-table">
                                <thead class="table-light">
                                    <tr>
                                        <th>#</th>
                                        <th>Symbol</th>
                                        <th>Company</th>
                                        <th>Score</th>
                                        <th>Target</th>
                                        <th>Rec</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Traditional - High Risk -->
                    <div class="tab-pane fade" id="trad-high">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm" id="traditional-high-table">
                                <thead class="table-light">
                                    <tr>
                                        <th>#</th>
                                        <th>Symbol</th>
                                        <th>Company</th>
                                        <th>Score</th>
                                        <th>Target</th>
                                        <th>Rec</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Raw LSTM Model -->
    <div class="col-lg-6 mb-4">
        <div class="card hover-lift animate-fade-in-up h-100">
            <div class="card-header bg-gradient-success text-white">
                <h5 class="card-title mb-0 text-white">
                    <i class="bi bi-robot me-2"></i>Raw LSTM Model
                    <small class="d-block mt-1 opacity-75">Research-Based Raw OHLCV (5 features only)</small>
                </h5>
            </div>
            <div class="card-body">
                <!-- Tabs for Risk Levels -->
                <ul class="nav nav-tabs mb-3" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#lstm-default">
                            <i class="bi bi-shield-check text-success"></i> Default Risk
                            <span class="badge bg-secondary ms-2" id="lstm-default-badge">0</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#lstm-high">
                            <i class="bi bi-lightning-charge text-warning"></i> High Risk
                            <span class="badge bg-secondary ms-2" id="lstm-high-badge">0</span>
                        </a>
                    </li>
                </ul>

                <div class="tab-content">
                    <!-- Raw LSTM - Default Risk -->
                    <div class="tab-pane fade show active" id="lstm-default">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm" id="lstm-default-table">
                                <thead class="table-light">
                                    <tr>
                                        <th>#</th>
                                        <th>Symbol</th>
                                        <th>Company</th>
                                        <th>Score</th>
                                        <th>Target</th>
                                        <th>Rec</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Raw LSTM - High Risk -->
                    <div class="tab-pane fade" id="lstm-high">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm" id="lstm-high-table">
                                <thead class="table-light">
                                    <tr>
                                        <th>#</th>
                                        <th>Symbol</th>
                                        <th>Company</th>
                                        <th>Score</th>
                                        <th>Target</th>
                                        <th>Rec</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Section -->
<div class="card hover-lift animate-fade-in-up">
    <div class="card-header bg-gradient-dark text-white">
        <h5 class="card-title mb-0 text-white">
            <i class="bi bi-bar-chart-line me-2"></i>Model Statistics
        </h5>
    </div>
    <div class="card-body">
        <div class="row text-center">
            <div class="col-md-3">
                <h6 class="text-primary">Traditional - Default</h6>
                <p class="mb-1">Avg Score: <strong id="trad-default-avg">-</strong></p>
                <p class="mb-0">Avg Confidence: <strong id="trad-default-conf">-</strong></p>
            </div>
            <div class="col-md-3">
                <h6 class="text-primary">Traditional - High</h6>
                <p class="mb-1">Avg Score: <strong id="trad-high-avg">-</strong></p>
                <p class="mb-0">Avg Confidence: <strong id="trad-high-conf">-</strong></p>
            </div>
            <div class="col-md-3">
                <h6 class="text-success">Raw LSTM - Default</h6>
                <p class="mb-1">Avg Score: <strong id="lstm-default-avg">-</strong></p>
                <p class="mb-0">Avg Confidence: <strong id="lstm-default-conf">-</strong></p>
            </div>
            <div class="col-md-3">
                <h6 class="text-success">Raw LSTM - High</h6>
                <p class="mb-1">Avg Score: <strong id="lstm-high-avg">-</strong></p>
                <p class="mb-0">Avg Confidence: <strong id="lstm-high-conf">-</strong></p>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Global data storage
    let dualModelData = null;
    let statistics = null;

    // Fetch dual model view from new API endpoint
    async function fetchDualModelView() {
        try {
            showLoadingState();

            // Call the NEW dual-model-view endpoint
            const response = await fetch('/api/suggested-stocks/dual-model-view?limit=10', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin'
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            if (data.success) {
                dualModelData = data.data;
                statistics = data.statistics;

                // Populate all 4 tables
                populateTable('traditional-default-table', dualModelData.traditional.default_risk, 'primary');
                populateTable('traditional-high-table', dualModelData.traditional.high_risk, 'primary');
                populateTable('lstm-default-table', dualModelData.raw_lstm.default_risk, 'success');
                populateTable('lstm-high-table', dualModelData.raw_lstm.high_risk, 'success');

                // Update statistics
                updateStatistics();

                console.log('‚úÖ Dual model data loaded successfully');
                console.log('Traditional Default:', dualModelData.traditional.default_risk.length);
                console.log('Traditional High:', dualModelData.traditional.high_risk.length);
                console.log('Raw LSTM Default:', dualModelData.raw_lstm.default_risk.length);
                console.log('Raw LSTM High:', dualModelData.raw_lstm.high_risk.length);
            } else {
                throw new Error(data.error || 'Failed to fetch dual model view');
            }

        } catch (error) {
            console.error('Error fetching dual model view:', error);
            showError(error.message);
        } finally {
            hideLoadingState();
        }
    }

    // Populate a table with stock data
    function populateTable(tableId, stocks, colorTheme = 'primary') {
        const table = document.getElementById(tableId);
        const tbody = table.getElementsByTagName('tbody')[0];
        tbody.innerHTML = '';

        if (stocks.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted py-4">
                        <i class="bi bi-info-circle me-2"></i>No predictions available yet
                    </td>
                </tr>
            `;
            return;
        }

        stocks.forEach((stock, index) => {
            const row = tbody.insertRow();

            // Rank
            const rankCell = row.insertCell(0);
            rankCell.textContent = index + 1;
            rankCell.className = 'text-muted';

            // Symbol
            const symbolCell = row.insertCell(1);
            symbolCell.innerHTML = `<strong>${stock.symbol || 'N/A'}</strong>`;

            // Company name (truncated)
            const nameCell = row.insertCell(2);
            const companyName = stock.stock_name || 'N/A';
            nameCell.textContent = companyName.length > 20 ? companyName.substring(0, 20) + '...' : companyName;
            nameCell.title = companyName; // Full name on hover

            // ML Score
            const scoreCell = row.insertCell(3);
            const score = (stock.ml_prediction_score || 0) * 100;
            scoreCell.textContent = score.toFixed(1) + '%';
            scoreCell.className = score > 60 ? 'text-success fw-bold' : score > 40 ? 'text-warning' : 'text-danger';

            // Target Price
            const targetCell = row.insertCell(4);
            targetCell.textContent = '‚Çπ' + (stock.ml_price_target || 0).toFixed(2);
            targetCell.className = 'text-primary';

            // Recommendation
            const recCell = row.insertCell(5);
            const rec = stock.recommendation || 'HOLD';
            const recColor = rec === 'BUY' ? 'success' : rec === 'SELL' ? 'danger' : 'secondary';
            recCell.innerHTML = `<span class="badge bg-${recColor}">${rec}</span>`;
        });

        // Update badge count
        const badgeId = tableId.replace('-table', '-badge');
        const badge = document.getElementById(badgeId);
        if (badge) {
            badge.textContent = stocks.length;
            badge.className = stocks.length > 0 ? 'badge bg-success ms-2' : 'badge bg-secondary ms-2';
        }
    }

    // Update statistics display
    function updateStatistics() {
        if (!statistics) return;

        // Traditional - Default Risk
        updateStatElement('trad-default-avg', statistics.traditional.default_risk.avg_score);
        updateStatElement('trad-default-conf', statistics.traditional.default_risk.avg_confidence);
        document.getElementById('trad-default-badge').textContent = statistics.traditional.default_risk.count;

        // Traditional - High Risk
        updateStatElement('trad-high-avg', statistics.traditional.high_risk.avg_score);
        updateStatElement('trad-high-conf', statistics.traditional.high_risk.avg_confidence);
        document.getElementById('trad-high-badge').textContent = statistics.traditional.high_risk.count;

        // Raw LSTM - Default Risk
        updateStatElement('lstm-default-avg', statistics.raw_lstm.default_risk.avg_score);
        updateStatElement('lstm-default-conf', statistics.raw_lstm.default_risk.avg_confidence);
        document.getElementById('lstm-default-badge').textContent = statistics.raw_lstm.default_risk.count;

        // Raw LSTM - High Risk
        updateStatElement('lstm-high-avg', statistics.raw_lstm.high_risk.avg_score);
        updateStatElement('lstm-high-conf', statistics.raw_lstm.high_risk.avg_confidence);
        document.getElementById('lstm-high-badge').textContent = statistics.raw_lstm.high_risk.count;

        // Update header counts
        const tradTotal = statistics.traditional.default_risk.count + statistics.traditional.high_risk.count;
        const lstmTotal = statistics.raw_lstm.default_risk.count + statistics.raw_lstm.high_risk.count;
        const defaultTotal = statistics.traditional.default_risk.count + statistics.raw_lstm.default_risk.count;
        const highTotal = statistics.traditional.high_risk.count + statistics.raw_lstm.high_risk.count;

        document.getElementById('trad-count').textContent = tradTotal;
        document.getElementById('lstm-count').textContent = lstmTotal;
        document.getElementById('default-count').textContent = defaultTotal;
        document.getElementById('high-count').textContent = highTotal;
    }

    // Update a single statistic element
    function updateStatElement(elementId, value) {
        const element = document.getElementById(elementId);
        if (element) {
            element.textContent = value ? (value * 100).toFixed(1) + '%' : 'N/A';
        }
    }

    // Show loading state
    function showLoadingState() {
        const tables = ['traditional-default-table', 'traditional-high-table',
                       'lstm-default-table', 'lstm-high-table'];

        tables.forEach(tableId => {
            const table = document.getElementById(tableId);
            const tbody = table.getElementsByTagName('tbody')[0];
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4">
                        <div class="spinner-border text-primary spinner-border-sm" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="mt-2 small">Loading predictions...</div>
                    </td>
                </tr>
            `;
        });
    }

    // Hide loading state
    function hideLoadingState() {
        // Loading will be replaced by actual data or error message
    }

    // Show error message
    function showError(message) {
        const tables = ['traditional-default-table', 'traditional-high-table',
                       'lstm-default-table', 'lstm-high-table'];

        tables.forEach(tableId => {
            const table = document.getElementById(tableId);
            const tbody = table.getElementsByTagName('tbody')[0];
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-danger py-4">
                        <i class="bi bi-exclamation-triangle me-2"></i>${message}
                    </td>
                </tr>
            `;
        });
    }

    // Event listeners
    document.getElementById('refresh-btn').addEventListener('click', fetchDualModelView);

    // Initialize page when loaded
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üìä Initializing Dual Model View...');
        fetchDualModelView();
    });
</script>
{% endblock %}
