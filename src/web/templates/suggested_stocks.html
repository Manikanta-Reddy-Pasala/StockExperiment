{% extends "base.html" %}

{% block title %}Suggested Stocks - Dual Model View{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="card hover-lift animate-fade-in-up mb-4">
    <div class="card-header bg-gradient-info text-white">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h5 class="card-title mb-0 text-white">
                    <i class="bi bi-graph-up-arrow me-2"></i>Stock Suggestions - Dual Model Comparison
                </h5>
                <small class="opacity-75">Compare Traditional ML vs Research-Based Raw LSTM predictions</small>
                <div class="mt-1">
                    <small class="badge bg-light text-dark" id="data-date-badge">Loading...</small>
                </div>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-light btn-sm" id="refresh-btn">
                    <i class="bi bi-arrow-repeat"></i> Refresh
                </button>
            </div>
        </div>
    </div>
    <div class="card-body bg-light">
        <div class="row text-center">
            <div class="col-md-3">
                <div class="card border-primary h-100">
                    <div class="card-body">
                        <h6 class="text-primary mb-2">üèõÔ∏è Traditional Model</h6>
                        <small class="text-muted">Feature-Engineered<br>RF + XGB + LSTM</small>
                        <h4 class="mt-2 mb-0" id="trad-count">-</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-success h-100">
                    <div class="card-body">
                        <h6 class="text-success mb-2">ü§ñ Raw LSTM Model</h6>
                        <small class="text-muted">Research-Based<br>Raw OHLCV Only</small>
                        <h4 class="mt-2 mb-0" id="lstm-count">-</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-info h-100">
                    <div class="card-body">
                        <h6 class="text-info mb-2">üõ°Ô∏è Default Risk</h6>
                        <small class="text-muted">Conservative<br>5-7% Targets</small>
                        <h4 class="mt-2 mb-0" id="default-count">-</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-warning h-100">
                    <div class="card-body">
                        <h6 class="text-warning mb-2">‚ö° High Risk</h6>
                        <small class="text-muted">Aggressive<br>8-10% Targets</small>
                        <h4 class="mt-2 mb-0" id="high-count">-</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Dual Model Comparison -->
<div class="row">
    <!-- Traditional Model -->
    <div class="col-lg-6 mb-4">
        <div class="card hover-lift animate-fade-in-up h-100">
            <div class="card-header bg-gradient-primary text-white">
                <h5 class="card-title mb-0 text-white">
                    <i class="bi bi-layers me-2"></i>Traditional Model
                    <small class="d-block mt-1 opacity-75">Feature-Engineered Ensemble (70+ indicators)</small>
                </h5>
            </div>
            <div class="card-body">
                <!-- Tabs for Risk Levels -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <ul class="nav nav-tabs mb-0 flex-grow-1" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#trad-default">
                                <i class="bi bi-shield-check text-success"></i> Default Risk
                                <span class="badge bg-secondary ms-2" id="trad-default-badge">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#trad-high">
                                <i class="bi bi-lightning-charge text-warning"></i> High Risk
                                <span class="badge bg-secondary ms-2" id="trad-high-badge">0</span>
                            </a>
                        </li>
                    </ul>
                    <button class="btn btn-sm btn-primary ms-2" onclick="buyAllStocks('traditional', 'default_risk')" id="buy-all-trad">
                        <i class="bi bi-cart-plus-fill"></i> Buy All
                    </button>
                </div>

                <div class="tab-content">
                    <!-- Traditional - Default Risk -->
                    <div class="tab-pane fade show active" id="trad-default">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm" id="traditional-default-table">
                                <thead class="table-light">
                                    <tr>
                                        <th>#</th>
                                        <th>Symbol</th>
                                        <th>Company</th>
                                        <th>Score</th>
                                        <th>Target</th>
                                        <th>Rec</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Traditional - High Risk -->
                    <div class="tab-pane fade" id="trad-high">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm" id="traditional-high-table">
                                <thead class="table-light">
                                    <tr>
                                        <th>#</th>
                                        <th>Symbol</th>
                                        <th>Company</th>
                                        <th>Score</th>
                                        <th>Target</th>
                                        <th>Rec</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Raw LSTM Model -->
    <div class="col-lg-6 mb-4">
        <div class="card hover-lift animate-fade-in-up h-100">
            <div class="card-header bg-gradient-success text-white">
                <h5 class="card-title mb-0 text-white">
                    <i class="bi bi-robot me-2"></i>Raw LSTM Model
                    <small class="d-block mt-1 opacity-75">Research-Based Raw OHLCV (5 features only)</small>
                </h5>
            </div>
            <div class="card-body">
                <!-- Tabs for Risk Levels -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <ul class="nav nav-tabs mb-0 flex-grow-1" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#lstm-default">
                                <i class="bi bi-shield-check text-success"></i> Default Risk
                                <span class="badge bg-secondary ms-2" id="lstm-default-badge">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#lstm-high">
                                <i class="bi bi-lightning-charge text-warning"></i> High Risk
                                <span class="badge bg-secondary ms-2" id="lstm-high-badge">0</span>
                            </a>
                        </li>
                    </ul>
                    <button class="btn btn-sm btn-success ms-2" onclick="buyAllStocks('raw_lstm', 'default_risk')" id="buy-all-lstm">
                        <i class="bi bi-cart-plus-fill"></i> Buy All
                    </button>
                </div>

                <div class="tab-content">
                    <!-- Raw LSTM - Default Risk -->
                    <div class="tab-pane fade show active" id="lstm-default">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm" id="lstm-default-table">
                                <thead class="table-light">
                                    <tr>
                                        <th>#</th>
                                        <th>Symbol</th>
                                        <th>Company</th>
                                        <th>Score</th>
                                        <th>Target</th>
                                        <th>Rec</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Raw LSTM - High Risk -->
                    <div class="tab-pane fade" id="lstm-high">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm" id="lstm-high-table">
                                <thead class="table-light">
                                    <tr>
                                        <th>#</th>
                                        <th>Symbol</th>
                                        <th>Company</th>
                                        <th>Score</th>
                                        <th>Target</th>
                                        <th>Rec</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Section -->
<div class="card hover-lift animate-fade-in-up">
    <div class="card-header bg-gradient-dark text-white">
        <h5 class="card-title mb-0 text-white">
            <i class="bi bi-bar-chart-line me-2"></i>Model Statistics
        </h5>
    </div>
    <div class="card-body">
        <div class="row text-center">
            <div class="col-md-3">
                <h6 class="text-primary">Traditional - Default</h6>
                <p class="mb-1">Avg Score: <strong id="trad-default-avg">-</strong></p>
                <p class="mb-0">Avg Confidence: <strong id="trad-default-conf">-</strong></p>
            </div>
            <div class="col-md-3">
                <h6 class="text-primary">Traditional - High</h6>
                <p class="mb-1">Avg Score: <strong id="trad-high-avg">-</strong></p>
                <p class="mb-0">Avg Confidence: <strong id="trad-high-conf">-</strong></p>
            </div>
            <div class="col-md-3">
                <h6 class="text-success">Raw LSTM - Default</h6>
                <p class="mb-1">Avg Score: <strong id="lstm-default-avg">-</strong></p>
                <p class="mb-0">Avg Confidence: <strong id="lstm-default-conf">-</strong></p>
            </div>
            <div class="col-md-3">
                <h6 class="text-success">Raw LSTM - High</h6>
                <p class="mb-1">Avg Score: <strong id="lstm-high-avg">-</strong></p>
                <p class="mb-0">Avg Confidence: <strong id="lstm-high-conf">-</strong></p>
            </div>
        </div>
    </div>
</div>

<!-- Buy Order Modal -->
<div class="modal fade" id="buyOrderModal" tabindex="-1" aria-labelledby="buyOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="buyOrderModalLabel">
                    <i class="bi bi-cart-plus me-2"></i>Place Mock Order
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <h6 class="text-primary mb-3" id="modal-stock-name">Stock Name</h6>
                </div>

                <div class="row mb-3">
                    <div class="col-6">
                        <label class="form-label fw-bold">Model</label>
                        <p class="mb-0" id="modal-model"></p>
                    </div>
                    <div class="col-6">
                        <label class="form-label fw-bold">Strategy</label>
                        <p class="mb-0" id="modal-strategy"></p>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-6">
                        <label class="form-label fw-bold">ML Score</label>
                        <p class="mb-0" id="modal-score"></p>
                    </div>
                    <div class="col-6">
                        <label class="form-label fw-bold">Price Target</label>
                        <p class="mb-0 text-success" id="modal-target"></p>
                    </div>
                </div>

                <hr>

                <div class="mb-3">
                    <label for="order-quantity" class="form-label fw-bold">Quantity</label>
                    <input type="number" class="form-control" id="order-quantity" min="1" value="1" step="1">
                    <div class="form-text">Number of shares to buy</div>
                </div>

                <div class="alert alert-info mb-0">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Development Mode:</strong> This will be a mock order saved to database only (no real money).
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirm-buy-btn">
                    <i class="bi bi-check-circle me-2"></i>Confirm Purchase
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Buy Modal -->
<div class="modal fade" id="bulkBuyModal" tabindex="-1" aria-labelledby="bulkBuyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkBuyModalLabel">
                    <i class="bi bi-cart-plus-fill me-2"></i>Buy All Stocks from Strategy
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Bulk Order:</strong> You are about to place mock orders for all stocks in this strategy.
                </div>

                <div class="row mb-3">
                    <div class="col-6">
                        <label class="form-label fw-bold">Model Type</label>
                        <p class="mb-0" id="bulk-model-type"></p>
                    </div>
                    <div class="col-6">
                        <label class="form-label fw-bold">Strategy</label>
                        <p class="mb-0" id="bulk-strategy"></p>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-4">
                        <label class="form-label fw-bold">Total Stocks</label>
                        <p class="mb-0 text-primary" id="bulk-total-stocks">0</p>
                    </div>
                    <div class="col-4">
                        <label class="form-label fw-bold">Investment Amount (‚Çπ)</label>
                        <input type="number" class="form-control" id="bulk-investment-amount" min="1000" step="1000" placeholder="e.g., 50000">
                        <small class="text-muted">Total to invest</small>
                    </div>
                    <div class="col-4">
                        <div class="form-check mt-4">
                            <input class="form-check-input" type="checkbox" id="bulk-use-balance">
                            <label class="form-check-label" for="bulk-use-balance">
                                Use Account Balance
                            </label>
                        </div>
                        <small class="text-muted">Balance: <span id="bulk-available-balance">‚Çπ0</span></small>
                    </div>
                </div>

                <div class="alert alert-success mb-3">
                    <i class="bi bi-calculator me-2"></i>
                    <strong>Smart Allocation:</strong> Quantities are automatically calculated based on ML prediction scores. Higher scores get larger allocations.
                </div>

                <hr>

                <div class="mb-3">
                    <label class="form-label fw-bold">Stocks to be ordered:</label>
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm table-hover">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>#</th>
                                    <th>Symbol</th>
                                    <th>Company</th>
                                    <th>Score</th>
                                    <th>Price</th>
                                    <th>Qty</th>
                                    <th>Cost</th>
                                    <th>Allocation</th>
                                </tr>
                            </thead>
                            <tbody id="bulk-stocks-list">
                                <!-- Populated by JavaScript -->
                            </tbody>
                            <tfoot class="table-light sticky-bottom">
                                <tr>
                                    <th colspan="5" class="text-end">Total:</th>
                                    <th id="bulk-total-qty" class="text-info">0</th>
                                    <th id="bulk-total-cost" class="text-primary">‚Çπ0.00</th>
                                    <th>100%</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <div class="alert alert-info mb-3">
                    <i class="bi bi-lightbulb me-2"></i>
                    <strong>Allocation Recommendation:</strong>
                    <span id="bulk-recommendation">Higher ML scores indicate higher confidence. Consider buying more shares of stocks with scores above 70%.</span>
                </div>

                <div class="alert alert-warning mb-0">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Development Mode:</strong> These will be mock orders saved to database only (no real money).
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirm-bulk-buy-btn">
                    <i class="bi bi-check-circle me-2"></i>Confirm Bulk Purchase
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Global data storage
    let dualModelData = null;
    let statistics = null;

    // Fetch dual model view from new API endpoint
    async function fetchDualModelView() {
        try {
            showLoadingState();

            // Call the NEW dual-model-view endpoint
            const response = await fetch('/api/suggested-stocks/dual-model-view?limit=10', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin'
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            if (data.success) {
                dualModelData = data.data;
                statistics = data.statistics;

                // Update date badge
                const dateBadge = document.getElementById('data-date-badge');
                if (dateBadge && data.date) {
                    const dataDate = new Date(data.date + 'T00:00:00');
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    if (dataDate.getTime() === today.getTime()) {
                        dateBadge.textContent = `Today's Predictions (${data.date})`;
                        dateBadge.className = 'badge bg-success text-white';
                    } else {
                        dateBadge.textContent = `Latest Predictions: ${data.date}`;
                        dateBadge.className = 'badge bg-warning text-dark';
                    }
                }

                // Populate all 4 tables
                populateTable('traditional-default-table', dualModelData.traditional.default_risk, 'primary');
                populateTable('traditional-high-table', dualModelData.traditional.high_risk, 'primary');
                populateTable('lstm-default-table', dualModelData.raw_lstm.default_risk, 'success');
                populateTable('lstm-high-table', dualModelData.raw_lstm.high_risk, 'success');

                // Update statistics
                updateStatistics();

                console.log('‚úÖ Dual model data loaded successfully');
                console.log('Traditional Default:', dualModelData.traditional.default_risk.length);
                console.log('Traditional High:', dualModelData.traditional.high_risk.length);
                console.log('Raw LSTM Default:', dualModelData.raw_lstm.default_risk.length);
                console.log('Raw LSTM High:', dualModelData.raw_lstm.high_risk.length);
            } else {
                throw new Error(data.error || 'Failed to fetch dual model view');
            }

        } catch (error) {
            console.error('Error fetching dual model view:', error);
            showError(error.message);
        } finally {
            hideLoadingState();
        }
    }

    // Populate a table with stock data
    function populateTable(tableId, stocks, colorTheme = 'primary') {
        const table = document.getElementById(tableId);
        const tbody = table.getElementsByTagName('tbody')[0];
        tbody.innerHTML = '';

        if (stocks.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-muted py-4">
                        <i class="bi bi-info-circle me-2"></i>No predictions available yet
                    </td>
                </tr>
            `;
            return;
        }

        stocks.forEach((stock, index) => {
            const row = tbody.insertRow();

            // Rank
            const rankCell = row.insertCell(0);
            rankCell.textContent = index + 1;
            rankCell.className = 'text-muted';

            // Symbol
            const symbolCell = row.insertCell(1);
            symbolCell.innerHTML = `<strong>${stock.symbol || 'N/A'}</strong>`;

            // Company name (truncated)
            const nameCell = row.insertCell(2);
            const companyName = stock.stock_name || 'N/A';
            nameCell.textContent = companyName.length > 20 ? companyName.substring(0, 20) + '...' : companyName;
            nameCell.title = companyName; // Full name on hover

            // ML Score
            const scoreCell = row.insertCell(3);
            const score = (stock.ml_prediction_score || 0) * 100;
            scoreCell.textContent = score.toFixed(1) + '%';
            scoreCell.className = score > 60 ? 'text-success fw-bold' : score > 40 ? 'text-warning' : 'text-danger';

            // Target Price
            const targetCell = row.insertCell(4);
            targetCell.textContent = '‚Çπ' + (stock.ml_price_target || 0).toFixed(2);
            targetCell.className = 'text-primary';

            // Recommendation
            const recCell = row.insertCell(5);
            const rec = stock.recommendation || 'HOLD';
            const recColor = rec === 'BUY' ? 'success' : rec === 'SELL' ? 'danger' : 'secondary';
            recCell.innerHTML = `<span class="badge bg-${recColor}">${rec}</span>`;

            // Action - Buy Button
            const actionCell = row.insertCell(6);
            const modelType = tableId.includes('traditional') ? 'traditional' : 'raw_lstm';
            const strategy = tableId.includes('default') ? 'default_risk' : 'high_risk';
            actionCell.innerHTML = `
                <button class="btn btn-sm btn-success buy-btn"
                        data-symbol="${stock.symbol}"
                        data-model="${modelType}"
                        data-strategy="${strategy}"
                        data-score="${stock.ml_prediction_score || 0}"
                        data-target="${stock.ml_price_target || 0}">
                    <i class="bi bi-cart-plus"></i> Buy
                </button>
            `;
        });

        // Add event listeners to Buy buttons
        const buyButtons = tbody.querySelectorAll('.buy-btn');
        buyButtons.forEach(button => {
            button.addEventListener('click', handleBuyClick);
        });

        // Update badge count
        const badgeId = tableId.replace('-table', '-badge');
        const badge = document.getElementById(badgeId);
        if (badge) {
            badge.textContent = stocks.length;
            badge.className = stocks.length > 0 ? 'badge bg-success ms-2' : 'badge bg-secondary ms-2';
        }
    }

    // Global variables for modal
    let currentOrderData = null;
    let currentBuyButton = null;

    // Handle Buy button click - Open modal
    function handleBuyClick(event) {
        const button = event.currentTarget;
        const symbol = button.dataset.symbol;
        const modelType = button.dataset.model;
        const strategy = button.dataset.strategy;
        const score = parseFloat(button.dataset.score);
        const target = parseFloat(button.dataset.target);

        // Store current order data
        currentOrderData = {
            symbol: symbol,
            modelType: modelType,
            strategy: strategy,
            score: score,
            target: target
        };
        currentBuyButton = button;

        // Populate modal
        document.getElementById('modal-stock-name').textContent = symbol;
        document.getElementById('modal-model').textContent = modelType.toUpperCase();
        document.getElementById('modal-strategy').textContent = strategy.replace('_', ' ').toUpperCase();
        document.getElementById('modal-score').innerHTML = `<span class="badge bg-success">${(score * 100).toFixed(1)}%</span>`;
        document.getElementById('modal-target').textContent = `‚Çπ${target.toFixed(2)}`;
        document.getElementById('order-quantity').value = 1;

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('buyOrderModal'));
        modal.show();
    }

    // Handle confirm purchase button
    document.getElementById('confirm-buy-btn').addEventListener('click', async function() {
        if (!currentOrderData || !currentBuyButton) return;

        const quantity = parseInt(document.getElementById('order-quantity').value);
        if (!quantity || quantity < 1) {
            showNotification('‚ùå Please enter a valid quantity', 'error');
            return;
        }

        const confirmBtn = this;
        const originalHTML = confirmBtn.innerHTML;
        confirmBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';
        confirmBtn.disabled = true;

        // Also disable the original buy button
        const originalButtonHTML = currentBuyButton.innerHTML;
        currentBuyButton.innerHTML = '<i class="bi bi-hourglass-split"></i> Placing...';
        currentBuyButton.disabled = true;

        try {
            const response = await fetch('/api/mock-trading/order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    symbol: currentOrderData.symbol,
                    quantity: quantity,
                    model_type: currentOrderData.modelType,
                    strategy: currentOrderData.strategy,
                    ml_prediction_score: currentOrderData.score,
                    ml_price_target: currentOrderData.target
                })
            });

            const data = await response.json();

            if (data.success) {
                showNotification(
                    `‚úÖ Mock order placed successfully!\n\n` +
                    `Symbol: ${currentOrderData.symbol}\n` +
                    `Quantity: ${quantity} shares\n` +
                    `Price: ‚Çπ${data.price.toFixed(2)}\n` +
                    `Total: ‚Çπ${data.total_value.toFixed(2)}\n` +
                    `Order ID: ${data.order_id}`,
                    'success'
                );

                // Update button to show it's been ordered
                currentBuyButton.innerHTML = '<i class="bi bi-check-circle"></i> Ordered';
                currentBuyButton.classList.remove('btn-success');
                currentBuyButton.classList.add('btn-secondary');

                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('buyOrderModal')).hide();
            } else {
                showNotification('‚ùå Failed to place order: ' + (data.error || 'Unknown error'), 'error');
                currentBuyButton.innerHTML = originalButtonHTML;
                currentBuyButton.disabled = false;
                confirmBtn.innerHTML = originalHTML;
                confirmBtn.disabled = false;
            }
        } catch (error) {
            showNotification('‚ùå Error placing order: ' + error.message, 'error');
            currentBuyButton.innerHTML = originalButtonHTML;
            currentBuyButton.disabled = false;
            confirmBtn.innerHTML = originalHTML;
            confirmBtn.disabled = false;
        }
    });

    // Notification function
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; white-space: pre-line;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }

    // Update statistics display
    function updateStatistics() {
        if (!statistics) return;

        // Traditional - Default Risk
        updateStatElement('trad-default-avg', statistics.traditional.default_risk.avg_score);
        updateStatElement('trad-default-conf', statistics.traditional.default_risk.avg_confidence);
        document.getElementById('trad-default-badge').textContent = statistics.traditional.default_risk.count;

        // Traditional - High Risk
        updateStatElement('trad-high-avg', statistics.traditional.high_risk.avg_score);
        updateStatElement('trad-high-conf', statistics.traditional.high_risk.avg_confidence);
        document.getElementById('trad-high-badge').textContent = statistics.traditional.high_risk.count;

        // Raw LSTM - Default Risk
        updateStatElement('lstm-default-avg', statistics.raw_lstm.default_risk.avg_score);
        updateStatElement('lstm-default-conf', statistics.raw_lstm.default_risk.avg_confidence);
        document.getElementById('lstm-default-badge').textContent = statistics.raw_lstm.default_risk.count;

        // Raw LSTM - High Risk
        updateStatElement('lstm-high-avg', statistics.raw_lstm.high_risk.avg_score);
        updateStatElement('lstm-high-conf', statistics.raw_lstm.high_risk.avg_confidence);
        document.getElementById('lstm-high-badge').textContent = statistics.raw_lstm.high_risk.count;

        // Update header counts
        const tradTotal = statistics.traditional.default_risk.count + statistics.traditional.high_risk.count;
        const lstmTotal = statistics.raw_lstm.default_risk.count + statistics.raw_lstm.high_risk.count;
        const defaultTotal = statistics.traditional.default_risk.count + statistics.raw_lstm.default_risk.count;
        const highTotal = statistics.traditional.high_risk.count + statistics.raw_lstm.high_risk.count;

        document.getElementById('trad-count').textContent = tradTotal;
        document.getElementById('lstm-count').textContent = lstmTotal;
        document.getElementById('default-count').textContent = defaultTotal;
        document.getElementById('high-count').textContent = highTotal;
    }

    // Update a single statistic element
    function updateStatElement(elementId, value) {
        const element = document.getElementById(elementId);
        if (element) {
            element.textContent = value ? (value * 100).toFixed(1) + '%' : 'N/A';
        }
    }

    // Show loading state
    function showLoadingState() {
        const tables = ['traditional-default-table', 'traditional-high-table',
                       'lstm-default-table', 'lstm-high-table'];

        tables.forEach(tableId => {
            const table = document.getElementById(tableId);
            const tbody = table.getElementsByTagName('tbody')[0];
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4">
                        <div class="spinner-border text-primary spinner-border-sm" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="mt-2 small">Loading predictions...</div>
                    </td>
                </tr>
            `;
        });
    }

    // Hide loading state
    function hideLoadingState() {
        // Loading will be replaced by actual data or error message
    }

    // Show error message
    function showError(message) {
        const tables = ['traditional-default-table', 'traditional-high-table',
                       'lstm-default-table', 'lstm-high-table'];

        tables.forEach(tableId => {
            const table = document.getElementById(tableId);
            const tbody = table.getElementsByTagName('tbody')[0];
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-danger py-4">
                        <i class="bi bi-exclamation-triangle me-2"></i>${message}
                    </td>
                </tr>
            `;
        });
    }

    // Global variables for bulk buy
    let bulkOrderData = null;

    // Buy all stocks from a strategy
    function buyAllStocks(modelType, strategy) {
        if (!dualModelData) {
            showNotification('‚ùå No data loaded yet', 'error');
            return;
        }

        // Get stocks for this model/strategy combination
        let stocks = [];
        if (modelType === 'traditional') {
            stocks = strategy === 'default_risk' ? dualModelData.traditional.default_risk : dualModelData.traditional.high_risk;
        } else if (modelType === 'raw_lstm') {
            stocks = strategy === 'default_risk' ? dualModelData.raw_lstm.default_risk : dualModelData.raw_lstm.high_risk;
        }

        if (stocks.length === 0) {
            showNotification('‚ùå No stocks available for this strategy', 'error');
            return;
        }

        // Store bulk order data
        bulkOrderData = {
            modelType: modelType,
            strategy: strategy,
            stocks: stocks
        };

        // Populate modal
        document.getElementById('bulk-model-type').textContent = modelType.toUpperCase();
        document.getElementById('bulk-strategy').textContent = strategy.replace('_', ' ').toUpperCase();
        document.getElementById('bulk-total-stocks').textContent = stocks.length;

        // Reset inputs
        document.getElementById('bulk-investment-amount').value = '';
        document.getElementById('bulk-use-balance').checked = false;

        // Load user balance from settings API
        let userBalance = 100000; // Default
        try {
            const settingsResponse = await fetch('/api/settings');
            const settingsData = await settingsResponse.json();
            if (settingsData.success && settingsData.settings && settingsData.settings.account_balance) {
                userBalance = settingsData.settings.account_balance;
            }
        } catch (error) {
            console.error('Error loading account balance:', error);
        }
        document.getElementById('bulk-available-balance').textContent = `‚Çπ${userBalance.toLocaleString('en-IN')}`;

        // Calculate initial allocation with default 50000 investment
        calculateSmartAllocation(50000);

        // Add event listeners
        document.getElementById('bulk-investment-amount').addEventListener('input', function() {
            const amount = parseFloat(this.value) || 0;
            if (amount > 0) {
                calculateSmartAllocation(amount);
            }
        });

        document.getElementById('bulk-use-balance').addEventListener('change', function() {
            if (this.checked) {
                document.getElementById('bulk-investment-amount').value = userBalance;
                calculateSmartAllocation(userBalance);
            }
        });

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('bulkBuyModal'));
        modal.show();
    }

    // Calculate smart allocation based on ML prediction scores
    function calculateSmartAllocation(totalInvestment) {
        if (!bulkOrderData || !bulkOrderData.stocks || totalInvestment <= 0) return;

        const stocks = bulkOrderData.stocks;

        // Calculate total score weight
        const totalScoreWeight = stocks.reduce((sum, stock) => {
            return sum + (stock.ml_prediction_score || 0);
        }, 0);

        if (totalScoreWeight === 0) {
            showNotification('‚ùå Cannot calculate allocation: All stocks have 0 score', 'error');
            return;
        }

        // Calculate allocation for each stock based on ML score
        let allocatedAmount = 0;
        const stocksWithAllocation = stocks.map((stock, index) => {
            const score = stock.ml_prediction_score || 0;
            const price = stock.current_price || 0;

            // Allocation percentage based on ML score
            const allocationPercent = (score / totalScoreWeight) * 100;

            // Amount allocated to this stock
            const allocatedAmountForStock = (totalInvestment * score) / totalScoreWeight;

            // Calculate quantity (round down to whole shares)
            const quantity = price > 0 ? Math.floor(allocatedAmountForStock / price) : 0;

            // Actual cost
            const cost = quantity * price;
            allocatedAmount += cost;

            return {
                ...stock,
                price,
                quantity,
                cost,
                allocationPercent
            };
        });

        // Populate table
        const tbody = document.getElementById('bulk-stocks-list');
        tbody.innerHTML = '';

        let totalQty = 0;

        stocksWithAllocation.forEach((stock, index) => {
            const score = (stock.ml_prediction_score || 0) * 100;
            const scoreClass = score >= 70 ? 'bg-success' : score >= 60 ? 'bg-info' : 'bg-secondary';
            const allocationClass = score >= 70 ? 'fw-bold text-success' : '';

            totalQty += stock.quantity;

            const row = tbody.insertRow();
            row.innerHTML = `
                <td class="text-muted">${index + 1}</td>
                <td><strong>${stock.symbol}</strong></td>
                <td>${(stock.stock_name || 'N/A').substring(0, 15)}</td>
                <td><span class="badge ${scoreClass}">${score.toFixed(1)}%</span></td>
                <td class="text-muted">‚Çπ${stock.price.toFixed(2)}</td>
                <td class="text-info fw-bold">${stock.quantity}</td>
                <td class="text-primary">‚Çπ${stock.cost.toFixed(2)}</td>
                <td class="${allocationClass}">${stock.allocationPercent.toFixed(1)}%</td>
            `;
        });

        // Update totals
        document.getElementById('bulk-total-qty').textContent = totalQty;
        document.getElementById('bulk-total-cost').textContent = `‚Çπ${allocatedAmount.toFixed(2)}`;

        // Store allocation in bulk order data
        bulkOrderData.allocatedStocks = stocksWithAllocation;
        bulkOrderData.totalInvestment = totalInvestment;
        bulkOrderData.actualCost = allocatedAmount;

        // Generate allocation recommendation
        const highScoreStocks = stocksWithAllocation.filter(s => (s.ml_prediction_score || 0) * 100 >= 70);
        const mediumScoreStocks = stocksWithAllocation.filter(s => {
            const score = (s.ml_prediction_score || 0) * 100;
            return score >= 60 && score < 70;
        });

        let recommendation = '';
        if (highScoreStocks.length > 0) {
            const details = highScoreStocks.map(s =>
                `${s.symbol} (${s.quantity} shares, ‚Çπ${s.cost.toFixed(0)})`
            ).join(', ');
            recommendation = `<strong>High Confidence (‚â•70%):</strong> ${details}. `;
        }
        if (mediumScoreStocks.length > 0) {
            const details = mediumScoreStocks.map(s =>
                `${s.symbol} (${s.quantity} shares)`
            ).join(', ');
            recommendation += `<strong>Medium Confidence (60-70%):</strong> ${details}.`;
        }
        if (!recommendation) {
            recommendation = 'Allocation calculated based on ML prediction scores.';
        }

        document.getElementById('bulk-recommendation').innerHTML = recommendation;
    }

    // Handle confirm bulk purchase button
    document.getElementById('confirm-bulk-buy-btn').addEventListener('click', async function() {
        if (!bulkOrderData || !bulkOrderData.allocatedStocks || bulkOrderData.allocatedStocks.length === 0) {
            showNotification('‚ùå No stocks to order. Please enter investment amount.', 'error');
            return;
        }

        const confirmBtn = this;
        const originalHTML = confirmBtn.innerHTML;
        confirmBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';
        confirmBtn.disabled = true;

        let successCount = 0;
        let failCount = 0;
        let totalInvested = 0;
        const totalStocks = bulkOrderData.allocatedStocks.length;

        // Place orders for each stock with calculated quantities
        for (const stock of bulkOrderData.allocatedStocks) {
            // Skip stocks with 0 quantity
            if (stock.quantity === 0) continue;

            try {
                const response = await fetch('/api/mock-trading/order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        symbol: stock.symbol,
                        quantity: stock.quantity,
                        model_type: bulkOrderData.modelType,
                        strategy: bulkOrderData.strategy,
                        ml_prediction_score: stock.ml_prediction_score || 0,
                        ml_price_target: stock.ml_price_target || 0
                    })
                });

                const data = await response.json();
                if (data.success) {
                    successCount++;
                    totalInvested += stock.cost;
                } else {
                    failCount++;
                    console.error(`Failed to order ${stock.symbol}:`, data.error);
                }
            } catch (error) {
                failCount++;
                console.error(`Error ordering ${stock.symbol}:`, error);
            }
        }

        // Show summary
        const summaryMessage =
            `‚úÖ Smart allocation order completed!\n\n` +
            `Total stocks: ${totalStocks}\n` +
            `‚úÖ Successful: ${successCount}\n` +
            `‚ùå Failed: ${failCount}\n` +
            `üí∞ Total Invested: ‚Çπ${totalInvested.toFixed(2)}\n` +
            `üìä Planned Investment: ‚Çπ${bulkOrderData.totalInvestment.toFixed(2)}\n\n` +
            `Model: ${bulkOrderData.modelType.toUpperCase()}\n` +
            `Strategy: ${bulkOrderData.strategy.replace('_', ' ').toUpperCase()}\n\n` +
            `Allocation based on ML prediction scores.`;

        showNotification(summaryMessage, successCount > 0 ? 'success' : 'error');

        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('bulkBuyModal')).hide();

        // Reset button
        confirmBtn.innerHTML = originalHTML;
        confirmBtn.disabled = false;

        // Reload data to show updated states
        setTimeout(() => {
            fetchDualModelView();
        }, 1000);
    });

    // Handle tab switching to update Buy All button strategy
    // Traditional model tabs
    document.querySelectorAll('[data-bs-toggle="tab"][href^="#trad-"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(event) {
            const strategy = event.target.getAttribute('href').includes('default') ? 'default_risk' : 'high_risk';
            const buyAllBtn = document.getElementById('buy-all-trad');
            buyAllBtn.onclick = function() { buyAllStocks('traditional', strategy); };
        });
    });

    // Raw LSTM model tabs
    document.querySelectorAll('[data-bs-toggle="tab"][href^="#lstm-"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(event) {
            const strategy = event.target.getAttribute('href').includes('default') ? 'default_risk' : 'high_risk';
            const buyAllBtn = document.getElementById('buy-all-lstm');
            buyAllBtn.onclick = function() { buyAllStocks('raw_lstm', strategy); };
        });
    });

    // Event listeners
    document.getElementById('refresh-btn').addEventListener('click', fetchDualModelView);

    // Initialize page when loaded
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üìä Initializing Dual Model View...');
        fetchDualModelView();
    });
</script>
{% endblock %}
