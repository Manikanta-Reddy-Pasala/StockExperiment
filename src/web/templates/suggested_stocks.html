{% extends "base.html" %}

{% block title %}Suggested Stocks{% endblock %}

{% block content %}
<!-- Modern Suggested Stocks Table -->
<div class="card hover-lift animate-fade-in-up">
    <div class="card-header bg-gradient-primary text-white">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0 text-white">
                <i class="bi bi-lightbulb me-2"></i>Suggested Stocks
            </h5>
            <div class="d-flex gap-2 align-items-center">
                <select class="form-select form-select-sm" id="time-filter" style="min-width: 120px;">
                    <option value="today">Today</option>
                    <option value="week" selected>This Week</option>
                    <option value="month">This Month</option>
                    <option value="all">All Time</option>
                </select>
                <div class="dropdown">
                    <button class="btn btn-light btn-sm dropdown-toggle" type="button" id="strategy-filter" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-funnel"></i>
                    </button>
                        <ul class="dropdown-menu" aria-labelledby="strategy-filter">
                            <li>
                                <div class="form-check ms-2">
                                    <input class="form-check-input" type="checkbox" value="all" id="strategy-all" checked>
                                    <label class="form-check-label" for="strategy-all">
                                        All Strategies
                                    </label>
                                </div>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <div class="form-check ms-2">
                                    <input class="form-check-input strategy-checkbox" type="checkbox" value="momentum" id="strategy-momentum" checked>
                                    <label class="form-check-label" for="strategy-momentum">
                                        Momentum Strategy
                                    </label>
                                </div>
                            </li>
                            <li>
                                <div class="form-check ms-2">
                                    <input class="form-check-input strategy-checkbox" type="checkbox" value="breakout" id="strategy-breakout" checked>
                                    <label class="form-check-label" for="strategy-breakout">
                                        Breakout Strategy
                                    </label>
                                </div>
                            </li>
                            <li>
                                <div class="form-check ms-2">
                                    <input class="form-check-input strategy-checkbox" type="checkbox" value="mean-reversion" id="strategy-mean-reversion" checked>
                                    <label class="form-check-label" for="strategy-mean-reversion">
                                        Mean Reversion Strategy
                                    </label>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <button class="btn btn-sm btn-outline-primary" id="refresh-btn">
                        <i class="bi bi-arrow-repeat"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="suggested-stocks-table">
                        <thead class="table-light">
                            <tr>
                                <th>Symbol</th>
                                <th>Selection Date</th>
                                <th>Selection Price</th>
                                <th>Current Price</th>
                                <th>Quantity</th>
                                <th>Investment</th>
                                <th>Current Value</th>
                                <th>Strategy</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Suggested stocks will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Real data from API
    let suggestedStocks = [];

    // Get selected strategies
    function getSelectedStrategies() {
        const checkboxes = document.querySelectorAll('.strategy-checkbox:checked');
        return Array.from(checkboxes).map(cb => cb.value);
    }

    // Fetch suggested stocks from API
    async function fetchSuggestedStocks() {
        try {
            // Show loading spinner
            showLoadingSpinner();
            
            const selectedStrategies = getSelectedStrategies();
            const timeFilter = document.getElementById('time-filter').value;
            
            // Build query parameters
            const params = new URLSearchParams();
            selectedStrategies.forEach(strategy => params.append('strategies', strategy));
            params.append('time_filter', timeFilter);
            
            const response = await fetch(`/api/suggested-stocks?${params}`, {
                credentials: 'same-origin'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.success) {
                suggestedStocks = data.data;
                populateTable();
                showNotification(`Loaded ${data.total} suggested stocks`, 'success');
            } else {
                throw new Error(data.error || 'Failed to fetch suggested stocks');
            }
        } catch (error) {
            console.error('Error fetching suggested stocks:', error);
            showNotification(`Error loading stocks: ${error.message}`, 'error');
        } finally {
            // Hide loading spinner
            hideLoadingSpinner();
        }
    }

    // Refresh suggested stocks
    async function refreshSuggestedStocks() {
        try {
            // Show loading spinner
            showLoadingSpinner();
            
            const selectedStrategies = getSelectedStrategies();
            
            const response = await fetch('/api/suggested-stocks/refresh', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    strategies: selectedStrategies
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.success) {
                suggestedStocks = data.data;
                populateTable();
                showNotification(`Refreshed ${data.total} suggested stocks at ${data.refreshed_at}`, 'success');
            } else {
                throw new Error(data.error || 'Failed to refresh suggested stocks');
            }
        } catch (error) {
            console.error('Error refreshing suggested stocks:', error);
            showNotification(`Error refreshing stocks: ${error.message}`, 'error');
        } finally {
            // Hide loading spinner
            hideLoadingSpinner();
        }
    }

    // Populate table with filtered stocks
    function populateTable() {
        const table = document.getElementById('suggested-stocks-table').getElementsByTagName('tbody')[0];
        table.innerHTML = '';
        
        if (suggestedStocks.length === 0) {
            const row = table.insertRow();
            const cell = row.insertCell();
            cell.colSpan = 9;
            cell.className = 'text-center text-muted py-4';
            cell.innerHTML = '<i class="bi bi-info-circle me-2"></i>No stocks found. Try adjusting your filters or refresh the data.';
            return;
        }
        
        suggestedStocks.forEach(stock => {
            const row = table.insertRow();
            
            // Calculate values
            const investment = stock.quantity * stock.selection_price;
            const value = stock.quantity * stock.current_price;
            
            // Populate row
            row.insertCell(0).textContent = stock.symbol;
            row.insertCell(1).textContent = new Date(stock.selection_date).toLocaleDateString();
            row.insertCell(2).textContent = '₹' + stock.selection_price.toFixed(2);
            row.insertCell(3).textContent = '₹' + stock.current_price.toFixed(2);
            row.insertCell(4).textContent = stock.quantity;
            row.insertCell(5).textContent = '₹' + investment.toFixed(2);
            row.insertCell(6).textContent = '₹' + value.toFixed(2);
            
            // Strategy column
            const strategyCell = row.insertCell(7);
            strategyCell.textContent = stock.strategy;
            strategyCell.className = 'text-info';
            
            // Status column
            const statusCell = row.insertCell(8);
            statusCell.textContent = stock.status;
            statusCell.className = stock.status === 'Active' ? 'text-success' : 
                                stock.status === 'Sold' ? 'text-secondary' : 'text-warning';
        });
    }

    // Handle strategy filter changes
    function handleStrategyFilter() {
        const allCheckbox = document.getElementById('strategy-all');
        const strategyCheckboxes = document.querySelectorAll('.strategy-checkbox');
        
        if (allCheckbox.checked) {
            // If "All" is checked, check all strategy checkboxes
            strategyCheckboxes.forEach(cb => cb.checked = true);
        } else {
            // If "All" is unchecked, uncheck all strategy checkboxes
            strategyCheckboxes.forEach(cb => cb.checked = false);
        }
        
        fetchSuggestedStocks();
    }

    // Handle individual strategy checkbox changes
    function handleIndividualStrategyChange() {
        const allCheckbox = document.getElementById('strategy-all');
        const strategyCheckboxes = document.querySelectorAll('.strategy-checkbox');
        const checkedCount = document.querySelectorAll('.strategy-checkbox:checked').length;
        
        // If all individual checkboxes are checked, check "All"
        if (checkedCount === strategyCheckboxes.length) {
            allCheckbox.checked = true;
        } else {
            allCheckbox.checked = false;
        }
        
        fetchSuggestedStocks();
    }

    // Show notification function
    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }

    // Loading spinner functions
    function showLoadingSpinner() {
        const table = document.getElementById('suggested-stocks-table').getElementsByTagName('tbody')[0];
        table.innerHTML = '';
        
        const row = table.insertRow();
        const cell = row.insertCell();
        cell.colSpan = 9;
        cell.className = 'text-center py-4';
        cell.innerHTML = `
            <div class="d-flex justify-content-center align-items-center">
                <div class="spinner-border text-primary me-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span class="text-muted">Loading suggested stocks...</span>
            </div>
        `;
    }

    function hideLoadingSpinner() {
        // The spinner will be replaced when populateTable() is called
    }

    // Event listeners
    document.getElementById('time-filter').addEventListener('change', fetchSuggestedStocks);
    document.getElementById('refresh-btn').addEventListener('click', refreshSuggestedStocks);
    document.getElementById('strategy-all').addEventListener('change', handleStrategyFilter);
    
    // Add event listeners to individual strategy checkboxes
    document.querySelectorAll('.strategy-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', handleIndividualStrategyChange);
    });

    // Initialize page when loaded
    document.addEventListener('DOMContentLoaded', function() {
        fetchSuggestedStocks();
    });
</script>
{% endblock %}