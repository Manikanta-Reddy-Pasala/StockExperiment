{% extends "base.html" %}

{% block title %}Brokers{% endblock %}

{% block content %}
<div class="row g-4">
    <div class="col-12">
        <div class="card hover-lift animate-fade-in-up">
            <div class="card-header bg-gradient-primary text-white">
                <h5 class="card-title mb-0 text-white">
                    <i class="bi bi-building me-2"></i>Broker Configuration
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- FYERS Broker Card -->
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100 broker-card">
                            <div class="card-header bg-light">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="card-title mb-0">
                                        <i class="bi bi-building text-primary me-2"></i>FYERS
                                    </h6>
                                    <span class="badge bg-success" id="fyers-status">Connected</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <small class="text-muted">Client ID</small>
                                        <div class="fw-bold" id="fyers-client-id">Loading...</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">API Version</small>
                                        <div class="fw-bold">v3.1.7</div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <small class="text-muted">Access Token</small>
                                        <div class="fw-bold text-truncate" id="fyers-token-status">
                                            <i class="bi bi-check-circle text-success"></i> Active
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Last Updated</small>
                                        <div class="fw-bold" id="fyers-last-updated">-</div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <small class="text-muted">Connection Status</small>
                                    <div class="d-flex align-items-center">
                                        <div class="spinner-border spinner-border-sm text-success me-2" role="status" id="fyers-spinner" style="display: none;">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <span class="badge bg-success" id="fyers-connection-status">Connected</span>
                                    </div>
                                </div>

                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-primary btn-sm" id="test-fyers-connection">
                                        <i class="bi bi-wifi"></i> Test Connection
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" id="refresh-fyers-token">
                                        <i class="bi bi-arrow-clockwise"></i> Refresh Token
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Broker Statistics -->
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100 broker-stats-card">
                            <div class="card-header bg-light">
                                <h6 class="card-title mb-0">
                                    <i class="bi bi-graph-up me-2"></i>Broker Statistics
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-6 mb-3">
                                        <div class="border-end">
                                            <h4 class="text-primary mb-1 broker-stats-number" id="total-orders">0</h4>
                                            <small class="text-muted">Total Orders</small>
                                        </div>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <h4 class="text-success mb-1 broker-stats-number" id="successful-orders">0</h4>
                                        <small class="text-muted">Successful</small>
                                    </div>
                                    <div class="col-6">
                                        <div class="border-end">
                                            <h4 class="text-warning mb-1 broker-stats-number" id="pending-orders">0</h4>
                                            <small class="text-muted">Pending</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <h4 class="text-danger mb-1 broker-stats-number" id="failed-orders">0</h4>
                                        <small class="text-muted">Failed</small>
                                    </div>
                                </div>
                                
                                <hr>
                                
                                <div class="mb-2">
                                    <small class="text-muted">Last Order</small>
                                    <div class="fw-bold" id="last-order-time">-</div>
                                </div>
                                
                                <div class="mb-2">
                                    <small class="text-muted">API Response Time</small>
                                    <div class="fw-bold" id="api-response-time">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Broker Configuration Section -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card broker-config-section">
                            <div class="card-header bg-light">
                                <h6 class="card-title mb-0">
                                    <i class="bi bi-gear me-2"></i>FYERS Configuration
                                </h6>
                            </div>
                            <div class="card-body">
                                <form id="fyers-config-form">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="fyers-client-id-input" class="form-label">Client ID</label>
                                            <input type="text" class="form-control" id="fyers-client-id-input" 
                                                   placeholder="Enter FYERS Client ID">
                                            <div class="form-text">Your FYERS API Client ID</div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="fyers-access-token-input" class="form-label">Access Token</label>
                                            <input type="password" class="form-control" id="fyers-access-token-input" 
                                                   placeholder="Enter FYERS Access Token">
                                            <div class="form-text">Your FYERS API Access Token</div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="fyers-redirect-url" class="form-label">Redirect URL</label>
                                            <input type="url" class="form-control" id="fyers-redirect-url" 
                                                   value="https://trade.fyers.in/api-login/redirect-uri/index.html">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="fyers-app-type" class="form-label">App Type</label>
                                            <select class="form-select" id="fyers-app-type">
                                                <option value="100">FYERS Web</option>
                                                <option value="2">FYERS Mobile</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle me-2"></i>
                                        <strong>Note:</strong> FYERS broker configuration is stored securely in the database. 
                                        Enter your credentials below and save to configure your broker connection.
                                    </div>
                                    
                                    <div class="d-flex justify-content-end mt-3">
                                        <button type="button" class="btn btn-outline-secondary me-2" id="reset-fyers-config">
                                            <i class="bi bi-arrow-clockwise"></i> Reset
                                        </button>
                                        <button type="button" class="btn btn-primary" id="save-fyers-config">
                                            <i class="bi bi-save-fill"></i> Save Configuration
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Notification function to replace alert popups
    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Add to page
        document.body.appendChild(notification);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }
    
    // Fetch broker information
    async function fetchBrokerInfo() {
        try {
            const response = await fetch('/api/brokers/fyers');
            const data = await response.json();
            
            if (data.success) {
                // Update FYERS information from database
                document.getElementById('fyers-client-id').textContent = data.client_id || 'Not configured';
                document.getElementById('fyers-token-status').innerHTML = 
                    data.access_token ? '<i class="bi bi-check-circle text-success"></i> Active' : 
                    '<i class="bi bi-x-circle text-danger"></i> Not configured';
                document.getElementById('fyers-last-updated').textContent = data.last_updated || '-';
                
                // Update connection status from database
                const connectionStatus = data.connection_status || 'unknown';
                const isConnected = data.connected || false;
                
                document.getElementById('fyers-connection-status').textContent = connectionStatus.charAt(0).toUpperCase() + connectionStatus.slice(1);
                document.getElementById('fyers-connection-status').className = 
                    isConnected ? 'badge bg-success' : 'badge bg-danger';
                document.getElementById('fyers-status').textContent = connectionStatus.charAt(0).toUpperCase() + connectionStatus.slice(1);
                document.getElementById('fyers-status').className = 
                    isConnected ? 'badge bg-success' : 'badge bg-danger';
                
                // Update last connection test time
                if (data.last_connection_test && data.last_connection_test !== '-') {
                    document.getElementById('fyers-last-updated').textContent = data.last_connection_test;
                }
                
                // Update statistics
                document.getElementById('total-orders').textContent = data.stats?.total_orders || 0;
                document.getElementById('successful-orders').textContent = data.stats?.successful_orders || 0;
                document.getElementById('pending-orders').textContent = data.stats?.pending_orders || 0;
                document.getElementById('failed-orders').textContent = data.stats?.failed_orders || 0;
                document.getElementById('last-order-time').textContent = data.stats?.last_order_time || '-';
                document.getElementById('api-response-time').textContent = data.stats?.api_response_time || '-';
                
                // Update form fields from database
                document.getElementById('fyers-client-id-input').value = data.client_id || '';
                document.getElementById('fyers-access-token-input').value = data.access_token ? '••••••••••••••••' : '';
                document.getElementById('fyers-redirect-url').value = data.redirect_url || 'https://trade.fyers.in/api-login/redirect-uri/index.html';
                document.getElementById('fyers-app-type').value = data.app_type || '100';
                
                // Show error message if there's one
                if (data.error_message) {
                    console.warn('FYERS connection error:', data.error_message);
                }
            }
        } catch (error) {
            console.error('Error fetching broker info:', error);
            // Show error state
            document.getElementById('fyers-status').textContent = 'Error';
            document.getElementById('fyers-status').className = 'badge bg-danger';
        }
    }
    
    // Test FYERS connection
    document.getElementById('test-fyers-connection').addEventListener('click', async function() {
        const spinner = document.getElementById('fyers-spinner');
        const status = document.getElementById('fyers-connection-status');
        
        spinner.style.display = 'inline-block';
        status.textContent = 'Testing...';
        status.className = 'badge bg-warning';
        
        try {
            const response = await fetch('/api/brokers/fyers/test', {
                method: 'POST'
            });
            const data = await response.json();
            
            if (data.success) {
                status.textContent = 'Connected';
                status.className = 'badge bg-success';
                // Update the main status badge as well
                document.getElementById('fyers-status').textContent = 'Connected';
                document.getElementById('fyers-status').className = 'badge bg-success';
            } else {
                status.textContent = 'Connection Failed';
                status.className = 'badge bg-danger';
                // Update the main status badge as well
                document.getElementById('fyers-status').textContent = 'Disconnected';
                document.getElementById('fyers-status').className = 'badge bg-danger';
            }
            
            // Refresh the broker info to get updated database status
            fetchBrokerInfo();
        } catch (error) {
            status.textContent = 'Connection Failed';
            status.className = 'badge bg-danger';
        } finally {
            spinner.style.display = 'none';
        }
    });
    
    // Refresh FYERS token
    document.getElementById('refresh-fyers-token').addEventListener('click', async function() {
        if (confirm('Are you sure you want to refresh the FYERS access token? This may require re-authentication.')) {
            try {
                const response = await fetch('/api/brokers/fyers/refresh-token', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('Token refresh initiated successfully!');
                    fetchBrokerInfo(); // Refresh the page data
                } else {
                    alert('Token refresh failed: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Token refresh failed: ' + error.message);
            }
        }
    });
    
    // Save FYERS configuration
    document.getElementById('save-fyers-config').addEventListener('click', async function() {
        const clientId = document.getElementById('fyers-client-id-input').value.trim();
        const accessToken = document.getElementById('fyers-access-token-input').value.trim();
        const redirectUrl = document.getElementById('fyers-redirect-url').value.trim();
        const appType = document.getElementById('fyers-app-type').value;
        
        if (!clientId || !accessToken) {
            alert('Please enter both Client ID and Access Token');
            return;
        }
        
        const button = this;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving...';
        button.disabled = true;
        
        try {
            const response = await fetch('/api/brokers/fyers/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    client_id: clientId,
                    access_token: accessToken,
                    redirect_url: redirectUrl,
                    app_type: appType
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Show success message
                showNotification('FYERS configuration saved successfully!', 'success');
                // Refresh the page data to show updated information
                fetchBrokerInfo();
            } else {
                showNotification('Failed to save configuration: ' + (data.error || 'Unknown error'), 'error');
            }
        } catch (error) {
            showNotification('Error saving configuration: ' + error.message, 'error');
        } finally {
            button.innerHTML = originalText;
            button.disabled = false;
        }
    });
    
    // Reset FYERS configuration
    document.getElementById('reset-fyers-config').addEventListener('click', function() {
        if (confirm('Are you sure you want to reset the FYERS configuration to default values?')) {
            document.getElementById('fyers-client-id-input').value = '';
            document.getElementById('fyers-access-token-input').value = '';
            document.getElementById('fyers-redirect-url').value = 'https://trade.fyers.in/api-login/redirect-uri/index.html';
            document.getElementById('fyers-app-type').value = '100';
        }
    });
    
    // Fetch data when page loads
    document.addEventListener('DOMContentLoaded', function() {
        fetchBrokerInfo();
        
        // Refresh data every 30 seconds
        setInterval(fetchBrokerInfo, 30000);
    });
</script>
{% endblock %}
