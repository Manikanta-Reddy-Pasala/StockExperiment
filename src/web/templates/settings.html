{% extends "base.html" %}

{% block title %}Settings{% endblock %}

{% block content %}
<div class="row g-4">
    <div class="col-12">
        <div class="card hover-lift animate-fade-in-up">
            <div class="card-header bg-gradient-primary text-white">
                <h5 class="card-title mb-0 text-white">
                    <i class="bi bi-gear-fill me-2"></i>System Configuration
                </h5>
            </div>
            <div class="card-body">
                <form id="system-config-form">
                    <div class="row">
                        <div class="col-md-12">
                            <h5 class="mt-2">Trading Parameters</h5>
                            <hr>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="trading-mode" class="form-label">Trading Mode</label>
                            <select class="form-select" id="trading-mode">
                                <option value="development">Development (Paper Trading)</option>
                                <option value="production">Production (Live Trading)</option>
                            </select>
                            <div class="form-text">
                                Development mode saves orders to database only (no broker execution) - ideal for evaluating ML model performance.
                            </div>
                        </div>

                        <div class="col-md-12">
                            <h5 class="mt-4">Account & Auto-Trading</h5>
                            <hr>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="account-balance" class="form-label">Account Balance (₹)</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="account-balance" readonly value="Loading...">
                                <button class="btn btn-outline-primary" type="button" id="refresh-balance-btn">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                            </div>
                            <div class="form-text">
                                <span id="balance-source">Fetched from FYERS API</span>
                                <span id="balance-timestamp" class="text-muted ms-2"></span>
                            </div>
                        </div>

                        <div class="col-md-12">
                            <h5 class="mt-4">Automated Trading System (9 AM Execution)</h5>
                            <hr>
                        </div>

                        <div class="col-md-12 mb-4">
                            <div class="card border-0 bg-light">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="card-title mb-0">
                                            <i class="bi bi-robot me-2"></i>Auto-Trading Configuration
                                        </h6>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="auto-trading-enabled">
                                            <label class="form-check-label fw-bold" for="auto-trading-enabled">
                                                Enable Auto-Trading
                                            </label>
                                        </div>
                                    </div>

                                    <div class="alert alert-info mb-3">
                                        <i class="bi bi-info-circle me-2"></i>
                                        <strong>How it works:</strong> Every day at 9:20 AM (5 min after market opens), the system validates weekly limits and automatically places orders based on 8-21 EMA technical strategy.
                                    </div>

                                    <div id="auto-trading-config" style="display: none;">
                                        <!-- Weekly Limits -->
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="max-amount-per-week" class="form-label">Max Amount Per Week (₹)</label>
                                                <input type="number" class="form-control" id="max-amount-per-week"
                                                       min="1000" step="1000" value="10000">
                                                <div class="form-text">Maximum investment amount per week (min: ₹1,000)</div>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="max-buys-per-week" class="form-label">Max Trades Per Week</label>
                                                <input type="number" class="form-control" id="max-buys-per-week"
                                                       min="1" max="20" value="5">
                                                <div class="form-text">Maximum number of buy orders per week (1-20)</div>
                                            </div>
                                        </div>

                                        <!-- Auto Stop-Loss & Target -->
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="auto-stop-loss" checked>
                                                    <label class="form-check-label" for="auto-stop-loss">
                                                        Auto Stop-Loss (Strategy-based)
                                                    </label>
                                                </div>
                                                <div class="form-text">Automatically set stop-loss based on strategy</div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="auto-target-price" checked>
                                                    <label class="form-check-label" for="auto-target-price">
                                                        Auto Target Price (Strategy-based)
                                                    </label>
                                                </div>
                                                <div class="form-text">Automatically set target price based on strategy</div>
                                            </div>
                                        </div>

                                        <!-- Execution Time -->
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="execution-time" class="form-label">Execution Time</label>
                                                <input type="time" class="form-control" id="execution-time" value="09:20">
                                                <div class="form-text">Daily execution time (market opens at 9:15 AM, recommended: 9:20 AM)</div>
                                            </div>
                                        </div>

                                        <!-- Weekly Status -->
                                        <div class="row mb-3" id="weekly-status-section">
                                            <div class="col-md-12">
                                                <h6 class="mb-2">
                                                    <i class="bi bi-calendar-week me-2"></i>This Week's Status
                                                    <button class="btn btn-sm btn-outline-primary ms-2" id="refresh-weekly-status">
                                                        <i class="bi bi-arrow-clockwise"></i> Refresh
                                                    </button>
                                                </h6>
                                                <div id="weekly-status-content">
                                                    <div class="text-center py-3">
                                                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                            <span class="visually-hidden">Loading...</span>
                                                        </div>
                                                        <p class="mt-2 text-muted small">Loading weekly status...</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Test Execution Button -->
                                        <div class="row">
                                            <div class="col-md-12">
                                                <button type="button" class="btn btn-outline-warning" id="test-auto-trading">
                                                    <i class="bi bi-lightning-fill me-2"></i>Test Execution Now
                                                </button>
                                                <small class="text-muted ms-2">
                                                    Trigger auto-trading manually (respects all limits and checks)
                                                </small>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mt-3">
                                        <button type="button" class="btn btn-primary" id="save-auto-trading-settings">
                                            <i class="bi bi-check-circle me-2"></i>Save Auto-Trading Settings
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-12">
                            <h5 class="mt-4">Notification Settings</h5>
                            <hr>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="email-notifications" class="form-label">Email Notifications</label>
                            <select class="form-select" id="email-notifications">
                                <option value="all">All Events</option>
                                <option value="critical">Critical Only</option>
                                <option value="none">None</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="sms-notifications" class="form-label">SMS Notifications</label>
                            <select class="form-select" id="sms-notifications">
                                <option value="critical">Critical Only</option>
                                <option value="none">None</option>
                            </select>
                        </div>
                        
                        <div class="col-md-12 mb-3">
                            <label for="notification-email" class="form-label">Notification Email</label>
                            <input type="email" class="form-control" id="notification-email" value="trader@example.com">
                        </div>
                        
                        <div class="col-md-12">
                            <h5 class="mt-4">Data Sources</h5>
                            <hr>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="primary-data-source" class="form-label">Primary Data Source</label>
                            <select class="form-select" id="primary-data-source">
                                <option value="fyers">FYERS API</option>
                                <option value="zerodha">Zerodha Kite Connect</option>
                                <option value="fyers">Fyers</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="backup-data-source" class="form-label">Backup Data Source</label>
                            <select class="form-select" id="backup-data-source">
                                <option value="fyers">Fyers</option>
                                <option value="none">None</option>
                            </select>
                        </div>
                        
                        <div class="col-md-12">
                            <h5 class="mt-4">Broker Configuration</h5>
                            <hr>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="broker-provider" class="form-label">Broker Provider</label>
                            <select class="form-select" id="broker-provider">
                                <option value="fyers">FYERS</option>
                                <option value="zerodha">Zerodha</option>
                            </select>
                            <div class="form-text">Select your primary broker. Visit the <a href="/brokers" class="alert-link">Brokers page</a> to configure.</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="broker-status" class="form-label">Broker Status</label>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-success me-2" id="broker-status-badge">Connected</span>
                                <button type="button" class="btn btn-outline-primary btn-sm" id="test-broker-connection">
                                    <i class="bi bi-wifi"></i> Test
                                </button>
                            </div>
                        </div>
                        
                        <div class="col-md-12 mb-3">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>FYERS Configuration:</strong> Broker credentials are stored securely in the database. 
                                Visit the <a href="/brokers" class="alert-link">Brokers page</a> to configure and manage your broker connection.
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-end mt-4">
                        <button type="button" class="btn btn-outline-secondary me-2" id="reset-config">
                            <i class="bi bi-arrow-clockwise"></i> Reset
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save-fill"></i> Save Configuration
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
</div>
{% endblock %}

{% block scripts %}
<script>
    // Notification function
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }

    // Fetch account balance from FYERS API
    async function fetchAccountBalance() {
        const balanceInput = document.getElementById('account-balance');
        const balanceSource = document.getElementById('balance-source');
        const balanceTimestamp = document.getElementById('balance-timestamp');
        const refreshBtn = document.getElementById('refresh-balance-btn');

        // Show loading state
        balanceInput.value = 'Loading...';
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Loading...';

        try {
            // Get broker provider from settings
            const brokerProvider = document.getElementById('broker-provider').value || 'fyers';

            // Fetch funds/balance from broker API
            const response = await fetch(`/api/brokers/${brokerProvider}/funds`);
            const data = await response.json();

            if (data.success && data.data) {
                // FYERS API response structure: data.data contains fund_limit array
                // Extract available balance from FYERS response
                let balance = 0;

                if (data.data.fund_limit && Array.isArray(data.data.fund_limit)) {
                    // FYERS API returns array of fund limits
                    const fundLimit = data.data.fund_limit[0];
                    balance = fundLimit.equityAmount || fundLimit.net_available || 0;
                } else if (data.data.available_balance) {
                    balance = data.data.available_balance;
                } else if (data.data.cash_available) {
                    balance = data.data.cash_available;
                }

                balanceInput.value = `₹${balance.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                balanceSource.textContent = `Fetched from ${brokerProvider.toUpperCase()} API`;
                balanceSource.className = 'text-success';

                // Update timestamp
                const now = new Date();
                balanceTimestamp.textContent = `Last updated: ${now.toLocaleTimeString()}`;

                // Store raw balance value for use in auto-buy
                balanceInput.dataset.rawBalance = balance;

                showNotification(`Balance updated: ₹${balance.toLocaleString('en-IN')}`, 'success');
            } else {
                throw new Error(data.error || 'Failed to fetch balance');
            }
        } catch (error) {
            console.error('Error fetching account balance:', error);
            balanceInput.value = 'Error loading balance';
            balanceSource.textContent = `Failed to fetch from broker: ${error.message}`;
            balanceSource.className = 'text-danger';
            showNotification('Failed to fetch account balance from broker', 'error');
        } finally {
            refreshBtn.disabled = false;
            refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Refresh';
        }
    }

    // Fetch current settings
    async function fetchSettings() {
        try {
            const response = await fetch('/api/settings');
            const data = await response.json();

            if (data.success && data.settings) {
                const settings = data.settings;

                // Populate form with current settings
                document.getElementById('trading-mode').value = settings.trading_mode || 'development';
                // Account balance is fetched from broker API, not from settings
                document.getElementById('primary-data-source').value = settings.primary_data_source || 'fyers';
                document.getElementById('backup-data-source').value = settings.backup_data_source || 'fyers';
                document.getElementById('broker-provider').value = settings.broker_provider || 'fyers';
                document.getElementById('email-notifications').value = settings.email_notifications ? 'all' : 'none';
                document.getElementById('sms-notifications').value = settings.sms_notifications ? 'critical' : 'none';
                document.getElementById('notification-email').value = settings.notification_email || 'trader@example.com';

                // Update broker status based on selected provider
                updateBrokerStatus(settings.broker_provider || 'fyers');
            }
        } catch (error) {
            console.error('Error fetching settings:', error);
        }
    }

    // Handle form submission
    document.getElementById('system-config-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        // Collect form data
        const settings = {
            trading_mode: document.getElementById('trading-mode').value,
            // account_balance is fetched from broker API, not saved in settings
            primary_data_source: document.getElementById('primary-data-source').value,
            backup_data_source: document.getElementById('backup-data-source').value,
            broker_provider: document.getElementById('broker-provider').value,
            email_notifications: document.getElementById('email-notifications').value !== 'none',
            sms_notifications: document.getElementById('sms-notifications').value !== 'none',
            notification_email: document.getElementById('notification-email').value
        };
        
        try {
            const response = await fetch('/api/settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(settings)
            });
            
            const data = await response.json();
            
            if (data.success) {
                showNotification('Settings saved successfully!', 'success');
                // Update broker status after saving
                updateBrokerStatus(settings.broker_provider);
            } else {
                showNotification('Failed to save settings: ' + (data.error || 'Unknown error'), 'error');
            }
        } catch (error) {
            showNotification('Error saving settings: ' + error.message, 'error');
        }
    });
    
    // Event listener for reset config button
    document.getElementById('reset-config').addEventListener('click', function() {
        if (confirm('Are you sure you want to reset all settings to defaults?')) {
            alert('Configuration reset to defaults!');
        }
    });
    
    // Test broker connection
    document.getElementById('test-broker-connection').addEventListener('click', async function() {
        const button = this;
        const originalText = button.innerHTML;
        const statusBadge = document.getElementById('broker-status-badge');
        const brokerProvider = document.getElementById('broker-provider').value;
        
        button.innerHTML = '<i class="bi bi-hourglass-split"></i> Testing...';
        button.disabled = true;
        
        try {
            const response = await fetch(`/api/brokers/${brokerProvider}/test`, {
                method: 'POST'
            });
            const data = await response.json();
            
            if (data.success) {
                statusBadge.textContent = 'Connected';
                statusBadge.className = 'badge bg-success me-2';
                showNotification(`${brokerProvider.toUpperCase()} connection test successful!`, 'success');
            } else {
                statusBadge.textContent = 'Disconnected';
                statusBadge.className = 'badge bg-danger me-2';
                showNotification(`${brokerProvider.toUpperCase()} connection test failed: ${data.message || 'Unknown error'}`, 'error');
            }
            
            // Refresh broker status to get updated database information
            await updateBrokerStatus(brokerProvider);
        } catch (error) {
            statusBadge.textContent = 'Error';
            statusBadge.className = 'badge bg-danger me-2';
            showNotification(`Error testing ${brokerProvider.toUpperCase()} connection: ${error.message}`, 'error');
        } finally {
            button.innerHTML = originalText;
            button.disabled = false;
        }
    });
    
    // Update broker status based on selected provider
    async function updateBrokerStatus(brokerProvider) {
        try {
            const response = await fetch(`/api/brokers/${brokerProvider}`);
            const data = await response.json();
            
            const statusBadge = document.getElementById('broker-status-badge');
            
            if (data.success) {
                const connectionStatus = data.connection_status || 'unknown';
                const isConnected = data.is_connected || false;
                
                const statusText = connectionStatus.charAt(0).toUpperCase() + connectionStatus.slice(1);
                
                if (isConnected) {
                    statusBadge.textContent = statusText;
                    statusBadge.className = 'badge bg-success me-2';
                } else {
                    statusBadge.textContent = statusText;
                    statusBadge.className = 'badge bg-danger me-2';
                }
            } else {
                statusBadge.textContent = 'Unknown';
                statusBadge.className = 'badge bg-secondary me-2';
            }
        } catch (error) {
            console.error('Error fetching broker status:', error);
            const statusBadge = document.getElementById('broker-status-badge');
            statusBadge.textContent = 'Error';
            statusBadge.className = 'badge bg-danger me-2';
        }
    }
    
    // Fetch broker status on page load
    async function fetchBrokerStatus() {
        const brokerProvider = document.getElementById('broker-provider').value || 'fyers';
        await updateBrokerStatus(brokerProvider);
    }
    
    // Event listener for refresh balance button
    document.getElementById('refresh-balance-btn').addEventListener('click', fetchAccountBalance);

    // ============================================
    // AUTO-TRADING SETTINGS FUNCTIONS
    // ============================================

    // Toggle auto-trading config visibility
    function toggleAutoTradingConfig() {
        const autoTradingEnabled = document.getElementById('auto-trading-enabled').checked;
        const configContainer = document.getElementById('auto-trading-config');
        configContainer.style.display = autoTradingEnabled ? 'block' : 'none';

        // Load weekly status if enabled
        if (autoTradingEnabled) {
            fetchWeeklyStatus();
        }
    }

    // Fetch auto-trading settings
    async function fetchAutoTradingSettings() {
        try {
            const response = await fetch('/api/auto-trading/settings');
            const data = await response.json();

            if (data.success && data.settings) {
                const settings = data.settings;

                // Populate form
                document.getElementById('auto-trading-enabled').checked = settings.is_enabled || false;
                document.getElementById('max-amount-per-week').value = settings.max_amount_per_week || 10000;
                document.getElementById('max-buys-per-week').value = settings.max_buys_per_week || 5;
                document.getElementById('auto-stop-loss').checked = settings.auto_stop_loss_enabled !== false;
                document.getElementById('auto-target-price').checked = settings.auto_target_price_enabled !== false;
                document.getElementById('execution-time').value = settings.execution_time || '09:20';

                // Toggle config visibility
                toggleAutoTradingConfig();
            }
        } catch (error) {
            console.error('Error fetching auto-trading settings:', error);
        }
    }

    // Save auto-trading settings
    async function saveAutoTradingSettings() {
        const saveButton = document.getElementById('save-auto-trading-settings');
        const originalText = saveButton.innerHTML;

        saveButton.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving...';
        saveButton.disabled = true;

        try {
            // Collect settings
            const settings = {
                is_enabled: document.getElementById('auto-trading-enabled').checked,
                max_amount_per_week: parseFloat(document.getElementById('max-amount-per-week').value),
                max_buys_per_week: parseInt(document.getElementById('max-buys-per-week').value),
                auto_stop_loss_enabled: document.getElementById('auto-stop-loss').checked,
                auto_target_price_enabled: document.getElementById('auto-target-price').checked,
                execution_time: document.getElementById('execution-time').value
            };

            const response = await fetch('/api/auto-trading/settings', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(settings)
            });

            const data = await response.json();

            if (data.success) {
                showNotification('Auto-trading settings saved successfully!', 'success');
                // Refresh weekly status
                if (settings.is_enabled) {
                    fetchWeeklyStatus();
                }
            } else {
                showNotification('Failed to save settings: ' + (data.error || 'Unknown error'), 'error');
            }
        } catch (error) {
            console.error('Error saving auto-trading settings:', error);
            showNotification('Error saving settings: ' + error.message, 'error');
        } finally {
            saveButton.innerHTML = originalText;
            saveButton.disabled = false;
        }
    }

    // Fetch weekly status
    async function fetchWeeklyStatus() {
        const statusContent = document.getElementById('weekly-status-content');

        statusContent.innerHTML = `
            <div class="text-center py-3">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted small">Loading weekly status...</p>
            </div>
        `;

        try {
            const response = await fetch('/api/auto-trading/weekly-status');
            const data = await response.json();

            if (data.success) {
                const amountUsedPct = data.percentage_used.amount || 0;
                const buysUsedPct = data.percentage_used.buys || 0;

                statusContent.innerHTML = `
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card border-primary">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Amount Used</h6>
                                    <h4 class="card-title mb-2">₹${data.spent.amount.toLocaleString('en-IN')}</h4>
                                    <div class="progress mb-2" style="height: 8px;">
                                        <div class="progress-bar ${amountUsedPct >= 90 ? 'bg-danger' : amountUsedPct >= 70 ? 'bg-warning' : 'bg-success'}"
                                             role="progressbar" style="width: ${amountUsedPct}%"></div>
                                    </div>
                                    <small class="text-muted">
                                        ${amountUsedPct.toFixed(1)}% of ₹${data.limits.max_amount.toLocaleString('en-IN')}
                                        <br>Remaining: ₹${data.remaining.amount.toLocaleString('en-IN')}
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-info">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Trades Made</h6>
                                    <h4 class="card-title mb-2">${data.spent.buys} / ${data.limits.max_buys}</h4>
                                    <div class="progress mb-2" style="height: 8px;">
                                        <div class="progress-bar ${buysUsedPct >= 90 ? 'bg-danger' : buysUsedPct >= 70 ? 'bg-warning' : 'bg-info'}"
                                             role="progressbar" style="width: ${buysUsedPct}%"></div>
                                    </div>
                                    <small class="text-muted">
                                        ${buysUsedPct.toFixed(1)}% of weekly limit
                                        <br>Remaining: ${data.remaining.buys} trades
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-light mt-3 mb-0">
                        <i class="bi bi-calendar-check me-2"></i>
                        <small>
                            Week: ${new Date(data.week_start).toLocaleDateString()} - ${new Date(data.week_end).toLocaleDateString()}
                        </small>
                    </div>
                `;
            } else {
                statusContent.innerHTML = `
                    <div class="alert alert-warning mb-0">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        ${data.error || 'Failed to load weekly status'}
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error fetching weekly status:', error);
            statusContent.innerHTML = `
                <div class="alert alert-danger mb-0">
                    <i class="bi bi-x-circle me-2"></i>
                    Error loading weekly status: ${error.message}
                </div>
            `;
        }
    }

    // Test auto-trading execution
    async function testAutoTrading() {
        const testButton = document.getElementById('test-auto-trading');
        const originalText = testButton.innerHTML;

        if (!confirm('This will trigger auto-trading execution immediately. All limits and checks will be applied. Continue?')) {
            return;
        }

        testButton.innerHTML = '<i class="bi bi-hourglass-split"></i> Executing...';
        testButton.disabled = true;

        try {
            const response = await fetch('/api/auto-trading/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (data.success) {
                let message = `Auto-trading execution completed!\n\n`;
                message += `Status: ${data.status}\n`;
                message += `Orders Created: ${data.orders_created || 0}\n`;
                message += `Total Invested: ₹${(data.total_amount_invested || 0).toLocaleString('en-IN')}`;

                if (data.message) {
                    message += `\n\nMessage: ${data.message}`;
                }

                showNotification(message, 'success');

                // Refresh weekly status
                fetchWeeklyStatus();
            } else {
                showNotification('Auto-trading execution failed: ' + (data.error || data.message || 'Unknown error'), 'error');
            }
        } catch (error) {
            console.error('Error testing auto-trading:', error);
            showNotification('Error executing auto-trading: ' + error.message, 'error');
        } finally {
            testButton.innerHTML = originalText;
            testButton.disabled = false;
        }
    }

    // Event listeners for auto-trading
    document.getElementById('auto-trading-enabled').addEventListener('change', toggleAutoTradingConfig);
    document.getElementById('save-auto-trading-settings').addEventListener('click', saveAutoTradingSettings);
    document.getElementById('refresh-weekly-status').addEventListener('click', fetchWeeklyStatus);
    document.getElementById('test-auto-trading').addEventListener('click', testAutoTrading);

    // Fetch data when page loads
    document.addEventListener('DOMContentLoaded', function() {
        fetchSettings();
        fetchBrokerStatus();
        fetchAccountBalance(); // Fetch balance from broker API
        fetchAutoTradingSettings(); // Fetch auto-trading settings
    });
</script>
{% endblock %}