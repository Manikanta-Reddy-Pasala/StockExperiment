            });
            
            const result = await response.json();
            hideLoading();
            
            if (result.success) {
                addActivity('Training', symbol, 'Success', result.message);
                alert('Training completed successfully!');
                document.getElementById('trainForm').reset();
            } else {
                addActivity('Training', symbol, 'Error', result.error);
                alert('Training failed: ' + result.error);
            }
        } catch (error) {
            hideLoading();
            addActivity('Training', symbol, 'Error', error.message);
            alert('Error: ' + error.message);
        }
    });
    
    // Predict Form
    document.getElementById('predictForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const symbol = document.getElementById('predictSymbol').value.toUpperCase();
        
        showLoading('Getting prediction...');
        addActivity('Prediction', symbol, 'In Progress', 'Fetching prediction');
        
        try {
            const response = await fetch(`/api/v1/ml/predict/${symbol}`);
            const result = await response.json();
            hideLoading();
            
            if (result.success) {
                const data = result.data;
                addActivity('Prediction', symbol, 'Success', `Signal: ${data.signal}`);
                
                document.getElementById('predictionData').innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Symbol:</strong> ${data.symbol}</p>
                            <p><strong>Current Price:</strong> $${data.last_close_price.toFixed(2)}</p>
                            <p><strong>Predicted Price:</strong> $${data.final_predicted_price.toFixed(2)}</p>
                            <p><strong>Change:</strong> ${data.predicted_change_percent.toFixed(2)}%</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Signal:</strong> <span class="badge bg-${data.signal === 'BUY' ? 'success' : data.signal === 'SELL' ? 'danger' : 'warning'}">${data.signal}</span></p>
                            <p><strong>RF Prediction:</strong> $${data.rf_predicted_price.toFixed(2)}</p>
                            <p><strong>XGB Prediction:</strong> $${data.xgb_predicted_price.toFixed(2)}</p>
                            <p><strong>LSTM Prediction:</strong> $${data.lstm_predicted_price.toFixed(2)}</p>
                        </div>
                    </div>
                `;
                document.getElementById('predictionResults').style.display = 'block';
            } else {
                addActivity('Prediction', symbol, 'Error', result.error);
                alert('Prediction failed: ' + result.error);
                document.getElementById('predictionResults').style.display = 'none';
            }
        } catch (error) {
            hideLoading();
            addActivity('Prediction', symbol, 'Error', error.message);
            alert('Error: ' + error.message);
        }
    });
    
    // Backtest Form
    document.getElementById('backtestForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const symbolsInput = document.getElementById('backtestSymbols').value;
        const symbols = symbolsInput.split(',').map(s => s.trim().toUpperCase()).filter(s => s);
        
        if (symbols.length === 0) {
            alert('Please enter at least one symbol');
            return;
        }
        
        showLoading('Running backtest...');
        addActivity('Backtest', symbols.join(','), 'In Progress', `Testing ${symbols.length} symbols`);
        
        try {
            const response = await fetch('/api/v1/ml/backtest', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ symbols })
            });
            
            const result = await response.json();
            hideLoading();
            
            if (result.success) {
                addActivity('Backtest', symbols.join(','), 'Success', `${result.results.length} results`);
                
                const summaryHtml = result.results.map(r => `
                    <div class="mb-2">
                        <strong>${r.symbol}:</strong> 
                        ${r.total_return_pct.toFixed(2)}% return
                        ($${r.initial_cash.toFixed(0)} → $${r.final_value.toFixed(0)})
                    </div>
                `).join('');
                
                document.getElementById('backtestSummaryData').innerHTML = summaryHtml;
                document.getElementById('backtestSummary').style.display = 'block';
            } else {
                addActivity('Backtest', symbols.join(','), 'Error', result.error);
                alert('Backtest failed: ' + result.error);
            }
        } catch (error) {
            hideLoading();
            addActivity('Backtest', symbols.join(','), 'Error', error.message);
            alert('Error: ' + error.message);
        }
    });
    
    // Backtest All Button
    document.getElementById('backtestAllBtn').addEventListener('click', async function() {
        showLoading('Running backtest for all models...');
        addActivity('Backtest All', 'ALL', 'In Progress', 'Testing all trained models');
        
        try {
            const response = await fetch('/api/v1/ml/backtest/all', {
                method: 'POST'
            });
            
            const result = await response.json();
            hideLoading();
            
            if (result.success) {
                addActivity('Backtest All', 'ALL', 'Success', `${result.results.length} models tested`);
                
                const summaryHtml = result.results.map(r => `
                    <div class="mb-2">
                        <strong>${r.symbol}:</strong> 
                        ${r.total_return_pct.toFixed(2)}% return
                        ($${r.initial_cash.toFixed(0)} → $${r.final_value.toFixed(0)})
                    </div>
                `).join('');
                
                document.getElementById('backtestSummaryData').innerHTML = summaryHtml;
                document.getElementById('backtestSummary').style.display = 'block';
            } else {
                addActivity('Backtest All', 'ALL', 'Error', result.error);
                alert('Backtest failed: ' + result.error);
            }
        } catch (error) {
            hideLoading();
            addActivity('Backtest All', 'ALL', 'Error', error.message);
            alert('Error: ' + error.message);
        }
    });
});
</script>

<style>
.hover-lift {
    transition: transform 0.2s ease-in-out;
}

.hover-lift:hover {
    transform: translateY(-5px);
}

.animate-fade-in-up {
    animation: fadeInUp 0.6s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.bg-gradient-primary {
    background: linear-gradient(45deg, #007bff, #0056b3);
}

.bg-gradient-success {
    background: linear-gradient(45deg, #28a745, #1e7e34);
}

.bg-gradient-info {
    background: linear-gradient(45deg, #17a2b8, #117a8b);
}

.bg-gradient-warning {
    background: linear-gradient(45deg, #ffc107, #e0a800);
}
</style>
{% endblock %}
